#!/usr/bin/env node
/*!
 * MIT License
 * 
 * Copyright © 2024-today, Andrea Giammarchi, @WebReflection
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software
 * is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */
import e,{existsSync as t,readFileSync as r,writeFileSync as s}from"node:fs";import o from"node:process";import{Buffer as n}from"node:buffer";import i,{join as a,resolve as c,dirname as l}from"node:path";import{fileURLToPath as h}from"node:url";import d,{execFile as f}from"node:child_process";import p,{constants as u}from"node:fs/promises";import m,{homedir as g}from"node:os";import{promisify as _}from"node:util";import{createServer as y}from"node:http";import w from"stream";import v from"zlib";import b from"buffer";import x from"crypto";import E from"events";import S from"https";import k from"http";import T from"net";import O from"tls";import P from"url";import{extname as C}from"path";import{statSync as L,createReadStream as R}from"fs";let N,j;function I(){return void 0===N&&(N=function(){try{return e.statSync("/.dockerenv"),!0}catch{return!1}}()||function(){try{return e.readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}()),N}Promise.withResolvers||(Promise.withResolvers=function(){var e,t,r=new this((function(r,s){e=r,t=s}));return{resolve:e,reject:t,promise:r}});function A(){return void 0===j&&(j=(()=>{try{return e.statSync("/run/.containerenv"),!0}catch{return!1}})()||I()),j}const B=()=>{if("linux"!==o.platform)return!1;if(m.release().toLowerCase().includes("microsoft"))return!A();try{return!!e.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")&&!A()}catch{return!1}};var M=o.env.__IS_WSL_TEST__?B:B();function U(e,t,r){const s=r=>Object.defineProperty(e,t,{value:r,enumerable:!0,writable:!0});return Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get(){const e=r();return s(e),e},set(e){s(e)}}),e}const W=_(f);const $=_(f);async function D(e){return async function(e,{humanReadableOutput:t=!0}={}){if("darwin"!==o.platform)throw new Error("macOS only");const r=t?[]:["-ss"],{stdout:s}=await $("osascript",["-e",e,r]);return s.trim()}(`tell application "Finder" to set app_path to application file id "${e}" as string\ntell application "System Events" to get value of property list item "CFBundleName" of property list file (app_path & ":Contents:Info.plist")`)}const F=_(f),q={AppXq0fevzme2pys62n3e0fbqa7peapykr8v:{name:"Edge",id:"com.microsoft.edge.old"},MSEdgeDHTML:{name:"Edge",id:"com.microsoft.edge"},MSEdgeHTM:{name:"Edge",id:"com.microsoft.edge"},"IE.HTTP":{name:"Internet Explorer",id:"com.microsoft.ie"},FirefoxURL:{name:"Firefox",id:"org.mozilla.firefox"},ChromeHTML:{name:"Chrome",id:"com.google.chrome"},BraveHTML:{name:"Brave",id:"com.brave.Browser"},BraveBHTML:{name:"Brave Beta",id:"com.brave.Browser.beta"},BraveSSHTM:{name:"Brave Nightly",id:"com.brave.Browser.nightly"}};class G extends Error{}const z=_(f);async function V(){if("darwin"===o.platform){const e=await async function(){if("darwin"!==o.platform)throw new Error("macOS only");const{stdout:e}=await W("defaults",["read","com.apple.LaunchServices/com.apple.launchservices.secure","LSHandlers"]),t=/LSHandlerRoleAll = "(?!-)(?<id>[^"]+?)";\s+?LSHandlerURLScheme = (?:http|https);/.exec(e);return t?.groups.id??"com.apple.Safari"}();return{name:await D(e),id:e}}if("linux"===o.platform){const{stdout:e}=await z("xdg-mime",["query","default","x-scheme-handler/http"]),t=e.trim();return{name:t.replace(/.desktop$/,"").replace("-"," ").toLowerCase().replaceAll(/(?:^|\s|-)\S/g,(e=>e.toUpperCase())),id:t}}if("win32"===o.platform)return async function(e=F){const{stdout:t}=await e("reg",["QUERY"," HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\http\\UserChoice","/v","ProgId"]),r=/ProgId\s*REG_SZ\s*(?<id>\S+)/.exec(t);if(!r)throw new G(`Cannot find Windows browser in stdout: ${JSON.stringify(t)}`);const{id:s}=r.groups,o=q[s];if(!o)throw new G(`Unknown browser ID: ${s}`);return o}();throw new Error("Only macOS, Linux, and Windows are supported")}const H=i.dirname(h(import.meta.url)),Y=i.join(H,"xdg-open"),{platform:K,arch:X}=o,J=(()=>{const e="/mnt/";let t;return async function(){if(t)return t;const r="/etc/wsl.conf";let s=!1;try{await p.access(r,u.F_OK),s=!0}catch{}if(!s)return e;const o=await p.readFile(r,{encoding:"utf8"}),n=/(?<!#.*)root\s*=\s*(?<mountPoint>.*)/g.exec(o);return n?(t=n.groups.mountPoint.trim(),t=t.endsWith("/")?t:`${t}/`,t):e}})(),Z=async(e,t)=>{let r;for(const s of e)try{return await t(s)}catch(e){r=e}throw r},Q=async e=>{if(e={wait:!1,background:!1,newInstance:!1,allowNonzeroExitCode:!1,...e},Array.isArray(e.app))return Z(e.app,(t=>Q({...e,app:t})));let t,{name:r,arguments:s=[]}=e.app??{};if(s=[...s],Array.isArray(r))return Z(r,(t=>Q({...e,app:{name:t,arguments:s}})));if("browser"===r||"browserPrivate"===r){const t={"com.google.chrome":"chrome","google-chrome.desktop":"chrome","org.mozilla.firefox":"firefox","firefox.desktop":"firefox","com.microsoft.msedge":"edge","com.microsoft.edge":"edge","microsoft-edge.desktop":"edge"},o={chrome:"--incognito",firefox:"--private-window",edge:"--inPrivate"},n=await V();if(n.id in t){const i=t[n.id];return"browserPrivate"===r&&s.push(o[i]),Q({...e,app:{name:re[i],arguments:s}})}throw new Error(`${n.name} is not supported as a default browser`)}const i=[],a={};if("darwin"===K)t="open",e.wait&&i.push("--wait-apps"),e.background&&i.push("--background"),e.newInstance&&i.push("--new"),r&&i.push("-a",r);else if("win32"===K||M&&!A()&&!r){const c=await J();t=M?`${c}c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe`:`${o.env.SYSTEMROOT||o.env.windir||"C:\\Windows"}\\System32\\WindowsPowerShell\\v1.0\\powershell`,i.push("-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand"),M||(a.windowsVerbatimArguments=!0);const l=["Start"];e.wait&&l.push("-Wait"),r?(l.push(`"\`"${r}\`""`),e.target&&s.push(e.target)):e.target&&l.push(`"${e.target}"`),s.length>0&&(s=s.map((e=>`"\`"${e}\`""`)),l.push("-ArgumentList",s.join(","))),e.target=n.from(l.join(" "),"utf16le").toString("base64")}else{if(r)t=r;else{const e=!H||"/"===H;let r=!1;try{await p.access(Y,u.X_OK),r=!0}catch{}t=o.versions.electron??("android"===K||e||!r)?"xdg-open":Y}s.length>0&&i.push(...s),e.wait||(a.stdio="ignore",a.detached=!0)}"darwin"===K&&s.length>0&&i.push("--args",...s),e.target&&i.push(e.target);const c=d.spawn(t,i,a);return e.wait?new Promise(((t,r)=>{c.once("error",r),c.once("close",(s=>{!e.allowNonzeroExitCode&&s>0?r(new Error(`Exited with code ${s}`)):t(c)}))})):(c.unref(),c)};function ee(e){if("string"==typeof e||Array.isArray(e))return e;const{[X]:t}=e;if(!t)throw new Error(`${X} is not supported`);return t}function te({[K]:e},{wsl:t}){if(t&&M)return ee(t);if(!e)throw new Error(`${K} is not supported`);return ee(e)}const re={};U(re,"chrome",(()=>te({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}}))),U(re,"firefox",(()=>te({darwin:"firefox",win32:"C:\\Program Files\\Mozilla Firefox\\firefox.exe",linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"}))),U(re,"edge",(()=>te({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"}))),U(re,"browser",(()=>"browser")),U(re,"browserPrivate",(()=>"browserPrivate"));const se=e=>/^(?:1|y|ok|yes|true)$/i.test(e),{parse:oe,stringify:ne}=JSON;function ie(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ae={exports:{}};const ce=["nodebuffer","arraybuffer","fragments"],le="undefined"!=typeof Blob;le&&ce.push("blob");var he={BINARY_TYPES:ce,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:le,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:de}=he,fe=Buffer[Symbol.species];function pe(e,t,r,s,o){for(let n=0;n<o;n++)r[s+n]=e[n]^t[3&n]}function ue(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(ae.exports={concat:function(e,t){if(0===e.length)return de;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(t);let s=0;for(let t=0;t<e.length;t++){const o=e[t];r.set(o,s),s+=o.length}return s<t?new fe(r.buffer,r.byteOffset,s):r},mask:pe,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let r;return t instanceof ArrayBuffer?r=new fe(t):ArrayBuffer.isView(t)?r=new fe(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r},unmask:ue},!process.env.WS_NO_BUFFER_UTIL)try{const e=require("bufferutil");ae.exports.mask=function(t,r,s,o,n){n<48?pe(t,r,s,o,n):e.mask(t,r,s,o,n)},ae.exports.unmask=function(t,r){t.length<32?ue(t,r):e.unmask(t,r)}}catch(e){}var me=ae.exports;const ge=Symbol("kDone"),_e=Symbol("kRun");const ye=v,we=me,ve=class{constructor(e){this[ge]=()=>{this.pending--,this[_e]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[_e]()}[_e](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[ge])}}},{kStatusCode:be}=he,xe=Buffer[Symbol.species],Ee=Buffer.from([0,0,255,255]),Se=Symbol("permessage-deflate"),ke=Symbol("total-length"),Te=Symbol("callback"),Oe=Symbol("buffers"),Pe=Symbol("error");let Ce;var Le=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ce){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;Ce=new ve(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Te];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){Ce.add((s=>{this._decompress(e,t,((e,t)=>{s(),r(e,t)}))}))}compress(e,t,r){Ce.add((s=>{this._compress(e,t,((e,t)=>{s(),r(e,t)}))}))}_decompress(e,t,r){const s=this._isServer?"client":"server";if(!this._inflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?ye.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=ye.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[Se]=this,this._inflate[ke]=0,this._inflate[Oe]=[],this._inflate.on("error",je),this._inflate.on("data",Ne)}this._inflate[Te]=r,this._inflate.write(e),t&&this._inflate.write(Ee),this._inflate.flush((()=>{const e=this._inflate[Pe];if(e)return this._inflate.close(),this._inflate=null,void r(e);const o=we.concat(this._inflate[Oe],this._inflate[ke]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[ke]=0,this._inflate[Oe]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),r(null,o)}))}_compress(e,t,r){const s=this._isServer?"server":"client";if(!this._deflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?ye.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=ye.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[ke]=0,this._deflate[Oe]=[],this._deflate.on("data",Re)}this._deflate[Te]=r,this._deflate.write(e),this._deflate.flush(ye.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=we.concat(this._deflate[Oe],this._deflate[ke]);t&&(e=new xe(e.buffer,e.byteOffset,e.length-4)),this._deflate[Te]=null,this._deflate[ke]=0,this._deflate[Oe]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),r(null,e)}))}};function Re(e){this[Oe].push(e),this[ke]+=e.length}function Ne(e){this[ke]+=e.length,this[Se]._maxPayload<1||this[ke]<=this[Se]._maxPayload?this[Oe].push(e):(this[Pe]=new RangeError("Max payload size exceeded"),this[Pe].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[Pe][be]=1009,this.removeListener("data",Ne),this.reset())}function je(e){this[Se]._inflate=null,e[be]=1007,this[Te](e)}var Ie={exports:{}};const{isUtf8:Ae}=b,{hasBlob:Be}=he;function Me(e){const t=e.length;let r=0;for(;r<t;)if(128&e[r])if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}else r++;return!0}if(Ie.exports={isBlob:function(e){return Be&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:Me,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},Ae)Ie.exports.isValidUTF8=function(e){return e.length<24?Me(e):Ae(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const e=require("utf-8-validate");Ie.exports.isValidUTF8=function(t){return t.length<32?Me(t):e(t)}}catch(e){}var Ue=Ie.exports;const{Writable:We}=w,$e=Le,{BINARY_TYPES:De,EMPTY_BUFFER:Fe,kStatusCode:qe,kWebSocket:Ge}=he,{concat:ze,toArrayBuffer:Ve,unmask:He}=me,{isValidStatusCode:Ye,isValidUTF8:Ke}=Ue,Xe=Buffer[Symbol.species];var Je=class extends We{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||De[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[Ge]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new Xe(t.buffer,t.byteOffset+e,t.length-e),new Xe(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],s=t.length-e;e>=r.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),s),this._buffers[0]=new Xe(r.buffer,r.byteOffset+e,r.length-e)),e-=r.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(48&t[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const r=!(64&~t[0]);if(!r||this._extensions[$e.extensionName]){if(this._fin=!(128&~t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=r}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),r=t.readUInt32BE(0);if(r>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=r*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=Fe;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&He(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[$e.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(r)}this.dataMessage(t),0===this._state&&this.startLoop(t)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?ze(r,t):"arraybuffer"===this._binaryType?Ve(ze(r,t)):"blob"===this._binaryType?new Blob(r):r,this._allowSynchronousEvents?(this.emit("message",s,!0),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",s,!0),this._state=0,this.startLoop(e)})))}else{const s=ze(r,t);if(!this._skipUTF8Validation&&!Ke(s)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",s,!1),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",s,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,Fe),this.end();else{const r=e.readUInt16BE(0);if(!Ye(r)){const e=this.createError(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const s=new Xe(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Ke(s)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",r,s),this.end()}this._state=0}}createError(e,t,r,s,o){this._loop=!1,this._errored=!0;const n=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(n,this.createError),n.code=o,n[qe]=s,n}};const{randomFillSync:Ze}=x,Qe=Le,{EMPTY_BUFFER:et,kWebSocket:tt,NOOP:rt}=he,{isBlob:st,isValidStatusCode:ot}=Ue,{mask:nt,toBuffer:it}=me,at=Symbol("kByteLength"),ct=Buffer.alloc(4),lt=8192;let ht,dt=lt;var ft=class e{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=rt,this[tt]=void 0}static frame(e,t){let r,s,o=!1,n=2,i=!1;t.mask&&(r=t.maskBuffer||ct,t.generateMask?t.generateMask(r):(dt===lt&&(void 0===ht&&(ht=Buffer.alloc(lt)),Ze(ht,0,lt),dt=0),r[0]=ht[dt++],r[1]=ht[dt++],r[2]=ht[dt++],r[3]=ht[dt++]),i=!(r[0]|r[1]|r[2]|r[3]),n=6),"string"==typeof e?s=t.mask&&!i||void 0===t[at]?(e=Buffer.from(e)).length:t[at]:(s=e.length,o=t.mask&&t.readOnly&&!i);let a=s;s>=65536?(n+=8,a=127):s>125&&(n+=2,a=126);const c=Buffer.allocUnsafe(o?s+n:n);return c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=a,126===a?c.writeUInt16BE(s,2):127===a&&(c[2]=c[3]=0,c.writeUIntBE(s,4,6)),t.mask?(c[1]|=128,c[n-4]=r[0],c[n-3]=r[1],c[n-2]=r[2],c[n-1]=r[3],i?[c,e]:o?(nt(e,r,c,n,s),[c]):(nt(e,r,e,0,s),[c,e])):[c,e]}close(t,r,s,o){let n;if(void 0===t)n=et;else{if("number"!=typeof t||!ot(t))throw new TypeError("First argument must be a valid error code number");if(void 0!==r&&r.length){const e=Buffer.byteLength(r);if(e>123)throw new RangeError("The message must not be greater than 123 bytes");n=Buffer.allocUnsafe(2+e),n.writeUInt16BE(t,0),"string"==typeof r?n.write(r,2):n.set(r,2)}else n=Buffer.allocUnsafe(2),n.writeUInt16BE(t,0)}const i={[at]:n.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,n,!1,i,o]):this.sendFrame(e.frame(n,i),o)}ping(t,r,s){let o,n;if("string"==typeof t?(o=Buffer.byteLength(t),n=!1):st(t)?(o=t.size,n=!1):(o=(t=it(t)).length,n=it.readOnly),o>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[at]:o,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:9,readOnly:n,rsv1:!1};st(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,i,s]):this.getBlobData(t,!1,i,s):0!==this._state?this.enqueue([this.dispatch,t,!1,i,s]):this.sendFrame(e.frame(t,i),s)}pong(t,r,s){let o,n;if("string"==typeof t?(o=Buffer.byteLength(t),n=!1):st(t)?(o=t.size,n=!1):(o=(t=it(t)).length,n=it.readOnly),o>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[at]:o,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:10,readOnly:n,rsv1:!1};st(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,i,s]):this.getBlobData(t,!1,i,s):0!==this._state?this.enqueue([this.dispatch,t,!1,i,s]):this.sendFrame(e.frame(t,i),s)}send(e,t,r){const s=this._extensions[Qe.extensionName];let o,n,i=t.binary?2:1,a=t.compress;"string"==typeof e?(o=Buffer.byteLength(e),n=!1):st(e)?(o=e.size,n=!1):(o=(e=it(e)).length,n=it.readOnly),this._firstFragment?(this._firstFragment=!1,a&&s&&s.params[s._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=o>=s._threshold),this._compress=a):(a=!1,i=0),t.fin&&(this._firstFragment=!0);const c={[at]:o,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:n,rsv1:a};st(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,c,r]):this.getBlobData(e,this._compress,c,r):0!==this._state?this.enqueue([this.dispatch,e,this._compress,c,r]):this.dispatch(e,this._compress,c,r)}getBlobData(t,r,s,o){this._bufferedBytes+=s[at],this._state=2,t.arrayBuffer().then((t=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void process.nextTick(pt,this,e,o)}this._bufferedBytes-=s[at];const n=it(t);r?this.dispatch(n,r,s,o):(this._state=0,this.sendFrame(e.frame(n,s),o),this.dequeue())})).catch((e=>{process.nextTick(ut,this,e,o)}))}dispatch(t,r,s,o){if(!r)return void this.sendFrame(e.frame(t,s),o);const n=this._extensions[Qe.extensionName];this._bufferedBytes+=s[at],this._state=1,n.compress(t,s.fin,((t,r)=>{if(this._socket.destroyed){pt(this,new Error("The socket was closed while data was being compressed"),o)}else this._bufferedBytes-=s[at],this._state=0,s.readOnly=!1,this.sendFrame(e.frame(r,s),o),this.dequeue()}))}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][at],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][at],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};function pt(e,t,r){"function"==typeof r&&r(t);for(let r=0;r<e._queue.length;r++){const s=e._queue[r],o=s[s.length-1];"function"==typeof o&&o(t)}}function ut(e,t,r){pt(e,t,r),e.onerror(t)}const{kForOnEventAttribute:mt,kListener:gt}=he,_t=Symbol("kCode"),yt=Symbol("kData"),wt=Symbol("kError"),vt=Symbol("kMessage"),bt=Symbol("kReason"),xt=Symbol("kTarget"),Et=Symbol("kType"),St=Symbol("kWasClean");let kt=class{constructor(e){this[xt]=null,this[Et]=e}get target(){return this[xt]}get type(){return this[Et]}};Object.defineProperty(kt.prototype,"target",{enumerable:!0}),Object.defineProperty(kt.prototype,"type",{enumerable:!0});class Tt extends kt{constructor(e,t={}){super(e),this[_t]=void 0===t.code?0:t.code,this[bt]=void 0===t.reason?"":t.reason,this[St]=void 0!==t.wasClean&&t.wasClean}get code(){return this[_t]}get reason(){return this[bt]}get wasClean(){return this[St]}}Object.defineProperty(Tt.prototype,"code",{enumerable:!0}),Object.defineProperty(Tt.prototype,"reason",{enumerable:!0}),Object.defineProperty(Tt.prototype,"wasClean",{enumerable:!0});class Ot extends kt{constructor(e,t={}){super(e),this[wt]=void 0===t.error?null:t.error,this[vt]=void 0===t.message?"":t.message}get error(){return this[wt]}get message(){return this[vt]}}Object.defineProperty(Ot.prototype,"error",{enumerable:!0}),Object.defineProperty(Ot.prototype,"message",{enumerable:!0});class Pt extends kt{constructor(e,t={}){super(e),this[yt]=void 0===t.data?null:t.data}get data(){return this[yt]}}Object.defineProperty(Pt.prototype,"data",{enumerable:!0});const Ct={addEventListener(e,t,r={}){for(const s of this.listeners(e))if(!r[mt]&&s[gt]===t&&!s[mt])return;let s;if("message"===e)s=function(e,r){const s=new Pt("message",{data:r?e:e.toString()});s[xt]=this,Rt(t,this,s)};else if("close"===e)s=function(e,r){const s=new Tt("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});s[xt]=this,Rt(t,this,s)};else if("error"===e)s=function(e){const r=new Ot("error",{error:e,message:e.message});r[xt]=this,Rt(t,this,r)};else{if("open"!==e)return;s=function(){const e=new kt("open");e[xt]=this,Rt(t,this,e)}}s[mt]=!!r[mt],s[gt]=t,r.once?this.once(e,s):this.on(e,s)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[gt]===t&&!r[mt]){this.removeListener(e,r);break}}};var Lt={CloseEvent:Tt,ErrorEvent:Ot,Event:kt,EventTarget:Ct,MessageEvent:Pt};function Rt(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}const{tokenChars:Nt}=Ue;function jt(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var It={format:function(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let r,s,o=Object.create(null),n=!1,i=!1,a=!1,c=-1,l=-1,h=-1,d=0;for(;d<e.length;d++)if(l=e.charCodeAt(d),void 0===r)if(-1===h&&1===Nt[l])-1===c&&(c=d);else if(0===d||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===h&&(h=d);const s=e.slice(c,h);44===l?(jt(t,s,o),o=Object.create(null)):r=s,c=h=-1}}else-1===h&&-1!==c&&(h=d);else if(void 0===s)if(-1===h&&1===Nt[l])-1===c&&(c=d);else if(32===l||9===l)-1===h&&-1!==c&&(h=d);else if(59===l||44===l){if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===h&&(h=d),jt(o,e.slice(c,h),!0),44===l&&(jt(t,r,o),o=Object.create(null),r=void 0),c=h=-1}else{if(61!==l||-1===c||-1!==h)throw new SyntaxError(`Unexpected character at index ${d}`);s=e.slice(c,d),c=h=-1}else if(i){if(1!==Nt[l])throw new SyntaxError(`Unexpected character at index ${d}`);-1===c?c=d:n||(n=!0),i=!1}else if(a)if(1===Nt[l])-1===c&&(c=d);else if(34===l&&-1!==c)a=!1,h=d;else{if(92!==l)throw new SyntaxError(`Unexpected character at index ${d}`);i=!0}else if(34===l&&61===e.charCodeAt(d-1))a=!0;else if(-1===h&&1===Nt[l])-1===c&&(c=d);else if(-1===c||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===h&&(h=d);let i=e.slice(c,h);n&&(i=i.replace(/\\/g,""),n=!1),jt(o,s,i),44===l&&(jt(t,r,o),o=Object.create(null),r=void 0),s=void 0,c=h=-1}}else-1===h&&(h=d);if(-1===c||a||32===l||9===l)throw new SyntaxError("Unexpected end of input");-1===h&&(h=d);const f=e.slice(c,h);return void 0===r?jt(t,f,o):(void 0===s?jt(o,f,!0):jt(o,s,n?f.replace(/\\/g,""):f),jt(t,r,o)),t}};const At=E,Bt=S,Mt=k,Ut=T,Wt=O,{randomBytes:$t,createHash:Dt}=x,{URL:Ft}=P,qt=Le,Gt=Je,zt=ft,{isBlob:Vt}=Ue,{BINARY_TYPES:Ht,EMPTY_BUFFER:Yt,GUID:Kt,kForOnEventAttribute:Xt,kListener:Jt,kStatusCode:Zt,kWebSocket:Qt,NOOP:er}=he,{EventTarget:{addEventListener:tr,removeEventListener:rr}}=Lt,{format:sr,parse:or}=It,{toBuffer:nr}=me,ir=3e4,ar=Symbol("kAborted"),cr=[8,13],lr=["CONNECTING","OPEN","CLOSING","CLOSED"],hr=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;let dr=class e extends At{constructor(t,r,s){super(),this._binaryType=Ht[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Yt,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=e.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==t?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===r?r=[]:Array.isArray(r)||("object"==typeof r&&null!==r?(s=r,r=[]):r=[r]),pr(this,t,r,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Ht.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(t,r,s){const o=new Gt({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),n=new zt(t,this._extensions,s.generateMask);this._receiver=o,this._sender=n,this._socket=t,o[Qt]=this,n[Qt]=this,t[Qt]=this,o.on("conclude",wr),o.on("drain",vr),o.on("error",br),o.on("message",Er),o.on("ping",Sr),o.on("pong",kr),n.onerror=Or,t.setTimeout&&t.setTimeout(0),t.setNoDelay&&t.setNoDelay(),r.length>0&&t.unshift(r),t.on("close",Cr),t.on("data",Lr),t.on("end",Rr),t.on("error",Nr),this._readyState=e.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=e.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[qt.extensionName]&&this._extensions[qt.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=e.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(t,r){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this.readyState!==e.CLOSING?(this._readyState=e.CLOSING,this._sender.close(t,r,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),Pr(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";_r(this,this._req,e)}}pause(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!0,this._socket.pause())}ping(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(s=t,t=r=void 0):"function"==typeof r&&(s=r,r=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===r&&(r=!this._isServer),this._sender.ping(t||Yt,r,s)):yr(this,t,s)}pong(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(s=t,t=r=void 0):"function"==typeof r&&(s=r,r=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===r&&(r=!this._isServer),this._sender.pong(t||Yt,r,s)):yr(this,t,s)}resume(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof r&&(s=r,r={}),"number"==typeof t&&(t=t.toString()),this.readyState!==e.OPEN)return void yr(this,t,s);const o={binary:"string"!=typeof t,mask:!this._isServer,compress:!0,fin:!0,...r};this._extensions[qt.extensionName]||(o.compress=!1),this._sender.send(t||Yt,o,s)}terminate(){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this._socket&&(this._readyState=e.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";_r(this,this._req,e)}}};Object.defineProperty(dr,"CONNECTING",{enumerable:!0,value:lr.indexOf("CONNECTING")}),Object.defineProperty(dr.prototype,"CONNECTING",{enumerable:!0,value:lr.indexOf("CONNECTING")}),Object.defineProperty(dr,"OPEN",{enumerable:!0,value:lr.indexOf("OPEN")}),Object.defineProperty(dr.prototype,"OPEN",{enumerable:!0,value:lr.indexOf("OPEN")}),Object.defineProperty(dr,"CLOSING",{enumerable:!0,value:lr.indexOf("CLOSING")}),Object.defineProperty(dr.prototype,"CLOSING",{enumerable:!0,value:lr.indexOf("CLOSING")}),Object.defineProperty(dr,"CLOSED",{enumerable:!0,value:lr.indexOf("CLOSED")}),Object.defineProperty(dr.prototype,"CLOSED",{enumerable:!0,value:lr.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(dr.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(dr.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[Xt])return t[Jt];return null},set(t){for(const t of this.listeners(e))if(t[Xt]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[Xt]:!0})}})})),dr.prototype.addEventListener=tr,dr.prototype.removeEventListener=rr;var fr=dr;function pr(e,t,r,s){const o={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:cr[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=o.autoPong,!cr.includes(o.protocolVersion))throw new RangeError(`Unsupported protocol version: ${o.protocolVersion} (supported versions: ${cr.join(", ")})`);let n;if(t instanceof Ft)n=t;else try{n=new Ft(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===n.protocol?n.protocol="ws:":"https:"===n.protocol&&(n.protocol="wss:"),e._url=n.href;const i="wss:"===n.protocol,a="ws+unix:"===n.protocol;let c;if("ws:"===n.protocol||i||a?a&&!n.pathname?c="The URL's pathname is empty":n.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',c){const t=new SyntaxError(c);if(0===e._redirects)throw t;return void ur(e,t)}const l=i?443:80,h=$t(16).toString("base64"),d=i?Bt.request:Mt.request,f=new Set;let p,u;if(o.createConnection=o.createConnection||(i?gr:mr),o.defaultPort=o.defaultPort||l,o.port=n.port||l,o.host=n.hostname.startsWith("[")?n.hostname.slice(1,-1):n.hostname,o.headers={...o.headers,"Sec-WebSocket-Version":o.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket"},o.path=n.pathname+n.search,o.timeout=o.handshakeTimeout,o.perMessageDeflate&&(p=new qt(!0!==o.perMessageDeflate?o.perMessageDeflate:{},!1,o.maxPayload),o.headers["Sec-WebSocket-Extensions"]=sr({[qt.extensionName]:p.offer()})),r.length){for(const e of r){if("string"!=typeof e||!hr.test(e)||f.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");f.add(e)}o.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(o.origin&&(o.protocolVersion<13?o.headers["Sec-WebSocket-Origin"]=o.origin:o.headers.Origin=o.origin),(n.username||n.password)&&(o.auth=`${n.username}:${n.password}`),a){const e=o.path.split(":");o.socketPath=e[0],o.path=e[1]}if(o.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=i,e._originalHostOrSocketPath=a?o.socketPath:n.host;const t=s&&s.headers;if(s={...s,headers:{}},t)for(const[e,r]of Object.entries(t))s.headers[e.toLowerCase()]=r}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&o.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&n.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!i)&&(delete o.headers.authorization,delete o.headers.cookie,t||delete o.headers.host,o.auth=void 0)}o.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(o.auth).toString("base64")),u=e._req=d(o),e._redirects&&e.emit("redirect",e.url,u)}else u=e._req=d(o);o.timeout&&u.on("timeout",(()=>{_r(e,u,"Opening handshake has timed out")})),u.on("error",(t=>{null===u||u[ar]||(u=e._req=null,ur(e,t))})),u.on("response",(n=>{const i=n.headers.location,a=n.statusCode;if(i&&o.followRedirects&&a>=300&&a<400){if(++e._redirects>o.maxRedirects)return void _r(e,u,"Maximum redirects exceeded");let n;u.abort();try{n=new Ft(i,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${i}`);return void ur(e,r)}pr(e,n,r,s)}else e.emit("unexpected-response",u,n)||_r(e,u,`Unexpected server response: ${n.statusCode}`)})),u.on("upgrade",((t,r,s)=>{if(e.emit("upgrade",t),e.readyState!==dr.CONNECTING)return;u=e._req=null;const n=t.headers.upgrade;if(void 0===n||"websocket"!==n.toLowerCase())return void _r(e,r,"Invalid Upgrade header");const i=Dt("sha1").update(h+Kt).digest("base64");if(t.headers["sec-websocket-accept"]!==i)return void _r(e,r,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let c;if(void 0!==a?f.size?f.has(a)||(c="Server sent an invalid subprotocol"):c="Server sent a subprotocol but none was requested":f.size&&(c="Server sent no subprotocol"),c)return void _r(e,r,c);a&&(e._protocol=a);const l=t.headers["sec-websocket-extensions"];if(void 0!==l){if(!p){return void _r(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=or(l)}catch(t){return void _r(e,r,"Invalid Sec-WebSocket-Extensions header")}const s=Object.keys(t);if(1!==s.length||s[0]!==qt.extensionName){return void _r(e,r,"Server indicated an extension that was not requested")}try{p.accept(t[qt.extensionName])}catch(t){return void _r(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[qt.extensionName]=p}e.setSocket(r,s,{allowSynchronousEvents:o.allowSynchronousEvents,generateMask:o.generateMask,maxPayload:o.maxPayload,skipUTF8Validation:o.skipUTF8Validation})})),o.finishRequest?o.finishRequest(u,e):u.end()}function ur(e,t){e._readyState=dr.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function mr(e){return e.path=e.socketPath,Ut.connect(e)}function gr(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=Ut.isIP(e.host)?"":e.host),Wt.connect(e)}function _r(e,t,r){e._readyState=dr.CLOSING;const s=new Error(r);Error.captureStackTrace(s,_r),t.setHeader?(t[ar]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(ur,e,s)):(t.destroy(s),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function yr(e,t,r){if(t){const r=Vt(t)?t.size:nr(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${lr[e.readyState]})`);process.nextTick(r,t)}}function wr(e,t){const r=this[Qt];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[Qt]&&(r._socket.removeListener("data",Lr),process.nextTick(Tr,r._socket),1005===e?r.close():r.close(e,t))}function vr(){const e=this[Qt];e.isPaused||e._socket.resume()}function br(e){const t=this[Qt];void 0!==t._socket[Qt]&&(t._socket.removeListener("data",Lr),process.nextTick(Tr,t._socket),t.close(e[Zt])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function xr(){this[Qt].emitClose()}function Er(e,t){this[Qt].emit("message",e,t)}function Sr(e){const t=this[Qt];t._autoPong&&t.pong(e,!this._isServer,er),t.emit("ping",e)}function kr(e){this[Qt].emit("pong",e)}function Tr(e){e.resume()}function Or(e){const t=this[Qt];t.readyState!==dr.CLOSED&&(t.readyState===dr.OPEN&&(t._readyState=dr.CLOSING,Pr(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function Pr(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),ir)}function Cr(){const e=this[Qt];let t;this.removeListener("close",Cr),this.removeListener("data",Lr),this.removeListener("end",Rr),e._readyState=dr.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[Qt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",xr),e._receiver.on("finish",xr))}function Lr(e){this[Qt]._receiver.write(e)||this.pause()}function Rr(){const e=this[Qt];e._readyState=dr.CLOSING,e._receiver.end(),this.end()}function Nr(){const e=this[Qt];this.removeListener("error",Nr),this.on("error",er),e&&(e._readyState=dr.CLOSING,this.destroy())}const{tokenChars:jr}=Ue;var Ir={parse:function(e){const t=new Set;let r=-1,s=-1,o=0;for(;o<e.length;o++){const n=e.charCodeAt(o);if(-1===s&&1===jr[n])-1===r&&(r=o);else if(0===o||32!==n&&9!==n){if(44!==n)throw new SyntaxError(`Unexpected character at index ${o}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${o}`);-1===s&&(s=o);const n=e.slice(r,s);if(t.has(n))throw new SyntaxError(`The "${n}" subprotocol is duplicated`);t.add(n),r=s=-1}}else-1===s&&-1!==r&&(s=o)}if(-1===r||-1!==s)throw new SyntaxError("Unexpected end of input");const n=e.slice(r,o);if(t.has(n))throw new SyntaxError(`The "${n}" subprotocol is duplicated`);return t.add(n),t}};const Ar=E,Br=k,{createHash:Mr}=x,Ur=It,Wr=Le,$r=Ir,Dr=fr,{GUID:Fr,kWebSocket:qr}=he,Gr=/^[+/0-9A-Za-z]{22}==$/;var zr=class extends Ar{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Dr,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=Br.createServer(((e,t)=>{const r=Br.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,s)=>{this.handleUpgrade(t,r,s,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(Vr,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(Vr,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{Vr(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,s){t.on("error",Hr);const o=e.headers["sec-websocket-key"],n=e.headers.upgrade,i=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void Kr(this,e,t,405,"Invalid HTTP method")}if(void 0===n||"websocket"!==n.toLowerCase()){return void Kr(this,e,t,400,"Invalid Upgrade header")}if(void 0===o||!Gr.test(o)){return void Kr(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(8!==i&&13!==i){return void Kr(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header")}if(!this.shouldHandle(e))return void Yr(t,400);const a=e.headers["sec-websocket-protocol"];let c=new Set;if(void 0!==a)try{c=$r.parse(a)}catch(r){return void Kr(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const l=e.headers["sec-websocket-extensions"],h={};if(this.options.perMessageDeflate&&void 0!==l){const r=new Wr(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=Ur.parse(l);e[Wr.extensionName]&&(r.accept(e[Wr.extensionName]),h[Wr.extensionName]=r)}catch(r){return void Kr(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const n={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(n,((n,i,a,l)=>{if(!n)return Yr(t,i||401,a,l);this.completeUpgrade(h,o,c,e,t,r,s)}));if(!this.options.verifyClient(n))return Yr(t,401)}this.completeUpgrade(h,o,c,e,t,r,s)}completeUpgrade(e,t,r,s,o,n,i){if(!o.readable||!o.writable)return o.destroy();if(o[qr])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Yr(o,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Mr("sha1").update(t+Fr).digest("base64")}`],c=new this.options.WebSocket(null,void 0,this.options);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,s):r.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),c._protocol=e)}if(e[Wr.extensionName]){const t=e[Wr.extensionName].params,r=Ur.format({[Wr.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${r}`),c._extensions=e}this.emit("headers",a,s),o.write(a.concat("\r\n").join("\r\n")),o.removeListener("error",Hr),c.setSocket(o,n,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(c),c.on("close",(()=>{this.clients.delete(c),this._shouldEmitClose&&!this.clients.size&&process.nextTick(Vr,this)}))),i(c,s)}};function Vr(e){e._state=2,e.emit("close")}function Hr(){this.destroy()}function Yr(e,t,r,s){r=r||Br.STATUS_CODES[t],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...s},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${Br.STATUS_CODES[t]}\r\n`+Object.keys(s).map((e=>`${e}: ${s[e]}`)).join("\r\n")+"\r\n\r\n"+r)}function Kr(e,t,r,s,o){if(e.listenerCount("wsClientError")){const s=new Error(o);Error.captureStackTrace(s,Kr),e.emit("wsClientError",s,r,t)}else Yr(r,s,o)}var Xr=ie(zr);const Jr="application",Zr="audio",Qr="font",es="image",ts="message",rs="model",ss="text",os="video",ns={[Jr]:["andrew-inset","atom+xml","atomcat+xml","atomdeleted+xml","atomsvc+xml","atsc-dwd+xml","atsc-held+xml","atsc-rsat+xml","automationml-aml+xml","automationml-amlx+zip","calendar+xml","ccxml+xml","cdfx+xml","cdmi-capability","cdmi-container","cdmi-domain","cdmi-object","cdmi-queue","cpl+xml","cwl","dash+xml","dash-patch+xml","davmount+xml","dssc+der","dssc+xml","emma+xml","emotionml+xml","epub+zip","exi","express","fdf","fdt+xml","font-tdpfr","geo+json","gml+xml","gzip","hyperstudio","inkml+xml","ipfix","its+xml","java-archive","json","ld+json","lgr+xml","lost+xml","mac-binhex40","mads+xml","manifest+json","marc","marcxml+xml","mathematica","mathml+xml","mbox","media-policy-dataset+xml","mediaservercontrol+xml","metalink4+xml","mets+xml","mmt-aei+xml","mmt-usd+xml","mods+xml","mp21","mp4","msword","mxf","n-quads","n-triples","node","octet-stream","oda","oebps-package+xml","ogg","oxps","p2p-overlay+xml","patch-ops-error+xml","pdf","pgp-encrypted","pgp-keys","pgp-signature","pkcs10","pkcs7-mime","pkcs7-signature","pkcs8","pkix-attr-cert","pkix-cert","pkix-crl","pkix-pkipath","pkixcmp","pls+xml","postscript","provenance+xml","prs.cww","prs.xsf+xml","pskc+xml","rdf+xml","reginfo+xml","relax-ng-compact-syntax","resource-lists+xml","resource-lists-diff+xml","rls-services+xml","route-apd+xml","route-s-tsid+xml","route-usd+xml","rpki-ghostbusters","rpki-manifest","rpki-roa","rtf","sbml+xml","scvp-cv-request","scvp-cv-response","scvp-vp-request","scvp-vp-response","sdp","senml+xml","sensml+xml","set-payment-initiation","set-registration-initiation","shf+xml","sieve","smil+xml","sparql-query","sparql-results+xml","sql","srgs","srgs+xml","sru+xml","ssml+xml","swid+xml","tei+xml","thraud+xml","timestamped-data","trig","ttml+xml","urc-ressheet+xml","urc-targetdesc+xml","voicexml+xml","wasm","watcherinfo+xml","widget","wsdl+xml","wspolicy+xml","x-x509-ca-cert","xcap-att+xml","xcap-caps+xml","xcap-diff+xml","xcap-el+xml","xcap-ns+xml","xenc+xml","xfdf","xhtml+xml","xliff+xml","xml","xml-dtd","xop+xml","xslt+xml","xv+xml","yang","yin+xml","zip"],[Zr]:["3gpp","aac","amr","basic","mobile-xmf","mp4","mpeg","ogg"],[Qr]:["collection","otf","ttf","woff","woff2"],[es]:["aces","apng","avci","avcs","avif","bmp","cgm","dicom-rle","dpx","emf","fits","g3fax","gif","heic","heic-sequence","heif","heif-sequence","hej2k","hsj2","ief","jls","jp2","jpeg","jph","jphc","jpm","jpx","jxl","jxr","jxra","jxrs","jxs","jxsc","jxsi","jxss","ktx","ktx2","png","prs.btif","prs.pti","svg+xml","t38","tiff","tiff-fx","webp","wmf"],[ts]:["disposition-notification","global","global-delivery-status","global-disposition-notification","global-headers","rfc822"],[rs]:["3mf","gltf+json","gltf-binary","iges","jt","mesh","mtl","obj","prc","step+xml","step+zip","step-xml+zip","stl","u3d","vrml","x3d+fastinfoset","x3d+xml","x3d-vrml"],[ss]:["cache-manifest","calendar","css","csv","html","javascript","markdown","n3","plain","prs.lines.tag","richtext","rtf","sgml","shex","spdx","tab-separated-values","troff","turtle","uri-list","vcard","vtt","wgsl","xml"],[os]:["3gpp","3gpp2","h261","h263","h264","iso.segment","jpeg","mj2","mp2t","mp4","mpeg","ogg","quicktime"]},is=e=>e.startsWith(".")?e.slice(1):e;var as=new Proxy({ez:[Jr,0],atom:[Jr,1],atomcat:[Jr,2],atomdeleted:[Jr,3],atomsvc:[Jr,4],dwd:[Jr,5],held:[Jr,6],rsat:[Jr,7],aml:[Jr,8],amlx:[Jr,9],xcs:[Jr,10],ccxml:[Jr,11],cdfx:[Jr,12],cdmia:[Jr,13],cdmic:[Jr,14],cdmid:[Jr,15],cdmio:[Jr,16],cdmiq:[Jr,17],cpl:[Jr,18],cwl:[Jr,19],mpd:[Jr,20],mpp:[Jr,21],davmount:[Jr,22],dssc:[Jr,23],xdssc:[Jr,24],emma:[Jr,25],emotionml:[Jr,26],epub:[Jr,27],exi:[Jr,28],exp:[Jr,29],fdf:[Jr,30],fdt:[Jr,31],pfr:[Jr,32],geojson:[Jr,33],gml:[Jr,34],gz:[Jr,35],stk:[Jr,36],ink:[Jr,37],inkml:[Jr,37],ipfix:[Jr,38],its:[Jr,39],jar:[Jr,40],war:[Jr,40],ear:[Jr,40],json:[Jr,41],map:[Jr,41],jsonld:[Jr,42],lgr:[Jr,43],lostxml:[Jr,44],hqx:[Jr,45],mads:[Jr,46],webmanifest:[Jr,47],mrc:[Jr,48],mrcx:[Jr,49],ma:[Jr,50],nb:[Jr,50],mb:[Jr,50],mathml:[Jr,51],mbox:[Jr,52],mpf:[Jr,53],mscml:[Jr,54],meta4:[Jr,55],mets:[Jr,56],maei:[Jr,57],musd:[Jr,58],mods:[Jr,59],m21:[Jr,60],mp21:[Jr,60],mp4:[Jr,61],mpg4:[Jr,61],mp4s:[Jr,61],m4p:[Jr,61],doc:[Jr,62],dot:[Jr,62],mxf:[Jr,63],nq:[Jr,64],nt:[Jr,65],cjs:[Jr,66],bin:[Jr,67],dms:[Jr,67],lrf:[Jr,67],mar:[Jr,67],so:[Jr,67],dist:[Jr,67],distz:[Jr,67],pkg:[Jr,67],bpk:[Jr,67],dump:[Jr,67],elc:[Jr,67],deploy:[Jr,67],exe:[Jr,67],dll:[Jr,67],deb:[Jr,67],dmg:[Jr,67],iso:[Jr,67],img:[Jr,67],msi:[Jr,67],msp:[Jr,67],msm:[Jr,67],buffer:[Jr,67],oda:[Jr,68],opf:[Jr,69],ogx:[Jr,70],oxps:[Jr,71],relo:[Jr,72],xer:[Jr,73],pdf:[Jr,74],pgp:[Jr,75],asc:[Jr,76],sig:[Jr,77],p10:[Jr,78],p7m:[Jr,79],p7c:[Jr,79],p7s:[Jr,80],p8:[Jr,81],ac:[Jr,82],cer:[Jr,83],crl:[Jr,84],pkipath:[Jr,85],pki:[Jr,86],pls:[Jr,87],ai:[Jr,88],eps:[Jr,88],ps:[Jr,88],provx:[Jr,89],cww:[Jr,90],xsf:[Jr,91],pskcxml:[Jr,92],rdf:[Jr,93],owl:[Jr,93],rif:[Jr,94],rnc:[Jr,95],rl:[Jr,96],rld:[Jr,97],rs:[Jr,98],rapd:[Jr,99],sls:[Jr,100],rusd:[Jr,101],gbr:[Jr,102],mft:[Jr,103],roa:[Jr,104],rtf:[Jr,105],sbml:[Jr,106],scq:[Jr,107],scs:[Jr,108],spq:[Jr,109],spp:[Jr,110],sdp:[Jr,111],senmlx:[Jr,112],sensmlx:[Jr,113],setpay:[Jr,114],setreg:[Jr,115],shf:[Jr,116],siv:[Jr,117],sieve:[Jr,117],smi:[Jr,118],smil:[Jr,118],rq:[Jr,119],srx:[Jr,120],sql:[Jr,121],gram:[Jr,122],grxml:[Jr,123],sru:[Jr,124],ssml:[Jr,125],swidtag:[Jr,126],tei:[Jr,127],teicorpus:[Jr,127],tfi:[Jr,128],tsd:[Jr,129],trig:[Jr,130],ttml:[Jr,131],rsheet:[Jr,132],td:[Jr,133],vxml:[Jr,134],wasm:[Jr,135],wif:[Jr,136],wgt:[Jr,137],wsdl:[Jr,138],wspolicy:[Jr,139],der:[Jr,140],crt:[Jr,140],pem:[Jr,140],xav:[Jr,141],xca:[Jr,142],xdf:[Jr,143],xel:[Jr,144],xns:[Jr,145],xenc:[Jr,146],xfdf:[Jr,147],xhtml:[Jr,148],xht:[Jr,148],xlf:[Jr,149],xml:[Jr,150],xsl:[Jr,150],xsd:[Jr,150],rng:[Jr,150],dtd:[Jr,151],xop:[Jr,152],xslt:[Jr,153],mxml:[Jr,154],xhvml:[Jr,154],xvml:[Jr,154],xvm:[Jr,154],yang:[Jr,155],yin:[Jr,156],zip:[Jr,157],"3gpp":[Zr,0],adts:[Zr,1],aac:[Zr,1],amr:[Zr,2],au:[Zr,3],snd:[Zr,3],mxmf:[Zr,4],m4a:[Zr,5],mp4a:[Zr,5],mpga:[Zr,6],mp2:[Zr,6],mp2a:[Zr,6],mp3:[Zr,6],m2a:[Zr,6],m3a:[Zr,6],oga:[Zr,7],ogg:[Zr,7],spx:[Zr,7],opus:[Zr,7],ttc:[Qr,0],otf:[Qr,1],ttf:[Qr,2],woff:[Qr,3],woff2:[Qr,4],exr:[es,0],apng:[es,1],avci:[es,2],avcs:[es,3],avif:[es,4],bmp:[es,5],dib:[es,5],cgm:[es,6],drle:[es,7],dpx:[es,8],emf:[es,9],fits:[es,10],g3:[es,11],gif:[es,12],heic:[es,13],heics:[es,14],heif:[es,15],heifs:[es,16],hej2:[es,17],hsj2:[es,18],ief:[es,19],jls:[es,20],jp2:[es,21],jpg2:[es,21],jpeg:[es,22],jpg:[es,22],jpe:[es,22],jph:[es,23],jhc:[es,24],jpm:[es,25],jpgm:[es,25],jpx:[es,26],jpf:[es,26],jxl:[es,27],jxr:[es,28],jxra:[es,29],jxrs:[es,30],jxs:[es,31],jxsc:[es,32],jxsi:[es,33],jxss:[es,34],ktx:[es,35],ktx2:[es,36],png:[es,37],btif:[es,38],btf:[es,38],pti:[es,39],svg:[es,40],svgz:[es,40],t38:[es,41],tif:[es,42],tiff:[es,42],tfx:[es,43],webp:[es,44],wmf:[es,45],"disposition-notification":[ts,0],u8msg:[ts,1],u8dsn:[ts,2],u8mdn:[ts,3],u8hdr:[ts,4],eml:[ts,5],mime:[ts,5],"3mf":[rs,0],gltf:[rs,1],glb:[rs,2],igs:[rs,3],iges:[rs,3],jt:[rs,4],msh:[rs,5],mesh:[rs,5],silo:[rs,5],mtl:[rs,6],obj:[rs,7],prc:[rs,8],stpx:[rs,9],stpz:[rs,10],stpxz:[rs,11],stl:[rs,12],u3d:[rs,13],wrl:[rs,14],vrml:[rs,14],x3db:[rs,15],x3d:[rs,16],x3dz:[rs,16],x3dv:[rs,17],appcache:[ss,0],manifest:[ss,0],ics:[ss,1],ifb:[ss,1],css:[ss,2],csv:[ss,3],html:[ss,4],htm:[ss,4],shtml:[ss,4],js:[ss,5],mjs:[ss,5],md:[ss,6],markdown:[ss,6],n3:[ss,7],txt:[ss,8],text:[ss,8],conf:[ss,8],def:[ss,8],list:[ss,8],log:[ss,8],in:[ss,8],ini:[ss,8],dsc:[ss,9],rtx:[ss,10],sgml:[ss,12],sgm:[ss,12],shex:[ss,13],spdx:[ss,14],tsv:[ss,15],t:[ss,16],tr:[ss,16],roff:[ss,16],man:[ss,16],me:[ss,16],ms:[ss,16],ttl:[ss,17],uri:[ss,18],uris:[ss,18],urls:[ss,18],vcard:[ss,19],vtt:[ss,20],wgsl:[ss,21],"3gp":[os,0],"3g2":[os,1],h261:[os,2],h263:[os,3],h264:[os,4],m4s:[os,5],jpgv:[os,6],mj2:[os,7],mjp2:[os,7],ts:[os,8],m2t:[os,8],m2ts:[os,8],mts:[os,8],mp4v:[os,9],mpeg:[os,10],mpg:[os,10],mpe:[os,10],m1v:[os,10],m2v:[os,10],ogv:[os,11],qt:[os,12],mov:[os,12]},{has:(e,t)=>e.hasOwnProperty(is(t)),get:(e,t)=>{const r=e[is(t)];return r&&`${r[0]}/${ns[r[0]][r[1]]}`}});const{min:cs}=Math,ls=/^bytes=(\d+)-(\d*)/;const hs="apply",ds="ownKeys",fs="destruct";var ps=!1;const{ArrayBuffer:us,Atomics:ms,Promise:gs}=globalThis,{isArray:_s}=Array,{create:ys,getPrototypeOf:ws,values:vs}=Object,bs=ws(Int32Array);ys(ms);const xs="array",Es="function",Ss="null",ks="number",Ts="object",Os="string",Ps="symbol",Cs="undefined";let Ls=0;const Rs=new Map,Ns=new Map,js=e=>Ns.get(e),Is=e=>{if(!Rs.has(e)){let t;for(;Ns.has(t=Ls++););Rs.set(e,t),Ns.set(t,e)}return Rs.get(e)};var As=Object.fromEntries([xs,"bigint","boolean",Es,Ss,ks,Ts,Os,Ps,Cs].map(((e,t)=>[e,t])));const{[ds]:Bs}=Reflect,Ms=new Map(Bs(Symbol).filter((e=>typeof Symbol[e]===Ps)).map((e=>[Symbol[e],e]))),Us=e=>Ms.get(e)||`.${Symbol.keyFor(e)||""}`,Ws=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(`%c${String(t)}`,"font-weight:bold","collected"),e(t)})),$s=Object.create(null),{addEventListener:Ds}=EventTarget.prototype,Fs=new WeakMap;Reflect.defineProperty(EventTarget.prototype,"addEventListener",{value(e,t,...r){const s=r.at(0)?.invoke;if(s){let t=Fs.get(this);t||(t=new Map,Fs.set(this,t)),t.set(e,[].concat(s)),delete r[0].invoke}return Ds.call(this,e,t,...r)}});const{isArray:qs}=Array,Gs=e=>{const t=typeof e;switch(t){case Ts:return null===e?[As[Ss],e]:e===globalThis?[As[Ts],null]:qs(e)?[As[xs],Is(e)]:[As[Ts],e instanceof bs?e:Is(e)];case Es:return[As[Es],Is(e)];case Ps:return[As[Ps],Us(e)];default:return[As[t],e]}};var zs=(e,t)=>{const r=new Map,s=e=>{r.delete(e),t(fs,e)},o=([e,n])=>{switch(e){case As[Ts]:if(null===n)return globalThis;if(typeof n===ks)return js(n);if(!(n instanceof bs))for(const e in n)n[e]=o(n[e]);return n;case As[xs]:return typeof n===ks?js(n):n.map(o);case As[Es]:switch(typeof n){case ks:return js(n);case Os:{let e=r.get(n)?.deref();return e||(e=((e,t,{debug:r,handler:s,return:o,token:n=e}=$s)=>{const i=o||new Proxy(e,s||$s),a=[i,[t,e,!!r]];return!1!==n&&a.push(n),Ws.register(...a),i})(n,s,{token:!1,return:function(...e){return e.length&&e[0]instanceof Event&&(e=>{const{currentTarget:t,target:r,type:s}=e,o=Fs.get(t||r)?.get(s);if(o)for(const t of o)e[t]()})(e[0]),t(hs,n,Gs(this),e.map(Gs)).then(o)}}),r.set(n,new WeakRef(e))),e}}case As[Ps]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of Ms)if(r===e)return t})(n);default:return n}},n=t=>import(e(t));return(e,t,...r)=>{if(e===fs)(e=>{const[t,r]=typeof e===ks?[Ns,Rs]:[Rs,Ns],s=t.has(e);s&&(r.delete(t.get(e)),t.delete(e))})(t);else{const s=Reflect[e],i=null==t?globalThis:js(t);switch(e){case"defineProperty":{const[e,t]=r.map(o);return Gs(s(i,e,t))}case"getOwnPropertyDescriptor":{const e=s(i,...r.map(o));if(e){const{get:t,set:r,value:s}=e;t&&(e.get=Gs(t)),r&&(e.set=Gs(r)),s&&(e.value=Gs(s))}return[As[e?Ts:Cs],e]}case ds:return[As[xs],s(i).map(Gs)];case"get":if(null==t&&"import"===r[0][1])return Gs(n);default:return((e,t,r)=>Gs(e(t,...r.map(o))))(s,i,r)}}}};const{parse:Vs,stringify:Hs}=JSON,Ys={data:null,stopImmediatePropagation(){},preventDefault(){}};var Ks=(e,t)=>{const{parse:r=Vs,stringify:s=Hs}=t,o=new Map;let[n,i,a,c]=["",!0,0,null];return{onclose:()=>{for(const[e,t]of o)t();o.clear(),[n,i,a,c]=["",!0,0,null]},onmessage:async l=>{try{const h=r(String(l));if(Ys.data=h,((e,t)=>{const{data:r}=e,s=_s(r)&&(r.at(0)===t||0===r.at(1)&&!t);return s&&(e.stopImmediatePropagation(),e.preventDefault()),s})(Ys,n))if(i)i=!1,[n]=h,c=zs(t?.import||String,((t,r,...i)=>{let c,l;return t===hs&&(({promise:c,resolve:l}=gs.withResolvers()),o.set(a,l),i.push(a++)),e.send(s([n,null,[t,r,...i]])),c})),e.send("");else{const[t,r,i,a,...l]=h;if(null==r)o.get(a)(...l),o.delete(a);else{let t;try{ps,t=await c(i,a,...l)}catch(e){t=e}e.send(s([n,r,t]))}}}catch(e){}}}};const[...Xs]=process.argv.slice(2),Js={_:"",get $(){return this._||(this._=process.cwd())}},Zs=Xs.at(0)||a(Js.$,"package.json");if("--help"===Zs||!t(Zs)){const e=+("--help"!==Zs);e&&console.error("[1mUnable to parse package.json[0m\n"),console[e?"error":"log"]("\nworkerful [options]\n\n[options]\n--help        # this message\npackage.json  # the package.json file at the root\n              # of your workerful project\n  ".trim()),process.exit(e)}const Qs=oe(r(Zs).toString("utf-8"));const eo=Qs.workerful||(Qs.workerful={ip:"localhost",port:0,centered:!0,kiosk:!1,window:{}}),{WORKERFUL_CENTERED:to=!!eo.centered,WORKERFUL_IP:ro=eo.ip||"localhost",WORKERFUL_PORT:so=eo.port||0,WORKERFUL_KIOSK:oo=eo.kiosk||!1}=process.env,no=crypto.randomUUID();let io,ao=Promise.resolve();const co=await(async e=>{const t=Qs.workerful?.server,r=!!t,s=t?(await import(c(Js.$,t))).default:((e,t={})=>function r({method:s,url:o,headers:{range:n}={}},i){if("GET"!==s)return!1;const a=o.indexOf("?");-1<a&&(o=o.slice(0,a)),o.endsWith("/")&&(o+="index.html");const c=L(e+o,{throwIfNoEntry:!1});if(!c)return!1;if(c.isFile()){const{size:r}=c;let s=0;try{if(ls.test(n||"")){const{$1:n,$2:a}=RegExp,c=parseInt(n,10)||0;if(c>=r)throw s=416;let l=parseInt(a,10)||0;(!l||l>=r)&&(l=cs(r,c+1048576)-1),i.writeHead(s=206,{...t,"Accept-Range":"bytes","Content-Range":`bytes ${c}-${l}/${r}`,"Content-Length":l+1-c,"Content-Type":as[C(o)]}),R(e+o,{start:c,end:l}).pipe(i)}else i.writeHead(s=200,{...t,"Content-Length":r,"Content-Type":as[C(o)]}),R(e+o).pipe(i);return!0}catch(e){return!1}}return!!c.isDirectory()&&r({method:"GET",url:o+"/"},i)})(a(l(Zs),"public")),o=y(((t,o)=>{e(t,o)||!s(t,o)&&r&&(t.writeHead(404),o.end())}));return((e={})=>{const{bun:t,wss:r}=e;if(t){const t=new WeakMap;return{open(r){t.set(r,Ks(r,e))},close(e,r,s){t.get(e).onclose(s)},message(e,r){t.get(e).onmessage(r)}}}r&&r.on("connection",(t=>{const{onclose:r,onmessage:s}=Ks(t,e);t.prependListener("close",r),t.prependListener("message",s)}))})({wss:new Xr({server:o})}),o})(((e,t)=>{const{url:r,method:o,headers:n}=e;if("GET"===o){if("/workerful"===r){let e;return e=n.referer.endsWith("/workerful.js")?'const e="1788c3c1-8ba6-4f70-bc8b-350c9901ca4c",t="="+e,r="-"+e,n=t+"-ws",s=r+"-ws",a="apply",o="construct",c="defineProperty",l="deleteProperty",i="get",u="getOwnPropertyDescriptor",f="getPrototypeOf",p="has",y="isExtensible",w="ownKeys",d="preventExtensions",g="set",h="setPrototypeOf";var b=Object.freeze({__proto__:null,APPLY:a,CONSTRUCT:o,DEFINE_PROPERTY:c,DELETE_PROPERTY:l,GET:i,GET_OWN_PROPERTY_DESCRIPTOR:u,GET_PROTOTYPE_OF:f,HAS:p,IS_EXTENSIBLE:y,OWN_KEYS:w,PREVENT_EXTENSION:d,SET:g,SET_PROTOTYPE_OF:h});const v="destruct",{ArrayBuffer:E,Atomics:m,Promise:T}=globalThis,{isArray:P}=Array,{create:O,getPrototypeOf:k,values:x}=Object,S=k(Int32Array),A=O(m),R=({currentTarget:e,type:t,origin:r,lastEventId:n,source:s,ports:a},o)=>e.dispatchEvent(new MessageEvent(t,{data:o,origin:r,lastEventId:n,source:s,ports:a})),_=()=>T.withResolvers();let M=0;const I=new Map,j=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&I.set(this,[M++,0,_()])}},$=new WeakSet,N=e=>($.add(e),e),W=(e,t)=>{const{data:r}=e,n=P(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},Y=e=>null!==e&&"object"==typeof e&&!$.has(e),D=new WeakMap,L=(e,t,r)=>{if(I.has(e))t.set(e,I.get(e)[0]);else if(!(e instanceof S||e instanceof E))for(const n of x(e))Y(n)&&!r.has(n)&&(r.add(n),L(n,t,r))},B=(...e)=>({value:new T((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),C=(e,t)=>{const r=I.get(e),[n,s,{promise:a}]=r;return r[1]=t,[n,a]};let{BigInt64Array:F,Int32Array:U,SharedArrayBuffer:z,addEventListener:H,postMessage:G}=globalThis,K=!0,X=e=>e,q=!1;const J=_();try{new z(4),A.waitAsync||(A.waitAsync=B),J.resolve()}catch(e){const t=G,r=H,n=[];let s="",a="";z=class extends E{},F=j(F,z),U=j(U,z),X=N,q=!0,A.notify=(e,r)=>{const[n]=(e=>D.get(e))(e);return t([s,1,e,n,r]),0},A.waitAsync=(...e)=>{const[t,r]=C(...e);return{value:r}},A.wait=(e,t,...r)=>{const[n]=C(e,t,...r),o=new XMLHttpRequest;o.responseType="json",o.open("POST",`${a}?sabayon`,!1),o.setRequestHeader("Content-Type","application/json"),o.send(`["${s}",${n},${t}]`);const{response:c}=o;I.delete(e);for(let t=0;t<c.length;t++)e[t]=c[t];return"ok"},r("message",(e=>{if(W(e,s)){const[t,r,...n]=e.data;switch(r){case 0:s=t,a=n.at(0)?.serviceWorker||"",a||(A.wait=null,J.resolve());break;case 1:((e,t,r)=>{for(const[n,[s,a,{resolve:o}]]of I)if(t===s&&r===a){for(let t=0;t<e.length;t++)n[t]=e[t];I.delete(n),o("ok");break}})(...n);break;case 2:((e,t,r)=>{for(const[r,n]of t)D.set(r,[n,e.currentTarget]);R(e,r)})(e,...n);break;case 3:J.resolve()}}else if(K){const{currentTarget:t,type:r,origin:s,lastEventId:a,source:o,ports:c}=e;n.push([{currentTarget:t,type:r,origin:s,lastEventId:a,source:o,ports:c},e.data])}})),H=(e,...t)=>{if(r(e,...t),n.length)for(const e of n.splice(0))R(...e)},G=(e,...r)=>t(((e,t)=>{const r=new Map;return Y(t)&&L(t,r,new Set),r.size?[e,2,r,t]:t})(s,e),...r)}await J.promise,K=!1;const{BYTES_PER_ELEMENT:V}=Int32Array,{BYTES_PER_ELEMENT:Q}=Uint16Array,{notify:Z}=A,ee=new TextDecoder("utf-16"),te=new WeakSet,re=(...e)=>(te.add(e),e);let ne="";const se=(e,t,r,n)=>{const[s]=n,a=r.get(s);if(!a)throw new Error(`Unknown proxy.${s}()`);e(a,t,n)};let ae=0;const oe=([e,t,r,n,s,a,o,c,l],i)=>(...u)=>{let f=""!==ne,p=0;f&&"="!==ne[0]&&"-"!==ne[0]&&(p=((e,t)=>setTimeout(console.warn,3e3,`💀🔒 - proxy.${e}() in proxy.${t}()`))(i,ne));const y=ae++,w=[];te.has(u.at(-1)||w)&&te.delete(w=u.pop());const d=r(c?u.map(c):u);let g=t(2*V);return o([e,2,i,y,g,d,n],{transfer:w}),l(g,0).value.then((()=>{f&&clearTimeout(p);const r=g[1];if(!r)return;const n=Q*r;return g=t(n+n%V),o([e,1,y,g]),l(g,0).value.then((()=>{const e=new Uint16Array(g.buffer),t=a?e.subarray(0,r):e.slice(0,r);return s(ee.decode(t))}))}))},ce=(e,t)=>new Proxy(t,{get:(t,r)=>{let n;return"then"!==r&&(n=t.get(r),n||(n=oe(e,r),t.set(r,n))),n},set:(e,t,r)=>"then"!==t&&!!e.set(t,r)}),{wait:le,waitAsync:ie}=A;var ue=({parse:e,stringify:t,transform:r,interrupt:n}=JSON)=>{const s=((e,t)=>async(r,n,[s,a,o,c,l])=>{l&&(ne=s);try{const s=await r(...c);if(void 0!==s){const r=e(t?t(s):s);n.set(a,r),o[1]=r.length}}finally{l&&(ne=""),o[0]=1,Z(o,0)}})(t,r),a=_(),o=new Map,c=new Map;let l="",i=le;if(le&&n){const{handler:e,timeout:t=42}=n;i=(r,n,s)=>{for(;"timed-out"===(s=le(r,n,0,t));)e();return s}}return H("message",(t=>{if(W(t,l)){const[n,u,...f]=t.data;switch(u){case 0:{const t=!!le;l=n,a.resolve({polyfill:q,sync:t,transfer:re,proxy:ce([l,e=>new U(new z(e)),X,t,e,q,G,r,t?(...e)=>({value:{then:t=>t(i(...e))}}):ie],o)});break}case 2:o.size?se(s,c,o,f):setTimeout(se,0,s,c,o,f);break;case 1:((e,[t,r])=>{const n=e.get(t);e.delete(t);for(let e=new Uint16Array(r.buffer),t=0,{length:s}=n;t<s;t++)e[t]=n.charCodeAt(t);Z(r,0)})(c,f)}}})),a.promise};const fe="array",pe="function",ye="null",we="number",de="object",ge="symbol",he="undefined";function be(){return this}const ve=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(`Held value ${String(t)} not relevant anymore`),e(t)})),Ee=Object.create(null),{Object:me,Proxy:Te,Reflect:Pe}=globalThis,{isArray:Oe}=Array,{ownKeys:ke}=Pe,{create:xe,hasOwn:Se,values:Ae}=me,Re=(e,t)=>t===fe?e[0]:t===pe?e():t===de?e.$:e,_e=(e,t,r,n)=>{const s={type:{value:t}},a=Se(e,"valueOf");for(const o of Ae(b)){let c=n(e[o]||Pe[o]);if(a&&o===i){const{valueOf:n}=e,{value:s}=c;c={value(e,a,...o){return a===r?n.call(this,Re(e,t)):s.call(this,e,a,...o)}}}s[o]=c}return xe(e,s)},Me=(e,t,r,n=e)=>{if(n===e)switch(typeof e){case de:case he:n||(n=!1);case pe:break;default:n=!1,t===e&&(t=me(e))}const s=new Te(t,r),{destruct:a}=r;return a?((e,t,{debug:r,handler:n,return:s,token:a=e}=Ee)=>{const o=s||new Proxy(e,n||Ee),c=[o,[t,e,!!r]];return!1!==a&&c.push(a),ve.register(...c),o})(e,a,{token:n,return:s}):s},Ie=e=>t=>{const r=typeof t;return r===de?t?e.get(t)?.[0]??(e=>Oe(e)?fe:de)(t):ye:r},je=e=>t=>{let r=typeof t;switch(r){case de:if(!t){r=ye;break}case pe:const n=e.get(t);n&&([r,t]=n)}return[r,t]},$e=e=>((e=>{ve.unregister(e)})(e),e);var Ne=e=>{const t=new WeakMap,r=Symbol(),n={},s=(e,r,n)=>(t.set(e,[r,n]),e),a={proxy:n,release:$e,pair:je(t),typeOf:Ie(t),isProxy:e=>t.has(e),valueOf:e=>e[r]??e.valueOf()};for(const t of ke(e)){if(Se(a,t))continue;const o=e[t];switch(t){case fe:{const e=_e(o,t,r,(e=>({value([t],...r){return e.call(this,t,...r)}})));n[t]=(t,...r)=>s(Me(t,[t],e,...r),fe,t);break}case pe:{const e=_e(o,t,r,(e=>({value(t,...r){return e.call(this,t(),...r)}})));n[t]=(t,...r)=>{return s(Me(t,(n=t,be.bind(n)),e,...r),pe,t);var n};break}case de:{const e=_e(o,t,r,(e=>({value({$:t},...r){return e.call(this,t,...r)}})));n[t]=(t,...r)=>s(Me(t,{$:t},e,...r),de,t);break}default:{const e=_e(o,t,r,(e=>({value:e})));n[t]=(r,...n)=>s(Me(r,r,e,...n),t,r);break}}}return a};let We=0;const Ye=new Map,De=new Map,Le=e=>De.get(e),Be=e=>{if(!Ye.has(e)){let t;for(;De.has(t=We++););Ye.set(e,t),De.set(t,e)}return Ye.get(e)};var Ce=Object.fromEntries([fe,"bigint","boolean",pe,ye,we,de,"string",ge,he].map(((e,t)=>[e,t])));const{[w]:Fe}=Reflect,Ue=new Map(Fe(Symbol).filter((e=>typeof Symbol[e]===ge)).map((e=>[Symbol[e],e]))),ze=e=>Ue.get(e)||`.${Symbol.keyFor(e)||""}`,{isArray:He}=Array,{[a]:Ge}=Reflect;var Ke=(e,t)=>{const r=new Map,n=(e,t)=>{let n=r.get(e)?.deref();return n||r.set(e,new WeakRef(n=t(e))),n},s=([e,t])=>{switch(e){case Ce[de]:return null==t?globalThis:typeof t===we?n(t,P.object):t;case Ce[fe]:return typeof t===we?n(t,P.array):t;case Ce[pe]:return typeof t===we?n(t,P.function):Le(parseInt(t));case Ce[ge]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of Ue)if(r===e)return t})(t);default:return t}},b=e=>{let[r,n]=k(e);switch(r){case de:if(n==globalThis||null==n)n=null;else if(typeof n===de&&!(n instanceof S))if(n=t(n),He(n))n=n.map(b);else for(const e in n)n[e]=b(n[e]);return[Ce[de],n];case fe:return[Ce[fe],typeof n===we?n:t(n).map(b)];case pe:return[Ce[pe],typeof n===pe?String(Be(t(n))):n];case ge:return[Ce[ge],ze(e)];default:return[Ce[r],n]}},E=(...t)=>s(e(...t)),m={[c]:(e,t,r)=>E(c,e,b(t),b(r)),[l]:(e,t)=>E(l,e,b(t)),[i]:(e,t)=>E(i,e,b(t)),[f]:e=>E(f,e),[u]:(e,t)=>{const r=E(u,e,b(t));if(r){const{get:e,set:t,value:n}=r;e&&(r.get=s(e)),t&&(r.set=s(t)),n&&(r.value=s(n))}return r},[p]:(e,t)=>E(p,e,b(t)),[y]:e=>E(y,e),[w]:e=>E(w,e).map(s),[d]:e=>E(d,e),[g]:(e,t,r)=>E(g,e,b(t),b(r)),[h]:(e,t)=>E(h,e,b(t)),[v](t){r.delete(t),e(v,t)}},T={[de]:m,[fe]:m,[pe]:{...m,[a]:(e,...t)=>E(a,e,...t.map(b)),[o]:(e,...t)=>E(o,e,...t.map(b))}},{proxy:P,isProxy:O,pair:k}=Ne(T);return{isProxy:O,global:P.object(null),method:async(e,t,...r)=>{const n=parseInt(t);switch(e){case a:{const[e,t]=r;return b(await Ge(Le(n),s(e),t.map(s)))}case v:(e=>{const[t,r]=typeof e===we?[De,Ye]:[Ye,De],n=t.has(e);n&&(r.delete(t.get(e)),t.delete(e))})(n)}}}};const{server:Xe,window:qe}=await(async e=>{const a=await(async e=>{const n=await ue(e),{isProxy:s,global:a,method:o}=Ke(n.proxy[t],(e=>e));return n.proxy[r]=o,{...n,window:a,isWindowProxy:s}})(e),{isProxy:o,global:c,method:l}=Ke(a.proxy[n],(e=>e));return a.proxy[s]=l,{...a,server:c,isServerProxy:o}})();export{Xe as server,qe as window};\n':`globalThis.workerful=${ne({ws:io,secret:no,centered:"always"===to||se(to)})};!function(){"use strict";const e="apply",t="ownKeys",r="destruct",s="1788c3c1-8ba6-4f70-bc8b-350c9901ca4c",n="="+s,o="-"+s,a=n+"-ws",c=o+"-ws";const{ArrayBuffer:i,Atomics:l,Promise:u}=globalThis,{isArray:p}=Array,{create:f,getPrototypeOf:d,values:g}=Object,h=d(Int32Array),y=f(l),w=()=>u.withResolvers();let m=0;const v=new Map,b=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&v.set(this,[m++,0,w()])}},k=new WeakSet,E=e=>(k.add(e),e),M=(e,t)=>{const{data:r}=e,s=p(r)&&(r.at(0)===t||0===r.at(1)&&!t);return s&&(e.stopImmediatePropagation(),e.preventDefault()),s},A=e=>null!==e&&"object"==typeof e&&!k.has(e),T=new WeakMap,W=(e,t,r)=>{if(v.has(e))t.set(e,v.get(e)[0]);else if(!(e instanceof h||e instanceof i))for(const s of g(e))A(s)&&!r.has(s)&&(r.add(s),W(s,t,r))},S=(...e)=>({value:new u((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),x=(e,t,r)=>{for(const[r,s]of t)T.set(r,[s,e.currentTarget]);(({currentTarget:e,type:t,origin:r,lastEventId:s,source:n,ports:o},a)=>{e.dispatchEvent(new MessageEvent(t,{data:a,origin:r,lastEventId:s,source:n,ports:o}))})(e,r)};let{BigInt64Array:I,Int32Array:U,SharedArrayBuffer:L,Worker:P}=globalThis,R=e=>e,D=!1;const j=e=>({...e,type:"module"});try{new L(4),P=class extends P{constructor(e,t){super(e,j(t))}},y.waitAsync||(y.waitAsync=S)}catch(e){const t=crypto.randomUUID(),r=new Map,s=(e,t,r,...s)=>{e.addEventListener(t,r,...s)},n=({serviceWorker:e},n,o)=>{let a,c=!0;s(e,"message",(e=>{if(M(e,t)){const[s,n,o]=e.data,c=[n,o].join(","),i=e=>{r.delete(c),a.postMessage([t,n,o,e])},l=r.get(c);if(l)i(l);else{const{promise:e,resolve:t}=w();r.set(c,t),e.then(i)}}})),e.getRegistration(n).then((t=>t??e.register(n))).then((function t(r){c=c&&!!e.controller,a=r.installing||r.waiting||r.active,"activated"===a.state?c?o():location.reload():s(a,"statechange",(()=>t(r)),{once:!0})}))};R=E,D=!0,y.notify=(e,s)=>{const[n,o]=(e=>T.get(e))(e),a=[n,s].join(","),c=r.get(a);return c?c(e):r.set(a,e),o.postMessage([t,1,e,n,s]),0},y.waitAsync=(e,...t)=>{const[r,s]=((e,t)=>{const r=v.get(e),[s,n,{promise:o}]=r;return r[1]=t,[s,o]})(e,...t);return{value:s}},L=class extends i{},I=b(I,L),U=b(U,L);let o=null;P=class extends P{constructor(e,r){let a=r?.serviceWorker||"";if(a){if(a=new URL(a,location.href).href,r={...r,serviceWorker:a},!o){const{promise:e,resolve:t}=w();n(navigator,a,t),o=e}o.then((()=>super.postMessage([t,3])))}super(e,j(r)),super.postMessage([t,0,r]),s(this,"message",(e=>{if(M(e,t)){const[t,r,...s]=e.data;switch(r){case 1:((e,t,r)=>{for(const[s,[n,o,{resolve:a}]]of v)if(t===n&&r===o){for(let t=0;t<e.length;t++)s[t]=e[t];v.delete(s),a("ok");break}})(...s);break;case 2:x(e,...s)}}}))}postMessage(e,...r){return super.postMessage(((e,t)=>{const r=new Map;return A(t)&&W(t,r,new Set),r.size?[e,2,r,t]:t})(t,e),...r)}}}const{BYTES_PER_ELEMENT:$}=Int32Array,{BYTES_PER_ELEMENT:O}=Uint16Array,{notify:B}=y,_=new TextDecoder("utf-16"),N=new WeakSet,z=(...e)=>(N.add(e),e);let J="";let Y=0;const C=([e,t,r,s,n,o,a,c,i],l)=>(...u)=>{let p=""!==J,f=0;p&&"="!==J[0]&&"-"!==J[0]&&(f=((e,t)=>setTimeout(console.warn,3e3,\`💀🔒 - proxy.\${e}() in proxy.\${t}()\`))(l,J));const d=Y++,g=[];N.has(u.at(-1)||g)&&N.delete(g=u.pop());const h=r(c?u.map(c):u);let y=t(2*$);return a([e,2,l,d,y,h,s],{transfer:g}),i(y,0).value.then((()=>{p&&clearTimeout(f);const r=y[1];if(!r)return;const s=O*r;return y=t(s+s%$),a([e,1,d,y]),i(y,0).value.then((()=>{const e=new Uint16Array(y.buffer),t=o?e.subarray(0,r):e.slice(0,r);return n(_.decode(t))}))}))};var F=({parse:e,stringify:t,transform:r}=JSON)=>{const s=((e,t)=>async(r,s,[n,o,a,c,i])=>{i&&(J=n);try{const n=await r(...c);if(void 0!==n){const r=e(t?t(n):n);s.set(o,r),a[1]=r.length}}finally{i&&(J=""),a[0]=1,B(a,0)}})(t,r),n=crypto.randomUUID();return{Worker:class extends P{constructor(t,o){const a=new Map,c=new Map;super(t,o),this.proxy=((e,t)=>new Proxy(t,{get:(t,r)=>{let s;return"then"!==r&&(s=t.get(r),s||(s=C(e,r),t.set(r,s))),s},set:(e,t,r)=>"then"!==t&&!!e.set(t,r)}))([n,e=>new U(new L(e)),R,!1,e,D,(...e)=>this.postMessage(...e),r,y.waitAsync],a),this.postMessage(R([n,0,o])),this.addEventListener("message",(e=>{if(M(e,n)){const[t,r,...n]=e.data;switch(r){case 2:((e,t,r,s)=>{const[n]=s,o=r.get(n);if(!o)throw new Error(\`Unknown proxy.\${n}()\`);e(o,t,s)})(s,c,a,n);break;case 1:((e,[t,r])=>{const s=e.get(t);e.delete(t);for(let e=new Uint16Array(r.buffer),t=0,{length:n}=s;t<n;t++)e[t]=s.charCodeAt(t);B(r,0)})(c,n)}}}))}},polyfill:D,transfer:z}};const H="array",K="function",X="null",q="number",G="object",Q="string",V="symbol",Z="undefined";let ee=0;const te=new Map,re=new Map,se=e=>re.get(e),ne=e=>{if(!te.has(e)){let t;for(;re.has(t=ee++););te.set(e,t),re.set(t,e)}return te.get(e)};var oe=Object.fromEntries([H,"bigint","boolean",K,X,q,G,Q,V,Z].map(((e,t)=>[e,t])));const{[t]:ae}=Reflect,ce=new Map(ae(Symbol).filter((e=>typeof Symbol[e]===V)).map((e=>[Symbol[e],e]))),ie=e=>ce.get(e)||\`.\${Symbol.keyFor(e)||""}\`,le=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(\`%c\${String(t)}\`,"font-weight:bold","collected"),e(t)})),ue=Object.create(null),{addEventListener:pe}=EventTarget.prototype,fe=new WeakMap;Reflect.defineProperty(EventTarget.prototype,"addEventListener",{value(e,t,...r){const s=r.at(0)?.invoke;if(s){let t=fe.get(this);t||(t=new Map,fe.set(this,t)),t.set(e,[].concat(s)),delete r[0].invoke}return pe.call(this,e,t,...r)}});const{isArray:de}=Array,ge=e=>{const t=typeof e;switch(t){case G:return null===e?[oe[X],e]:e===globalThis?[oe[G],null]:de(e)?[oe[H],ne(e)]:[oe[G],e instanceof h?e:ne(e)];case K:return[oe[K],ne(e)];case V:return[oe[V],ie(e)];default:return[oe[t],e]}};var he=(s,n)=>{const o=new Map,a=e=>{o.delete(e),n(r,e)},c=([t,r])=>{switch(t){case oe[G]:if(null===r)return globalThis;if(typeof r===q)return se(r);if(!(r instanceof h))for(const e in r)r[e]=c(r[e]);return r;case oe[H]:return typeof r===q?se(r):r.map(c);case oe[K]:switch(typeof r){case q:return se(r);case Q:{let t=o.get(r)?.deref();return t||(t=((e,t,{debug:r,handler:s,return:n,token:o=e}=ue)=>{const a=n||new Proxy(e,s||ue),c=[a,[t,e,!!r]];return!1!==o&&c.push(o),le.register(...c),a})(r,a,{token:!1,return:function(...t){return t.length&&t[0]instanceof Event&&(e=>{const{currentTarget:t,target:r,type:s}=e,n=fe.get(t||r)?.get(s);if(n)for(const t of n)e[t]()})(t[0]),n(e,r,ge(this),t.map(ge)).then(c)}}),o.set(r,new WeakRef(t))),t}}case oe[V]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of ce)if(r===e)return t})(r);default:return r}},i=e=>import(s(e));return(e,s,...n)=>{if(e===r)(e=>{const[t,r]=typeof e===q?[re,te]:[te,re],s=t.has(e);s&&(r.delete(t.get(e)),t.delete(e))})(s);else{const r=Reflect[e],o=null==s?globalThis:se(s);switch(e){case"defineProperty":{const[e,t]=n.map(c);return ge(r(o,e,t))}case"getOwnPropertyDescriptor":{const e=r(o,...n.map(c));if(e){const{get:t,set:r,value:s}=e;t&&(e.get=ge(t)),r&&(e.set=ge(r)),s&&(e.value=ge(s))}return[oe[e?G:Z],e]}case t:return[oe[H],r(o).map(ge)];case"get":if(null==s&&"import"===n[0][1])return ge(i);default:return((e,t,r)=>ge(e(t,...r.map(c))))(r,o,n)}}}},ye=e=>{const t=e?.import,r=F(e);class s extends r.Worker{constructor(e,r){const{proxy:s}=super(e,r);s[n]=he(r?.import||t||(e=>new URL(e,location.href)),s[o])}}return{...r,Worker:s}};class we{constructor(e,t){this._=e,this.$=t}get data(){return this.$}preventDefault(){this._.preventDefault()}stopImmediatePropagation(){this._.stopImmediatePropagation()}}const{WebSocket:me}=globalThis,{parse:ve,stringify:be}=JSON;try{new SharedArrayBuffer(4)}catch({message:e}){alert(e),close()}const{workerful:ke}=globalThis;if(delete globalThis.workerful,addEventListener("beforeunload",(()=>{navigator.sendBeacon(\`/\${ke.secret}?\${encodeURIComponent(JSON.stringify({position:[screenX,screenY],size:[innerWidth,innerHeight]}))}\`)})),ke.centered){const{width:e,height:t}=screen,r=(e-innerWidth)/2,s=(t-innerHeight)/2;moveTo(r,s)}const{Worker:Ee}=(t=>{t={parse:ve,stringify:be,...t};const{parse:r,stringify:s,ws:n}=t,o=ye(t);class i extends o.Worker{#e=null;constructor(t,...o){let i=0;const l=crypto.randomUUID(),u=new Map,{proxy:p}=super(t,...o),{[c]:f}=p,{promise:d,resolve:g}=w(),h=this.#e=new me(n);p[a]=async(...e)=>{await d;const{promise:t,resolve:r}=w();return u.set(i,r),h.send(s([l,i++,...e])),t},h.addEventListener("close",(()=>{super.terminate()})),h.addEventListener("open",(()=>{h.send(s([l,0]))})),h.addEventListener("message",(async t=>{t.data||g();try{const n=r(t.data);if(M(new we(t,n),l)){let[t,r,o]=n;if(null==r){const[t,n,...a]=o,c=t===e;c&&(r=a.pop());try{o=await f(t,n,...a)}catch(e){o=e}c&&h.send(s([l,null,t,r,o]))}else u.get(r)(o),u.delete(r)}}catch(e){}}))}terminate(){this.#e.close(),super.terminate()}}return{...o,Worker:i}})({ws:ke.ws});new Ee("/workerful.js")}();\n`,t.writeHead(200,{"Content-Type":"text/javascript;charset=utf-8"}),t.end(e),!0}}else if("POST"===o){const e=`/${no}?`;if(r.startsWith(e)){const{promise:t,resolve:o}=Promise.withResolvers();ao=t;try{Object.assign(eo.window,oe(decodeURIComponent(r.slice(e.length)))),"always"!==eo.centered&&(eo.centered=!1),s(Zs,`${ne(Qs,null,"\t")}\n`)}finally{o()}return!0}}return!1}));co.listen(+so,ro,(async function(){const{address:e,family:t,port:r}=this.address(),s=`//${"IPv4"===t?e:"localhost"}:${r}/`,{name:o,flags:n}=(({name:e,workerful:{name:t,browser:r,window:s}},o,n)=>{const i=r?.name||"chrome",c=(r?.flags||[]).slice(0),l=t||e;if("chrome"!==i)throw new Error(`Unsupported browser ${i}`);return c.push(`--window-position=${(s?.position||[0,0]).join(",")}`,`--window-size=${(s?.size||[640,400]).join(",")}`,`--window-name=${l}`,`--user-data-dir=${a(g(),".workerful",l.replace(/\s/g,"-"))}`,"--ignore-profile-directory-if-not-exists","--enable-webgpu-developer-features","--ignore-gpu-blocklist","--disable-extensions","--allow-running-insecure-content","--allow-files-access-from-files","--enable-features=SharedArrayBuffer","--disable-first-run-ui","--new-window","--minimal","--content-shell-hide-toolbar","--incognito","--no-first-run","--no-default-browser-check","--disable-default-apps","--disable-cache","--no-default-browser-check","--disable-popup-blocking","--disable-system-font-check"),n?c.push("--kiosk",o):c.push(`--app=${o}`),{name:i,flags:c}})(Qs,`http:${s}`,se(oo));io=`ws:${s}`;const i=await((e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected a valid `name`");const{arguments:r=[]}=t??{};if(null!=r&&!Array.isArray(r))throw new TypeError("Expected `appArguments` as Array type");return Q({...t,app:{name:e,arguments:r}})})(re[o],{arguments:n}),{pid:c}=i;process.on("SIGINT",(()=>{setTimeout((()=>process.exit(0))),process.kill(c)})),i.on("close",(()=>{setTimeout((async()=>{await ao,process.exit(0)}),250)})),process.env.DEBUG&&(console.debug(`chromium ${n.join(" ")}`),console.debug(`[1mhttp://${s}[0m`))}));

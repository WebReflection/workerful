#!/usr/bin/env node
/*!
 * MIT License
 * 
 * # workerful, @ungap/with-resolvers, @ungap/structured-clone, coincident, flatted, static-handler
 * Copyright (c) Andrea Giammarchi, @WebReflection
 * 
 * # open
 * Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)
 * 
 * # ws
 * Copyright (c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * Copyright (c) 2013 Arnout Kazemier and contributors
 * Copyright (c) 2016 Luigi Pinca and contributors
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import e,{existsSync as t,readFileSync as r,writeFileSync as s}from"node:fs";import n from"node:process";import{Buffer as o}from"node:buffer";import i,{join as a,resolve as c,dirname as l}from"node:path";import{fileURLToPath as h}from"node:url";import f,{execFile as u}from"node:child_process";import d,{constants as p}from"node:fs/promises";import m,{homedir as g}from"node:os";import{promisify as y}from"node:util";import{createServer as w}from"node:http";import _ from"stream";import b from"zlib";import v from"buffer";import x from"crypto";import S from"events";import E from"https";import k from"http";import O from"net";import T from"tls";import P from"url";import{extname as j,resolve as N}from"path";import{statSync as R,createReadStream as L}from"fs";let C,I;function B(){return void 0===C&&(C=function(){try{return e.statSync("/.dockerenv"),!0}catch{return!1}}()||function(){try{return e.readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}()),C}Promise.withResolvers||(Promise.withResolvers=function(){var e,t,r=new this((function(r,s){e=r,t=s}));return{resolve:e,reject:t,promise:r}});function M(){return void 0===I&&(I=(()=>{try{return e.statSync("/run/.containerenv"),!0}catch{return!1}})()||B()),I}const A=()=>{if("linux"!==n.platform)return!1;if(m.release().toLowerCase().includes("microsoft"))return!M();try{return!!e.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")&&!M()}catch{return!1}};var U=n.env.__IS_WSL_TEST__?A:A();function W(e,t,r){const s=r=>Object.defineProperty(e,t,{value:r,enumerable:!0,writable:!0});return Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get(){const e=r();return s(e),e},set(e){s(e)}}),e}const $=y(u);const D=y(u);async function F(e){return async function(e,{humanReadableOutput:t=!0}={}){if("darwin"!==n.platform)throw new Error("macOS only");const r=t?[]:["-ss"],{stdout:s}=await D("osascript",["-e",e,r]);return s.trim()}(`tell application "Finder" to set app_path to application file id "${e}" as string\ntell application "System Events" to get value of property list item "CFBundleName" of property list file (app_path & ":Contents:Info.plist")`)}const z=y(u),q={AppXq0fevzme2pys62n3e0fbqa7peapykr8v:{name:"Edge",id:"com.microsoft.edge.old"},MSEdgeDHTML:{name:"Edge",id:"com.microsoft.edge"},MSEdgeHTM:{name:"Edge",id:"com.microsoft.edge"},"IE.HTTP":{name:"Internet Explorer",id:"com.microsoft.ie"},FirefoxURL:{name:"Firefox",id:"org.mozilla.firefox"},ChromeHTML:{name:"Chrome",id:"com.google.chrome"},BraveHTML:{name:"Brave",id:"com.brave.Browser"},BraveBHTML:{name:"Brave Beta",id:"com.brave.Browser.beta"},BraveSSHTM:{name:"Brave Nightly",id:"com.brave.Browser.nightly"}};class G extends Error{}const V=y(u);async function H(){if("darwin"===n.platform){const e=await async function(){if("darwin"!==n.platform)throw new Error("macOS only");const{stdout:e}=await $("defaults",["read","com.apple.LaunchServices/com.apple.launchservices.secure","LSHandlers"]),t=/LSHandlerRoleAll = "(?!-)(?<id>[^"]+?)";\s+?LSHandlerURLScheme = (?:http|https);/.exec(e);return t?.groups.id??"com.apple.Safari"}();return{name:await F(e),id:e}}if("linux"===n.platform){const{stdout:e}=await V("xdg-mime",["query","default","x-scheme-handler/http"]),t=e.trim();return{name:t.replace(/.desktop$/,"").replace("-"," ").toLowerCase().replaceAll(/(?:^|\s|-)\S/g,(e=>e.toUpperCase())),id:t}}if("win32"===n.platform)return async function(e=z){const{stdout:t}=await e("reg",["QUERY"," HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\http\\UserChoice","/v","ProgId"]),r=/ProgId\s*REG_SZ\s*(?<id>\S+)/.exec(t);if(!r)throw new G(`Cannot find Windows browser in stdout: ${JSON.stringify(t)}`);const{id:s}=r.groups,n=q[s];if(!n)throw new G(`Unknown browser ID: ${s}`);return n}();throw new Error("Only macOS, Linux, and Windows are supported")}const Y=i.dirname(h(import.meta.url)),J=i.join(Y,"xdg-open"),{platform:K,arch:X}=n,Z=(()=>{const e="/mnt/";let t;return async function(){if(t)return t;const r="/etc/wsl.conf";let s=!1;try{await d.access(r,p.F_OK),s=!0}catch{}if(!s)return e;const n=await d.readFile(r,{encoding:"utf8"}),o=/(?<!#.*)root\s*=\s*(?<mountPoint>.*)/g.exec(n);return o?(t=o.groups.mountPoint.trim(),t=t.endsWith("/")?t:`${t}/`,t):e}})(),Q=async(e,t)=>{let r;for(const s of e)try{return await t(s)}catch(e){r=e}throw r},ee=async e=>{if(e={wait:!1,background:!1,newInstance:!1,allowNonzeroExitCode:!1,...e},Array.isArray(e.app))return Q(e.app,(t=>ee({...e,app:t})));let t,{name:r,arguments:s=[]}=e.app??{};if(s=[...s],Array.isArray(r))return Q(r,(t=>ee({...e,app:{name:t,arguments:s}})));if("browser"===r||"browserPrivate"===r){const t={"com.google.chrome":"chrome","google-chrome.desktop":"chrome","org.mozilla.firefox":"firefox","firefox.desktop":"firefox","com.microsoft.msedge":"edge","com.microsoft.edge":"edge","microsoft-edge.desktop":"edge"},n={chrome:"--incognito",firefox:"--private-window",edge:"--inPrivate"},o=await H();if(o.id in t){const i=t[o.id];return"browserPrivate"===r&&s.push(n[i]),ee({...e,app:{name:se[i],arguments:s}})}throw new Error(`${o.name} is not supported as a default browser`)}const i=[],a={};if("darwin"===K)t="open",e.wait&&i.push("--wait-apps"),e.background&&i.push("--background"),e.newInstance&&i.push("--new"),r&&i.push("-a",r);else if("win32"===K||U&&!M()&&!r){const c=await Z();t=U?`${c}c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe`:`${n.env.SYSTEMROOT||n.env.windir||"C:\\Windows"}\\System32\\WindowsPowerShell\\v1.0\\powershell`,i.push("-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand"),U||(a.windowsVerbatimArguments=!0);const l=["Start"];e.wait&&l.push("-Wait"),r?(l.push(`"\`"${r}\`""`),e.target&&s.push(e.target)):e.target&&l.push(`"${e.target}"`),s.length>0&&(s=s.map((e=>`"\`"${e}\`""`)),l.push("-ArgumentList",s.join(","))),e.target=o.from(l.join(" "),"utf16le").toString("base64")}else{if(r)t=r;else{const e=!Y||"/"===Y;let r=!1;try{await d.access(J,p.X_OK),r=!0}catch{}t=n.versions.electron??("android"===K||e||!r)?"xdg-open":J}s.length>0&&i.push(...s),e.wait||(a.stdio="ignore",a.detached=!0)}"darwin"===K&&s.length>0&&i.push("--args",...s),e.target&&i.push(e.target);const c=f.spawn(t,i,a);return e.wait?new Promise(((t,r)=>{c.once("error",r),c.once("close",(s=>{!e.allowNonzeroExitCode&&s>0?r(new Error(`Exited with code ${s}`)):t(c)}))})):(c.unref(),c)};function te(e){if("string"==typeof e||Array.isArray(e))return e;const{[X]:t}=e;if(!t)throw new Error(`${X} is not supported`);return t}function re({[K]:e},{wsl:t}){if(t&&U)return te(t);if(!e)throw new Error(`${K} is not supported`);return te(e)}const se={};W(se,"chrome",(()=>re({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}}))),W(se,"firefox",(()=>re({darwin:"firefox",win32:"C:\\Program Files\\Mozilla Firefox\\firefox.exe",linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"}))),W(se,"edge",(()=>re({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"}))),W(se,"browser",(()=>"browser")),W(se,"browserPrivate",(()=>"browserPrivate"));const ne=e=>/^(?:1|y|ok|yes|true)$/i.test(e),{parse:oe,stringify:ie}=JSON;function ae(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ce={exports:{}};const le=["nodebuffer","arraybuffer","fragments"],he="undefined"!=typeof Blob;he&&le.push("blob");var fe={BINARY_TYPES:le,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:he,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:ue}=fe,de=Buffer[Symbol.species];function pe(e,t,r,s,n){for(let o=0;o<n;o++)r[s+o]=e[o]^t[3&o]}function me(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(ce.exports={concat:function(e,t){if(0===e.length)return ue;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(t);let s=0;for(let t=0;t<e.length;t++){const n=e[t];r.set(n,s),s+=n.length}return s<t?new de(r.buffer,r.byteOffset,s):r},mask:pe,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let r;return t instanceof ArrayBuffer?r=new de(t):ArrayBuffer.isView(t)?r=new de(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r},unmask:me},!process.env.WS_NO_BUFFER_UTIL)try{const e=require("bufferutil");ce.exports.mask=function(t,r,s,n,o){o<48?pe(t,r,s,n,o):e.mask(t,r,s,n,o)},ce.exports.unmask=function(t,r){t.length<32?me(t,r):e.unmask(t,r)}}catch(e){}var ge=ce.exports;const ye=Symbol("kDone"),we=Symbol("kRun");const _e=b,be=ge,ve=class{constructor(e){this[ye]=()=>{this.pending--,this[we]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[we]()}[we](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[ye])}}},{kStatusCode:xe}=fe,Se=Buffer[Symbol.species],Ee=Buffer.from([0,0,255,255]),ke=Symbol("permessage-deflate"),Oe=Symbol("total-length"),Te=Symbol("callback"),Pe=Symbol("buffers"),je=Symbol("error");let Ne;var Re=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ne){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;Ne=new ve(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Te];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){Ne.add((s=>{this._decompress(e,t,((e,t)=>{s(),r(e,t)}))}))}compress(e,t,r){Ne.add((s=>{this._compress(e,t,((e,t)=>{s(),r(e,t)}))}))}_decompress(e,t,r){const s=this._isServer?"client":"server";if(!this._inflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?_e.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=_e.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[ke]=this,this._inflate[Oe]=0,this._inflate[Pe]=[],this._inflate.on("error",Ie),this._inflate.on("data",Ce)}this._inflate[Te]=r,this._inflate.write(e),t&&this._inflate.write(Ee),this._inflate.flush((()=>{const e=this._inflate[je];if(e)return this._inflate.close(),this._inflate=null,void r(e);const n=be.concat(this._inflate[Pe],this._inflate[Oe]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Oe]=0,this._inflate[Pe]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),r(null,n)}))}_compress(e,t,r){const s=this._isServer?"server":"client";if(!this._deflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?_e.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=_e.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Oe]=0,this._deflate[Pe]=[],this._deflate.on("data",Le)}this._deflate[Te]=r,this._deflate.write(e),this._deflate.flush(_e.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=be.concat(this._deflate[Pe],this._deflate[Oe]);t&&(e=new Se(e.buffer,e.byteOffset,e.length-4)),this._deflate[Te]=null,this._deflate[Oe]=0,this._deflate[Pe]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),r(null,e)}))}};function Le(e){this[Pe].push(e),this[Oe]+=e.length}function Ce(e){this[Oe]+=e.length,this[ke]._maxPayload<1||this[Oe]<=this[ke]._maxPayload?this[Pe].push(e):(this[je]=new RangeError("Max payload size exceeded"),this[je].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[je][xe]=1009,this.removeListener("data",Ce),this.reset())}function Ie(e){this[ke]._inflate=null,e[xe]=1007,this[Te](e)}var Be={exports:{}};const{isUtf8:Me}=v,{hasBlob:Ae}=fe;function Ue(e){const t=e.length;let r=0;for(;r<t;)if(128&e[r])if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}else r++;return!0}if(Be.exports={isBlob:function(e){return Ae&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:Ue,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},Me)Be.exports.isValidUTF8=function(e){return e.length<24?Ue(e):Me(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const e=require("utf-8-validate");Be.exports.isValidUTF8=function(t){return t.length<32?Ue(t):e(t)}}catch(e){}var We=Be.exports;const{Writable:$e}=_,De=Re,{BINARY_TYPES:Fe,EMPTY_BUFFER:ze,kStatusCode:qe,kWebSocket:Ge}=fe,{concat:Ve,toArrayBuffer:He,unmask:Ye}=ge,{isValidStatusCode:Je,isValidUTF8:Ke}=We,Xe=Buffer[Symbol.species];var Ze=class extends $e{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||Fe[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[Ge]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new Xe(t.buffer,t.byteOffset+e,t.length-e),new Xe(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],s=t.length-e;e>=r.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),s),this._buffers[0]=new Xe(r.buffer,r.byteOffset+e,r.length-e)),e-=r.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(48&t[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const r=!(64&~t[0]);if(!r||this._extensions[De.extensionName]){if(this._fin=!(128&~t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=r}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),r=t.readUInt32BE(0);if(r>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=r*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=ze;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&Ye(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[De.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(r)}this.dataMessage(t),0===this._state&&this.startLoop(t)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?Ve(r,t):"arraybuffer"===this._binaryType?He(Ve(r,t)):"blob"===this._binaryType?new Blob(r):r,this._allowSynchronousEvents?(this.emit("message",s,!0),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",s,!0),this._state=0,this.startLoop(e)})))}else{const s=Ve(r,t);if(!this._skipUTF8Validation&&!Ke(s)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",s,!1),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",s,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,ze),this.end();else{const r=e.readUInt16BE(0);if(!Je(r)){const e=this.createError(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const s=new Xe(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Ke(s)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",r,s),this.end()}this._state=0}}createError(e,t,r,s,n){this._loop=!1,this._errored=!0;const o=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=n,o[qe]=s,o}};const{randomFillSync:Qe}=x,et=Re,{EMPTY_BUFFER:tt,kWebSocket:rt,NOOP:st}=fe,{isBlob:nt,isValidStatusCode:ot}=We,{mask:it,toBuffer:at}=ge,ct=Symbol("kByteLength"),lt=Buffer.alloc(4),ht=8192;let ft,ut=ht;var dt=class e{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=st,this[rt]=void 0}static frame(e,t){let r,s,n=!1,o=2,i=!1;t.mask&&(r=t.maskBuffer||lt,t.generateMask?t.generateMask(r):(ut===ht&&(void 0===ft&&(ft=Buffer.alloc(ht)),Qe(ft,0,ht),ut=0),r[0]=ft[ut++],r[1]=ft[ut++],r[2]=ft[ut++],r[3]=ft[ut++]),i=!(r[0]|r[1]|r[2]|r[3]),o=6),"string"==typeof e?s=t.mask&&!i||void 0===t[ct]?(e=Buffer.from(e)).length:t[ct]:(s=e.length,n=t.mask&&t.readOnly&&!i);let a=s;s>=65536?(o+=8,a=127):s>125&&(o+=2,a=126);const c=Buffer.allocUnsafe(n?s+o:o);return c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=a,126===a?c.writeUInt16BE(s,2):127===a&&(c[2]=c[3]=0,c.writeUIntBE(s,4,6)),t.mask?(c[1]|=128,c[o-4]=r[0],c[o-3]=r[1],c[o-2]=r[2],c[o-1]=r[3],i?[c,e]:n?(it(e,r,c,o,s),[c]):(it(e,r,e,0,s),[c,e])):[c,e]}close(t,r,s,n){let o;if(void 0===t)o=tt;else{if("number"!=typeof t||!ot(t))throw new TypeError("First argument must be a valid error code number");if(void 0!==r&&r.length){const e=Buffer.byteLength(r);if(e>123)throw new RangeError("The message must not be greater than 123 bytes");o=Buffer.allocUnsafe(2+e),o.writeUInt16BE(t,0),"string"==typeof r?o.write(r,2):o.set(r,2)}else o=Buffer.allocUnsafe(2),o.writeUInt16BE(t,0)}const i={[ct]:o.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,o,!1,i,n]):this.sendFrame(e.frame(o,i),n)}ping(t,r,s){let n,o;if("string"==typeof t?(n=Buffer.byteLength(t),o=!1):nt(t)?(n=t.size,o=!1):(n=(t=at(t)).length,o=at.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[ct]:n,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:9,readOnly:o,rsv1:!1};nt(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,i,s]):this.getBlobData(t,!1,i,s):0!==this._state?this.enqueue([this.dispatch,t,!1,i,s]):this.sendFrame(e.frame(t,i),s)}pong(t,r,s){let n,o;if("string"==typeof t?(n=Buffer.byteLength(t),o=!1):nt(t)?(n=t.size,o=!1):(n=(t=at(t)).length,o=at.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[ct]:n,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:10,readOnly:o,rsv1:!1};nt(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,i,s]):this.getBlobData(t,!1,i,s):0!==this._state?this.enqueue([this.dispatch,t,!1,i,s]):this.sendFrame(e.frame(t,i),s)}send(e,t,r){const s=this._extensions[et.extensionName];let n,o,i=t.binary?2:1,a=t.compress;"string"==typeof e?(n=Buffer.byteLength(e),o=!1):nt(e)?(n=e.size,o=!1):(n=(e=at(e)).length,o=at.readOnly),this._firstFragment?(this._firstFragment=!1,a&&s&&s.params[s._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=n>=s._threshold),this._compress=a):(a=!1,i=0),t.fin&&(this._firstFragment=!0);const c={[ct]:n,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:o,rsv1:a};nt(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,c,r]):this.getBlobData(e,this._compress,c,r):0!==this._state?this.enqueue([this.dispatch,e,this._compress,c,r]):this.dispatch(e,this._compress,c,r)}getBlobData(t,r,s,n){this._bufferedBytes+=s[ct],this._state=2,t.arrayBuffer().then((t=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void process.nextTick(pt,this,e,n)}this._bufferedBytes-=s[ct];const o=at(t);r?this.dispatch(o,r,s,n):(this._state=0,this.sendFrame(e.frame(o,s),n),this.dequeue())})).catch((e=>{process.nextTick(mt,this,e,n)}))}dispatch(t,r,s,n){if(!r)return void this.sendFrame(e.frame(t,s),n);const o=this._extensions[et.extensionName];this._bufferedBytes+=s[ct],this._state=1,o.compress(t,s.fin,((t,r)=>{if(this._socket.destroyed){pt(this,new Error("The socket was closed while data was being compressed"),n)}else this._bufferedBytes-=s[ct],this._state=0,s.readOnly=!1,this.sendFrame(e.frame(r,s),n),this.dequeue()}))}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][ct],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][ct],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};function pt(e,t,r){"function"==typeof r&&r(t);for(let r=0;r<e._queue.length;r++){const s=e._queue[r],n=s[s.length-1];"function"==typeof n&&n(t)}}function mt(e,t,r){pt(e,t,r),e.onerror(t)}const{kForOnEventAttribute:gt,kListener:yt}=fe,wt=Symbol("kCode"),_t=Symbol("kData"),bt=Symbol("kError"),vt=Symbol("kMessage"),xt=Symbol("kReason"),St=Symbol("kTarget"),Et=Symbol("kType"),kt=Symbol("kWasClean");let Ot=class{constructor(e){this[St]=null,this[Et]=e}get target(){return this[St]}get type(){return this[Et]}};Object.defineProperty(Ot.prototype,"target",{enumerable:!0}),Object.defineProperty(Ot.prototype,"type",{enumerable:!0});class Tt extends Ot{constructor(e,t={}){super(e),this[wt]=void 0===t.code?0:t.code,this[xt]=void 0===t.reason?"":t.reason,this[kt]=void 0!==t.wasClean&&t.wasClean}get code(){return this[wt]}get reason(){return this[xt]}get wasClean(){return this[kt]}}Object.defineProperty(Tt.prototype,"code",{enumerable:!0}),Object.defineProperty(Tt.prototype,"reason",{enumerable:!0}),Object.defineProperty(Tt.prototype,"wasClean",{enumerable:!0});class Pt extends Ot{constructor(e,t={}){super(e),this[bt]=void 0===t.error?null:t.error,this[vt]=void 0===t.message?"":t.message}get error(){return this[bt]}get message(){return this[vt]}}Object.defineProperty(Pt.prototype,"error",{enumerable:!0}),Object.defineProperty(Pt.prototype,"message",{enumerable:!0});class jt extends Ot{constructor(e,t={}){super(e),this[_t]=void 0===t.data?null:t.data}get data(){return this[_t]}}Object.defineProperty(jt.prototype,"data",{enumerable:!0});const Nt={addEventListener(e,t,r={}){for(const s of this.listeners(e))if(!r[gt]&&s[yt]===t&&!s[gt])return;let s;if("message"===e)s=function(e,r){const s=new jt("message",{data:r?e:e.toString()});s[St]=this,Lt(t,this,s)};else if("close"===e)s=function(e,r){const s=new Tt("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});s[St]=this,Lt(t,this,s)};else if("error"===e)s=function(e){const r=new Pt("error",{error:e,message:e.message});r[St]=this,Lt(t,this,r)};else{if("open"!==e)return;s=function(){const e=new Ot("open");e[St]=this,Lt(t,this,e)}}s[gt]=!!r[gt],s[yt]=t,r.once?this.once(e,s):this.on(e,s)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[yt]===t&&!r[gt]){this.removeListener(e,r);break}}};var Rt={CloseEvent:Tt,ErrorEvent:Pt,Event:Ot,EventTarget:Nt,MessageEvent:jt};function Lt(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}const{tokenChars:Ct}=We;function It(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var Bt={format:function(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let r,s,n=Object.create(null),o=!1,i=!1,a=!1,c=-1,l=-1,h=-1,f=0;for(;f<e.length;f++)if(l=e.charCodeAt(f),void 0===r)if(-1===h&&1===Ct[l])-1===c&&(c=f);else if(0===f||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f);const s=e.slice(c,h);44===l?(It(t,s,n),n=Object.create(null)):r=s,c=h=-1}}else-1===h&&-1!==c&&(h=f);else if(void 0===s)if(-1===h&&1===Ct[l])-1===c&&(c=f);else if(32===l||9===l)-1===h&&-1!==c&&(h=f);else if(59===l||44===l){if(-1===c)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f),It(n,e.slice(c,h),!0),44===l&&(It(t,r,n),n=Object.create(null),r=void 0),c=h=-1}else{if(61!==l||-1===c||-1!==h)throw new SyntaxError(`Unexpected character at index ${f}`);s=e.slice(c,f),c=h=-1}else if(i){if(1!==Ct[l])throw new SyntaxError(`Unexpected character at index ${f}`);-1===c?c=f:o||(o=!0),i=!1}else if(a)if(1===Ct[l])-1===c&&(c=f);else if(34===l&&-1!==c)a=!1,h=f;else{if(92!==l)throw new SyntaxError(`Unexpected character at index ${f}`);i=!0}else if(34===l&&61===e.charCodeAt(f-1))a=!0;else if(-1===h&&1===Ct[l])-1===c&&(c=f);else if(-1===c||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f);let i=e.slice(c,h);o&&(i=i.replace(/\\/g,""),o=!1),It(n,s,i),44===l&&(It(t,r,n),n=Object.create(null),r=void 0),s=void 0,c=h=-1}}else-1===h&&(h=f);if(-1===c||a||32===l||9===l)throw new SyntaxError("Unexpected end of input");-1===h&&(h=f);const u=e.slice(c,h);return void 0===r?It(t,u,n):(void 0===s?It(n,u,!0):It(n,s,o?u.replace(/\\/g,""):u),It(t,r,n)),t}};const Mt=S,At=E,Ut=k,Wt=O,$t=T,{randomBytes:Dt,createHash:Ft}=x,{URL:zt}=P,qt=Re,Gt=Ze,Vt=dt,{isBlob:Ht}=We,{BINARY_TYPES:Yt,EMPTY_BUFFER:Jt,GUID:Kt,kForOnEventAttribute:Xt,kListener:Zt,kStatusCode:Qt,kWebSocket:er,NOOP:tr}=fe,{EventTarget:{addEventListener:rr,removeEventListener:sr}}=Rt,{format:nr,parse:or}=Bt,{toBuffer:ir}=ge,ar=3e4,cr=Symbol("kAborted"),lr=[8,13],hr=["CONNECTING","OPEN","CLOSING","CLOSED"],fr=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;let ur=class e extends Mt{constructor(t,r,s){super(),this._binaryType=Yt[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Jt,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=e.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==t?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===r?r=[]:Array.isArray(r)||("object"==typeof r&&null!==r?(s=r,r=[]):r=[r]),pr(this,t,r,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Yt.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(t,r,s){const n=new Gt({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),o=new Vt(t,this._extensions,s.generateMask);this._receiver=n,this._sender=o,this._socket=t,n[er]=this,o[er]=this,t[er]=this,n.on("conclude",br),n.on("drain",vr),n.on("error",xr),n.on("message",Er),n.on("ping",kr),n.on("pong",Or),o.onerror=Pr,t.setTimeout&&t.setTimeout(0),t.setNoDelay&&t.setNoDelay(),r.length>0&&t.unshift(r),t.on("close",Nr),t.on("data",Rr),t.on("end",Lr),t.on("error",Cr),this._readyState=e.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=e.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[qt.extensionName]&&this._extensions[qt.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=e.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(t,r){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this.readyState!==e.CLOSING?(this._readyState=e.CLOSING,this._sender.close(t,r,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),jr(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";wr(this,this._req,e)}}pause(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!0,this._socket.pause())}ping(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(s=t,t=r=void 0):"function"==typeof r&&(s=r,r=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===r&&(r=!this._isServer),this._sender.ping(t||Jt,r,s)):_r(this,t,s)}pong(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(s=t,t=r=void 0):"function"==typeof r&&(s=r,r=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===r&&(r=!this._isServer),this._sender.pong(t||Jt,r,s)):_r(this,t,s)}resume(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof r&&(s=r,r={}),"number"==typeof t&&(t=t.toString()),this.readyState!==e.OPEN)return void _r(this,t,s);const n={binary:"string"!=typeof t,mask:!this._isServer,compress:!0,fin:!0,...r};this._extensions[qt.extensionName]||(n.compress=!1),this._sender.send(t||Jt,n,s)}terminate(){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this._socket&&(this._readyState=e.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";wr(this,this._req,e)}}};Object.defineProperty(ur,"CONNECTING",{enumerable:!0,value:hr.indexOf("CONNECTING")}),Object.defineProperty(ur.prototype,"CONNECTING",{enumerable:!0,value:hr.indexOf("CONNECTING")}),Object.defineProperty(ur,"OPEN",{enumerable:!0,value:hr.indexOf("OPEN")}),Object.defineProperty(ur.prototype,"OPEN",{enumerable:!0,value:hr.indexOf("OPEN")}),Object.defineProperty(ur,"CLOSING",{enumerable:!0,value:hr.indexOf("CLOSING")}),Object.defineProperty(ur.prototype,"CLOSING",{enumerable:!0,value:hr.indexOf("CLOSING")}),Object.defineProperty(ur,"CLOSED",{enumerable:!0,value:hr.indexOf("CLOSED")}),Object.defineProperty(ur.prototype,"CLOSED",{enumerable:!0,value:hr.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(ur.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(ur.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[Xt])return t[Zt];return null},set(t){for(const t of this.listeners(e))if(t[Xt]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[Xt]:!0})}})})),ur.prototype.addEventListener=rr,ur.prototype.removeEventListener=sr;var dr=ur;function pr(e,t,r,s){const n={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:lr[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=n.autoPong,!lr.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${lr.join(", ")})`);let o;if(t instanceof zt)o=t;else try{o=new zt(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===o.protocol?o.protocol="ws:":"https:"===o.protocol&&(o.protocol="wss:"),e._url=o.href;const i="wss:"===o.protocol,a="ws+unix:"===o.protocol;let c;if("ws:"===o.protocol||i||a?a&&!o.pathname?c="The URL's pathname is empty":o.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',c){const t=new SyntaxError(c);if(0===e._redirects)throw t;return void mr(e,t)}const l=i?443:80,h=Dt(16).toString("base64"),f=i?At.request:Ut.request,u=new Set;let d,p;if(n.createConnection=n.createConnection||(i?yr:gr),n.defaultPort=n.defaultPort||l,n.port=o.port||l,n.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,n.headers={...n.headers,"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket"},n.path=o.pathname+o.search,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(d=new qt(!0!==n.perMessageDeflate?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=nr({[qt.extensionName]:d.offer()})),r.length){for(const e of r){if("string"!=typeof e||!fr.test(e)||u.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");u.add(e)}n.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),(o.username||o.password)&&(n.auth=`${o.username}:${o.password}`),a){const e=n.path.split(":");n.socketPath=e[0],n.path=e[1]}if(n.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=i,e._originalHostOrSocketPath=a?n.socketPath:o.host;const t=s&&s.headers;if(s={...s,headers:{}},t)for(const[e,r]of Object.entries(t))s.headers[e.toLowerCase()]=r}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&n.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&o.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!i)&&(delete n.headers.authorization,delete n.headers.cookie,t||delete n.headers.host,n.auth=void 0)}n.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(n.auth).toString("base64")),p=e._req=f(n),e._redirects&&e.emit("redirect",e.url,p)}else p=e._req=f(n);n.timeout&&p.on("timeout",(()=>{wr(e,p,"Opening handshake has timed out")})),p.on("error",(t=>{null===p||p[cr]||(p=e._req=null,mr(e,t))})),p.on("response",(o=>{const i=o.headers.location,a=o.statusCode;if(i&&n.followRedirects&&a>=300&&a<400){if(++e._redirects>n.maxRedirects)return void wr(e,p,"Maximum redirects exceeded");let o;p.abort();try{o=new zt(i,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${i}`);return void mr(e,r)}pr(e,o,r,s)}else e.emit("unexpected-response",p,o)||wr(e,p,`Unexpected server response: ${o.statusCode}`)})),p.on("upgrade",((t,r,s)=>{if(e.emit("upgrade",t),e.readyState!==ur.CONNECTING)return;p=e._req=null;const o=t.headers.upgrade;if(void 0===o||"websocket"!==o.toLowerCase())return void wr(e,r,"Invalid Upgrade header");const i=Ft("sha1").update(h+Kt).digest("base64");if(t.headers["sec-websocket-accept"]!==i)return void wr(e,r,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let c;if(void 0!==a?u.size?u.has(a)||(c="Server sent an invalid subprotocol"):c="Server sent a subprotocol but none was requested":u.size&&(c="Server sent no subprotocol"),c)return void wr(e,r,c);a&&(e._protocol=a);const l=t.headers["sec-websocket-extensions"];if(void 0!==l){if(!d){return void wr(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=or(l)}catch(t){return void wr(e,r,"Invalid Sec-WebSocket-Extensions header")}const s=Object.keys(t);if(1!==s.length||s[0]!==qt.extensionName){return void wr(e,r,"Server indicated an extension that was not requested")}try{d.accept(t[qt.extensionName])}catch(t){return void wr(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[qt.extensionName]=d}e.setSocket(r,s,{allowSynchronousEvents:n.allowSynchronousEvents,generateMask:n.generateMask,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation})})),n.finishRequest?n.finishRequest(p,e):p.end()}function mr(e,t){e._readyState=ur.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function gr(e){return e.path=e.socketPath,Wt.connect(e)}function yr(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=Wt.isIP(e.host)?"":e.host),$t.connect(e)}function wr(e,t,r){e._readyState=ur.CLOSING;const s=new Error(r);Error.captureStackTrace(s,wr),t.setHeader?(t[cr]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(mr,e,s)):(t.destroy(s),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function _r(e,t,r){if(t){const r=Ht(t)?t.size:ir(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${hr[e.readyState]})`);process.nextTick(r,t)}}function br(e,t){const r=this[er];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[er]&&(r._socket.removeListener("data",Rr),process.nextTick(Tr,r._socket),1005===e?r.close():r.close(e,t))}function vr(){const e=this[er];e.isPaused||e._socket.resume()}function xr(e){const t=this[er];void 0!==t._socket[er]&&(t._socket.removeListener("data",Rr),process.nextTick(Tr,t._socket),t.close(e[Qt])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function Sr(){this[er].emitClose()}function Er(e,t){this[er].emit("message",e,t)}function kr(e){const t=this[er];t._autoPong&&t.pong(e,!this._isServer,tr),t.emit("ping",e)}function Or(e){this[er].emit("pong",e)}function Tr(e){e.resume()}function Pr(e){const t=this[er];t.readyState!==ur.CLOSED&&(t.readyState===ur.OPEN&&(t._readyState=ur.CLOSING,jr(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function jr(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),ar)}function Nr(){const e=this[er];let t;this.removeListener("close",Nr),this.removeListener("data",Rr),this.removeListener("end",Lr),e._readyState=ur.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[er]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",Sr),e._receiver.on("finish",Sr))}function Rr(e){this[er]._receiver.write(e)||this.pause()}function Lr(){const e=this[er];e._readyState=ur.CLOSING,e._receiver.end(),this.end()}function Cr(){const e=this[er];this.removeListener("error",Cr),this.on("error",tr),e&&(e._readyState=ur.CLOSING,this.destroy())}const{tokenChars:Ir}=We;var Br={parse:function(e){const t=new Set;let r=-1,s=-1,n=0;for(;n<e.length;n++){const o=e.charCodeAt(n);if(-1===s&&1===Ir[o])-1===r&&(r=n);else if(0===n||32!==o&&9!==o){if(44!==o)throw new SyntaxError(`Unexpected character at index ${n}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${n}`);-1===s&&(s=n);const o=e.slice(r,s);if(t.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);t.add(o),r=s=-1}}else-1===s&&-1!==r&&(s=n)}if(-1===r||-1!==s)throw new SyntaxError("Unexpected end of input");const o=e.slice(r,n);if(t.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);return t.add(o),t}};const Mr=S,Ar=k,{createHash:Ur}=x,Wr=Bt,$r=Re,Dr=Br,Fr=dr,{GUID:zr,kWebSocket:qr}=fe,Gr=/^[+/0-9A-Za-z]{22}==$/;var Vr=class extends Mr{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Fr,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=Ar.createServer(((e,t)=>{const r=Ar.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,s)=>{this.handleUpgrade(t,r,s,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(Hr,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(Hr,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{Hr(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,s){t.on("error",Yr);const n=e.headers["sec-websocket-key"],o=e.headers.upgrade,i=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void Kr(this,e,t,405,"Invalid HTTP method")}if(void 0===o||"websocket"!==o.toLowerCase()){return void Kr(this,e,t,400,"Invalid Upgrade header")}if(void 0===n||!Gr.test(n)){return void Kr(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(8!==i&&13!==i){return void Kr(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header")}if(!this.shouldHandle(e))return void Jr(t,400);const a=e.headers["sec-websocket-protocol"];let c=new Set;if(void 0!==a)try{c=Dr.parse(a)}catch(r){return void Kr(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const l=e.headers["sec-websocket-extensions"],h={};if(this.options.perMessageDeflate&&void 0!==l){const r=new $r(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=Wr.parse(l);e[$r.extensionName]&&(r.accept(e[$r.extensionName]),h[$r.extensionName]=r)}catch(r){return void Kr(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const o={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(o,((o,i,a,l)=>{if(!o)return Jr(t,i||401,a,l);this.completeUpgrade(h,n,c,e,t,r,s)}));if(!this.options.verifyClient(o))return Jr(t,401)}this.completeUpgrade(h,n,c,e,t,r,s)}completeUpgrade(e,t,r,s,n,o,i){if(!n.readable||!n.writable)return n.destroy();if(n[qr])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Jr(n,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Ur("sha1").update(t+zr).digest("base64")}`],c=new this.options.WebSocket(null,void 0,this.options);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,s):r.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),c._protocol=e)}if(e[$r.extensionName]){const t=e[$r.extensionName].params,r=Wr.format({[$r.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${r}`),c._extensions=e}this.emit("headers",a,s),n.write(a.concat("\r\n").join("\r\n")),n.removeListener("error",Yr),c.setSocket(n,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(c),c.on("close",(()=>{this.clients.delete(c),this._shouldEmitClose&&!this.clients.size&&process.nextTick(Hr,this)}))),i(c,s)}};function Hr(e){e._state=2,e.emit("close")}function Yr(){this.destroy()}function Jr(e,t,r,s){r=r||Ar.STATUS_CODES[t],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...s},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${Ar.STATUS_CODES[t]}\r\n`+Object.keys(s).map((e=>`${e}: ${s[e]}`)).join("\r\n")+"\r\n\r\n"+r)}function Kr(e,t,r,s,n){if(e.listenerCount("wsClientError")){const s=new Error(n);Error.captureStackTrace(s,Kr),e.emit("wsClientError",s,r,t)}else Jr(r,s,n)}var Xr=ae(Vr);const Zr="application",Qr="audio",es="font",ts="image",rs="message",ss="model",ns="text",os="video",is={[Zr]:["andrew-inset","atom+xml","atomcat+xml","atomdeleted+xml","atomsvc+xml","atsc-dwd+xml","atsc-held+xml","atsc-rsat+xml","automationml-aml+xml","automationml-amlx+zip","calendar+xml","ccxml+xml","cdfx+xml","cdmi-capability","cdmi-container","cdmi-domain","cdmi-object","cdmi-queue","cpl+xml","cwl","dash+xml","dash-patch+xml","davmount+xml","dssc+der","dssc+xml","emma+xml","emotionml+xml","epub+zip","exi","express","fdf","fdt+xml","font-tdpfr","geo+json","gml+xml","gzip","hyperstudio","inkml+xml","ipfix","its+xml","java-archive","json","ld+json","lgr+xml","lost+xml","mac-binhex40","mads+xml","manifest+json","marc","marcxml+xml","mathematica","mathml+xml","mbox","media-policy-dataset+xml","mediaservercontrol+xml","metalink4+xml","mets+xml","mmt-aei+xml","mmt-usd+xml","mods+xml","mp21","mp4","msword","mxf","n-quads","n-triples","node","octet-stream","oda","oebps-package+xml","ogg","oxps","p2p-overlay+xml","patch-ops-error+xml","pdf","pgp-encrypted","pgp-keys","pgp-signature","pkcs10","pkcs7-mime","pkcs7-signature","pkcs8","pkix-attr-cert","pkix-cert","pkix-crl","pkix-pkipath","pkixcmp","pls+xml","postscript","provenance+xml","prs.cww","prs.xsf+xml","pskc+xml","rdf+xml","reginfo+xml","relax-ng-compact-syntax","resource-lists+xml","resource-lists-diff+xml","rls-services+xml","route-apd+xml","route-s-tsid+xml","route-usd+xml","rpki-ghostbusters","rpki-manifest","rpki-roa","rtf","sbml+xml","scvp-cv-request","scvp-cv-response","scvp-vp-request","scvp-vp-response","sdp","senml+xml","sensml+xml","set-payment-initiation","set-registration-initiation","shf+xml","sieve","smil+xml","sparql-query","sparql-results+xml","sql","srgs","srgs+xml","sru+xml","ssml+xml","swid+xml","tei+xml","thraud+xml","timestamped-data","trig","ttml+xml","urc-ressheet+xml","urc-targetdesc+xml","voicexml+xml","wasm","watcherinfo+xml","widget","wsdl+xml","wspolicy+xml","x-x509-ca-cert","xcap-att+xml","xcap-caps+xml","xcap-diff+xml","xcap-el+xml","xcap-ns+xml","xenc+xml","xfdf","xhtml+xml","xliff+xml","xml","xml-dtd","xop+xml","xslt+xml","xv+xml","yang","yin+xml","zip"],[Qr]:["3gpp","aac","amr","basic","mobile-xmf","mp4","mpeg","ogg"],[es]:["collection","otf","ttf","woff","woff2"],[ts]:["aces","apng","avci","avcs","avif","bmp","cgm","dicom-rle","dpx","emf","fits","g3fax","gif","heic","heic-sequence","heif","heif-sequence","hej2k","hsj2","ief","jls","jp2","jpeg","jph","jphc","jpm","jpx","jxl","jxr","jxra","jxrs","jxs","jxsc","jxsi","jxss","ktx","ktx2","png","prs.btif","prs.pti","svg+xml","t38","tiff","tiff-fx","webp","wmf"],[rs]:["disposition-notification","global","global-delivery-status","global-disposition-notification","global-headers","rfc822"],[ss]:["3mf","gltf+json","gltf-binary","iges","jt","mesh","mtl","obj","prc","step+xml","step+zip","step-xml+zip","stl","u3d","vrml","x3d+fastinfoset","x3d+xml","x3d-vrml"],[ns]:["cache-manifest","calendar","css","csv","html","javascript","markdown","n3","plain","prs.lines.tag","richtext","rtf","sgml","shex","spdx","tab-separated-values","troff","turtle","uri-list","vcard","vtt","wgsl","xml"],[os]:["3gpp","3gpp2","h261","h263","h264","iso.segment","jpeg","mj2","mp2t","mp4","mpeg","ogg","quicktime"]},as=e=>e.startsWith(".")?e.slice(1):e;var cs=new Proxy({ez:[Zr,0],atom:[Zr,1],atomcat:[Zr,2],atomdeleted:[Zr,3],atomsvc:[Zr,4],dwd:[Zr,5],held:[Zr,6],rsat:[Zr,7],aml:[Zr,8],amlx:[Zr,9],xcs:[Zr,10],ccxml:[Zr,11],cdfx:[Zr,12],cdmia:[Zr,13],cdmic:[Zr,14],cdmid:[Zr,15],cdmio:[Zr,16],cdmiq:[Zr,17],cpl:[Zr,18],cwl:[Zr,19],mpd:[Zr,20],mpp:[Zr,21],davmount:[Zr,22],dssc:[Zr,23],xdssc:[Zr,24],emma:[Zr,25],emotionml:[Zr,26],epub:[Zr,27],exi:[Zr,28],exp:[Zr,29],fdf:[Zr,30],fdt:[Zr,31],pfr:[Zr,32],geojson:[Zr,33],gml:[Zr,34],gz:[Zr,35],stk:[Zr,36],ink:[Zr,37],inkml:[Zr,37],ipfix:[Zr,38],its:[Zr,39],jar:[Zr,40],war:[Zr,40],ear:[Zr,40],json:[Zr,41],map:[Zr,41],jsonld:[Zr,42],lgr:[Zr,43],lostxml:[Zr,44],hqx:[Zr,45],mads:[Zr,46],webmanifest:[Zr,47],mrc:[Zr,48],mrcx:[Zr,49],ma:[Zr,50],nb:[Zr,50],mb:[Zr,50],mathml:[Zr,51],mbox:[Zr,52],mpf:[Zr,53],mscml:[Zr,54],meta4:[Zr,55],mets:[Zr,56],maei:[Zr,57],musd:[Zr,58],mods:[Zr,59],m21:[Zr,60],mp21:[Zr,60],mp4:[Zr,61],mpg4:[Zr,61],mp4s:[Zr,61],m4p:[Zr,61],doc:[Zr,62],dot:[Zr,62],mxf:[Zr,63],nq:[Zr,64],nt:[Zr,65],cjs:[Zr,66],bin:[Zr,67],dms:[Zr,67],lrf:[Zr,67],mar:[Zr,67],so:[Zr,67],dist:[Zr,67],distz:[Zr,67],pkg:[Zr,67],bpk:[Zr,67],dump:[Zr,67],elc:[Zr,67],deploy:[Zr,67],exe:[Zr,67],dll:[Zr,67],deb:[Zr,67],dmg:[Zr,67],iso:[Zr,67],img:[Zr,67],msi:[Zr,67],msp:[Zr,67],msm:[Zr,67],buffer:[Zr,67],oda:[Zr,68],opf:[Zr,69],ogx:[Zr,70],oxps:[Zr,71],relo:[Zr,72],xer:[Zr,73],pdf:[Zr,74],pgp:[Zr,75],asc:[Zr,76],sig:[Zr,77],p10:[Zr,78],p7m:[Zr,79],p7c:[Zr,79],p7s:[Zr,80],p8:[Zr,81],ac:[Zr,82],cer:[Zr,83],crl:[Zr,84],pkipath:[Zr,85],pki:[Zr,86],pls:[Zr,87],ai:[Zr,88],eps:[Zr,88],ps:[Zr,88],provx:[Zr,89],cww:[Zr,90],xsf:[Zr,91],pskcxml:[Zr,92],rdf:[Zr,93],owl:[Zr,93],rif:[Zr,94],rnc:[Zr,95],rl:[Zr,96],rld:[Zr,97],rs:[Zr,98],rapd:[Zr,99],sls:[Zr,100],rusd:[Zr,101],gbr:[Zr,102],mft:[Zr,103],roa:[Zr,104],rtf:[Zr,105],sbml:[Zr,106],scq:[Zr,107],scs:[Zr,108],spq:[Zr,109],spp:[Zr,110],sdp:[Zr,111],senmlx:[Zr,112],sensmlx:[Zr,113],setpay:[Zr,114],setreg:[Zr,115],shf:[Zr,116],siv:[Zr,117],sieve:[Zr,117],smi:[Zr,118],smil:[Zr,118],rq:[Zr,119],srx:[Zr,120],sql:[Zr,121],gram:[Zr,122],grxml:[Zr,123],sru:[Zr,124],ssml:[Zr,125],swidtag:[Zr,126],tei:[Zr,127],teicorpus:[Zr,127],tfi:[Zr,128],tsd:[Zr,129],trig:[Zr,130],ttml:[Zr,131],rsheet:[Zr,132],td:[Zr,133],vxml:[Zr,134],wasm:[Zr,135],wif:[Zr,136],wgt:[Zr,137],wsdl:[Zr,138],wspolicy:[Zr,139],der:[Zr,140],crt:[Zr,140],pem:[Zr,140],xav:[Zr,141],xca:[Zr,142],xdf:[Zr,143],xel:[Zr,144],xns:[Zr,145],xenc:[Zr,146],xfdf:[Zr,147],xhtml:[Zr,148],xht:[Zr,148],xlf:[Zr,149],xml:[Zr,150],xsl:[Zr,150],xsd:[Zr,150],rng:[Zr,150],dtd:[Zr,151],xop:[Zr,152],xslt:[Zr,153],mxml:[Zr,154],xhvml:[Zr,154],xvml:[Zr,154],xvm:[Zr,154],yang:[Zr,155],yin:[Zr,156],zip:[Zr,157],"3gpp":[Qr,0],adts:[Qr,1],aac:[Qr,1],amr:[Qr,2],au:[Qr,3],snd:[Qr,3],mxmf:[Qr,4],m4a:[Qr,5],mp4a:[Qr,5],mpga:[Qr,6],mp2:[Qr,6],mp2a:[Qr,6],mp3:[Qr,6],m2a:[Qr,6],m3a:[Qr,6],oga:[Qr,7],ogg:[Qr,7],spx:[Qr,7],opus:[Qr,7],ttc:[es,0],otf:[es,1],ttf:[es,2],woff:[es,3],woff2:[es,4],exr:[ts,0],apng:[ts,1],avci:[ts,2],avcs:[ts,3],avif:[ts,4],bmp:[ts,5],dib:[ts,5],cgm:[ts,6],drle:[ts,7],dpx:[ts,8],emf:[ts,9],fits:[ts,10],g3:[ts,11],gif:[ts,12],heic:[ts,13],heics:[ts,14],heif:[ts,15],heifs:[ts,16],hej2:[ts,17],hsj2:[ts,18],ief:[ts,19],jls:[ts,20],jp2:[ts,21],jpg2:[ts,21],jpeg:[ts,22],jpg:[ts,22],jpe:[ts,22],jph:[ts,23],jhc:[ts,24],jpm:[ts,25],jpgm:[ts,25],jpx:[ts,26],jpf:[ts,26],jxl:[ts,27],jxr:[ts,28],jxra:[ts,29],jxrs:[ts,30],jxs:[ts,31],jxsc:[ts,32],jxsi:[ts,33],jxss:[ts,34],ktx:[ts,35],ktx2:[ts,36],png:[ts,37],btif:[ts,38],btf:[ts,38],pti:[ts,39],svg:[ts,40],svgz:[ts,40],t38:[ts,41],tif:[ts,42],tiff:[ts,42],tfx:[ts,43],webp:[ts,44],wmf:[ts,45],"disposition-notification":[rs,0],u8msg:[rs,1],u8dsn:[rs,2],u8mdn:[rs,3],u8hdr:[rs,4],eml:[rs,5],mime:[rs,5],"3mf":[ss,0],gltf:[ss,1],glb:[ss,2],igs:[ss,3],iges:[ss,3],jt:[ss,4],msh:[ss,5],mesh:[ss,5],silo:[ss,5],mtl:[ss,6],obj:[ss,7],prc:[ss,8],stpx:[ss,9],stpz:[ss,10],stpxz:[ss,11],stl:[ss,12],u3d:[ss,13],wrl:[ss,14],vrml:[ss,14],x3db:[ss,15],x3d:[ss,16],x3dz:[ss,16],x3dv:[ss,17],appcache:[ns,0],manifest:[ns,0],ics:[ns,1],ifb:[ns,1],css:[ns,2],csv:[ns,3],html:[ns,4],htm:[ns,4],shtml:[ns,4],js:[ns,5],mjs:[ns,5],md:[ns,6],markdown:[ns,6],n3:[ns,7],txt:[ns,8],text:[ns,8],conf:[ns,8],def:[ns,8],list:[ns,8],log:[ns,8],in:[ns,8],ini:[ns,8],dsc:[ns,9],rtx:[ns,10],sgml:[ns,12],sgm:[ns,12],shex:[ns,13],spdx:[ns,14],tsv:[ns,15],t:[ns,16],tr:[ns,16],roff:[ns,16],man:[ns,16],me:[ns,16],ms:[ns,16],ttl:[ns,17],uri:[ns,18],uris:[ns,18],urls:[ns,18],vcard:[ns,19],vtt:[ns,20],wgsl:[ns,21],"3gp":[os,0],"3g2":[os,1],h261:[os,2],h263:[os,3],h264:[os,4],m4s:[os,5],jpgv:[os,6],mj2:[os,7],mjp2:[os,7],ts:[os,8],m2t:[os,8],m2ts:[os,8],mts:[os,8],mp4v:[os,9],mpeg:[os,10],mpg:[os,10],mpe:[os,10],m1v:[os,10],m2v:[os,10],ogv:[os,11],qt:[os,12],mov:[os,12]},{has:(e,t)=>e.hasOwnProperty(as(t)),get:(e,t)=>{const r=e[as(t)];return r&&`${r[0]}/${is[r[0]][r[1]]}`}});const{min:ls}=Math,hs=/^bytes=(\d+)-(\d*)/;const fs="apply",us="ownKeys",ds="destruct";var ps=!1;const{ArrayBuffer:ms,Atomics:gs,Promise:ys}=globalThis,{isArray:ws}=Array,{create:_s,getPrototypeOf:bs,values:vs}=Object,xs=bs(Int32Array);_s(gs);const Ss="array",Es="function",ks="null",Os="number",Ts="object",Ps="string",js="symbol",Ns="undefined";let Rs=0;const Ls=new Map,Cs=new Map,Is=e=>Cs.get(e),Bs=e=>{if(!Ls.has(e)){let t;for(;Cs.has(t=Rs++););Ls.set(e,t),Cs.set(t,e)}return Ls.get(e)};var Ms=Object.fromEntries([Ss,"bigint","boolean",Es,ks,Os,Ts,Ps,js,Ns].map(((e,t)=>[e,t])));const{[us]:As}=Reflect,Us=new Map(As(Symbol).filter((e=>typeof Symbol[e]===js)).map((e=>[Symbol[e],e]))),Ws=e=>Us.get(e)||`.${Symbol.keyFor(e)||""}`,$s=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(`%c${String(t)}`,"font-weight:bold","collected"),e(t)})),Ds=Object.create(null),{addEventListener:Fs}=EventTarget.prototype,zs=new WeakMap;Reflect.defineProperty(EventTarget.prototype,"addEventListener",{value(e,t,...r){const s=r.at(0)?.invoke;if(s){let t=zs.get(this);t||(t=new Map,zs.set(this,t)),t.set(e,[].concat(s)),delete r[0].invoke}return Fs.call(this,e,t,...r)}});const{isArray:qs}=Array,Gs=e=>{const t=typeof e;switch(t){case Ts:return null===e?[Ms[ks],e]:e===globalThis?[Ms[Ts],null]:qs(e)?[Ms[Ss],Bs(e)]:[Ms[Ts],e instanceof xs?e:Bs(e)];case Es:return[Ms[Es],Bs(e)];case js:return[Ms[js],Ws(e)];default:return[Ms[t],e]}};var Vs=(e,t)=>{const r=new Map,s=e=>{r.delete(e),t(ds,e)},n=([e,o])=>{switch(e){case Ms[Ts]:if(null===o)return globalThis;if(typeof o===Os)return Is(o);if(!(o instanceof xs))for(const e in o)o[e]=n(o[e]);return o;case Ms[Ss]:return typeof o===Os?Is(o):o.map(n);case Ms[Es]:switch(typeof o){case Os:return Is(o);case Ps:{let e=r.get(o)?.deref();return e||(e=((e,t,{debug:r,handler:s,return:n,token:o=e}=Ds)=>{const i=n||new Proxy(e,s||Ds),a=[i,[t,e,!!r]];return!1!==o&&a.push(o),$s.register(...a),i})(o,s,{token:!1,return:function(...e){return e.length&&e[0]instanceof Event&&(e=>{const{currentTarget:t,target:r,type:s}=e,n=zs.get(t||r)?.get(s);if(n)for(const t of n)e[t]()})(e[0]),t(fs,o,Gs(this),e.map(Gs)).then(n)}}),r.set(o,new WeakRef(e))),e}}case Ms[js]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of Us)if(r===e)return t})(o);default:return o}},o=t=>import(e(t));return(e,t,...r)=>{if(e===ds)(e=>{const[t,r]=typeof e===Os?[Cs,Ls]:[Ls,Cs],s=t.has(e);s&&(r.delete(t.get(e)),t.delete(e))})(t);else{const s=Reflect[e],i=null==t?globalThis:Is(t);switch(e){case"defineProperty":{const[e,t]=r.map(n);return Gs(s(i,e,t))}case"getOwnPropertyDescriptor":{const e=s(i,...r.map(n));if(e){const{get:t,set:r,value:s}=e;t&&(e.get=Gs(t)),r&&(e.set=Gs(r)),s&&(e.value=Gs(s))}return[Ms[e?Ts:Ns],e]}case us:return[Ms[Ss],s(i).map(Gs)];case"get":if(null==t&&"import"===r[0][1])return Gs(o);default:return((e,t,r)=>Gs(e(t,...r.map(n))))(s,i,r)}}}};const Hs=String,{parse:Ys,stringify:Js}=JSON,Ks={data:null,stopImmediatePropagation(){},preventDefault(){}};var Xs=(e,t)=>{const{parse:r=Ys,stringify:s=Js}=t,n=new Map;let[o,i,a,c]=["",!0,0,null];return{onclose:()=>{for(const[e,t]of n)t();n.clear(),[o,i,a,c]=["",!0,0,null]},onmessage:async l=>{try{const h=r(Hs(l));if(Ks.data=h,((e,t)=>{const{data:r}=e,s=ws(r)&&(r.at(0)===t||0===r.at(1)&&!t);return s&&(e.stopImmediatePropagation(),e.preventDefault()),s})(Ks,o))if(i)i=!1,[o]=h,c=Vs(t?.import||Hs,((t,r,...i)=>{let c,l;return t===fs&&(({promise:c,resolve:l}=ys.withResolvers()),n.set(a,l),i.push(a++)),e.send(s([o,null,[t,r,...i]])),c})),e.send("");else{const[t,r,i,a,...l]=h;if(null==r)n.get(a)(...l),n.delete(a);else{let t;try{ps,t=await c(i,a,...l)}catch(e){t=e}e.send(s([o,r,t]))}}}catch(e){}}}};const[...Zs]=process.argv.slice(2),Qs={_:"",get $(){return this._||(this._=process.cwd())}},en=Zs.at(0)||a(Qs.$,"package.json");if("--help"===en||!t(en)){const e=+("--help"!==en);e&&console.error("[1mUnable to parse package.json[0m\n"),console[e?"error":"log"]("\nworkerful [options]\n\n[options]\n--help        # this message\npackage.json  # the package.json file at the root\n              # of your workerful project\n  ".trim()),process.exit(e)}const tn=oe(r(en).toString("utf-8"));const{parse:rn,stringify:sn}=JSON,{keys:nn}=Object,on=String,an="string",cn={},ln="object",hn=(e,t)=>t,fn=e=>e instanceof on?on(e):e,un=(e,t)=>typeof t===an?new on(t):t,dn=(e,t,r,s)=>{const n=[];for(let o=nn(r),{length:i}=o,a=0;a<i;a++){const i=o[a],c=r[i];if(c instanceof on){const o=e[c];typeof o!==ln||t.has(o)?r[i]=s.call(r,i,o):(t.add(o),r[i]=cn,n.push({k:i,a:[e,t,o,s]}))}else r[i]!==cn&&(r[i]=s.call(r,i,c))}for(let{length:e}=n,t=0;t<e;t++){const{k:e,a:o}=n[t];r[e]=s.call(r,e,dn.apply(null,o))}return r},pn=(e,t,r)=>{const s=on(t.push(r)-1);return e.set(r,s),s},mn="object"==typeof self?self:globalThis,gn=e=>((e,t)=>{const r=(t,r)=>(e.set(r,t),t),s=n=>{if(e.has(n))return e.get(n);const[o,i]=t[n];switch(o){case 0:case-1:return r(i,n);case 1:{const e=r([],n);for(const t of i)e.push(s(t));return e}case 2:{const e=r({},n);for(const[t,r]of i)e[s(t)]=s(r);return e}case 3:return r(new Date(i),n);case 4:{const{source:e,flags:t}=i;return r(new RegExp(e,t),n)}case 5:{const e=r(new Map,n);for(const[t,r]of i)e.set(s(t),s(r));return e}case 6:{const e=r(new Set,n);for(const t of i)e.add(s(t));return e}case 7:{const{name:e,message:t}=i;return r(new mn[e](t),n)}case 8:return r(BigInt(i),n);case"BigInt":return r(Object(BigInt(i)),n)}return r(new mn[o](i),n)};return s})(new Map,e)(0),yn="",{toString:wn}={},{keys:_n}=Object,bn=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const r=wn.call(e).slice(8,-1);switch(r){case"Array":return[1,yn];case"Object":return[2,yn];case"Date":return[3,yn];case"RegExp":return[4,yn];case"Map":return[5,yn];case"Set":return[6,yn]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},vn=([e,t])=>0===e&&("function"===t||"symbol"===t),xn=(e,{json:t,lossy:r}={})=>{const s=[];return((e,t,r,s)=>{const n=(e,t)=>{const n=s.push(e)-1;return r.set(t,n),n},o=s=>{if(r.has(s))return r.get(s);let[i,a]=bn(s);switch(i){case 0:{let t=s;switch(a){case"bigint":i=8,t=s.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+a);t=null;break;case"undefined":return n([-1],s)}return n([i,t],s)}case 1:{if(a)return n([a,[...s]],s);const e=[],t=n([i,e],s);for(const t of s)e.push(o(t));return t}case 2:{if(a)switch(a){case"BigInt":return n([a,s.toString()],s);case"Boolean":case"Number":case"String":return n([a,s.valueOf()],s)}if(t&&"toJSON"in s)return o(s.toJSON());const r=[],c=n([i,r],s);for(const t of _n(s))!e&&vn(bn(s[t]))||r.push([o(t),o(s[t])]);return c}case 3:return n([i,s.toISOString()],s);case 4:{const{source:e,flags:t}=s;return n([i,{source:e,flags:t}],s)}case 5:{const t=[],r=n([i,t],s);for(const[r,n]of s)(e||!vn(bn(r))&&!vn(bn(n)))&&t.push([o(r),o(n)]);return r}case 6:{const t=[],r=n([i,t],s);for(const r of s)!e&&vn(bn(r))||t.push(o(r));return r}}const{message:c}=s;return n([i,{name:a,message:c}],s)};return o})(!(t||r),!!t,new Map,s)(e),s},{parse:Sn,stringify:En}=JSON,kn={json:!0,lossy:!0};var On={json:JSON,circular:{parse:(e,t)=>{const r=rn(e,un).map(fn),s=r[0],n=t||hn,o=typeof s===ln&&s?dn(r,new Set,s,n):s;return n.call({"":o},"",o)},stringify:(e,t,r)=>{const s=t&&typeof t===ln?(e,r)=>""===e||-1<t.indexOf(e)?r:void 0:t||hn,n=new Map,o=[],i=[];let a=+pn(n,o,s.call({"":e},"",e)),c=!a;for(;a<o.length;)c=!0,i[a]=sn(o[a++],l,r);return"["+i.join(",")+"]";function l(e,t){if(c)return c=!c,t;const r=s.call(this,e,t);switch(typeof r){case ln:if(null===r)return r;case an:return n.get(r)||pn(n,o,r)}return r}}},structured:{parse:e=>gn(Sn(e)),stringify:e=>En(xn(e,kn))}};const Tn=tn.workerful||(tn.workerful={ip:"localhost",port:0,centered:!0,kiosk:!1,window:{}}),{WORKERFUL_CENTERED:Pn=!!Tn.centered,WORKERFUL_IP:jn=Tn.ip||"localhost",WORKERFUL_PORT:Nn=Tn.port||0,WORKERFUL_KIOSK:Rn=Tn.kiosk||!1,WORKERFUL_SERIALIZER:Ln=Tn.serializer||"json",WORKERFUL_HEADLESS:Cn=!1,DEBUG:In=!1}=process.env,Bn=crypto.randomUUID(),Mn=Ln.toLowerCase();if(!(Mn in On))throw new Error(`Serializer ${Ln} is not json, circular or structured`);let An,Un=Promise.resolve();const Wn=await(async(e,t)=>{const r=tn.workerful?.server,s=r?(await import(c(Qs.$,r))).default:((e,t={})=>function r({method:s,url:n,headers:{range:o}={}},i){if("GET"!==s)return!1;const a=n.indexOf("?");-1<a&&(n=n.slice(0,a)),n.endsWith("/")&&(n+="index.html");const c=R(e+n,{throwIfNoEntry:!1});if(!c)return!1;if(c.isFile()){const{size:r}=c,s=cs[j(n)];if(!s)return!1;const a=[],l=[N(e,"."+n)];try{if(hs.test(o||"")){const{$1:e,$2:n}=RegExp,o=parseInt(e,10)||0;if(o>=r)throw 416;let i=parseInt(n,10)||0;(!i||i>=r)&&(i=ls(r,o+1048576)-1),a.push(206,{...t,"Accept-Range":"bytes","Content-Range":`bytes ${o}-${i}/${r}`,"Content-Length":i+1-o,"Content-Type":s}),l.push({start:o,end:i})}else a.push(200,{...t,"Content-Length":r,"Content-Type":s});return i.writeHead(...a),L(...l).pipe(i),!0}catch(e){return!1}}return!!c.isDirectory()&&r({method:"GET",url:n+"/"},i)})(a(l(en),"public")),n=w((async(e,r)=>{try{if(t(e,r))return;if(await s(e,r))return;r.writeHead(404),r.end()}catch(e){console.error(e),r.writeHead(500),r.end()}}));return((e={})=>{const{bun:t,wss:r}=e;if(t){const t=new WeakMap;return{open(r){t.set(r,Xs(r,e))},close(e,r,s){t.get(e).onclose(s)},message(e,r){t.get(e).onmessage(r)}}}r&&r.on("connection",(t=>{const{onclose:r,onmessage:s}=Xs(t,e);t.prependListener("close",r),t.prependListener("message",s)}))})({wss:new Xr({server:n}),...e}),n})(On[Mn],((e,t)=>{const{url:r,method:n,headers:o}=e;if("GET"===n){if("/workerful"===r){let e,r={serializer:Mn};return e=o.referer.endsWith("/workerful.js")?`globalThis.workerful=${ie(r)};\nconst e="5a9ebad2-e830-422a-b35b-10dec38891fc",t="="+e,r="-"+e,n=t+"-ws",s=r+"-ws",o="apply",a="construct",c="defineProperty",i="deleteProperty",l="get",u="getOwnPropertyDescriptor",f="getPrototypeOf",p="has",y="isExtensible",g="ownKeys",w="preventExtensions",h="set",d="setPrototypeOf";var b=Object.freeze({__proto__:null,APPLY:o,CONSTRUCT:a,DEFINE_PROPERTY:c,DELETE_PROPERTY:i,GET:l,GET_OWN_PROPERTY_DESCRIPTOR:u,GET_PROTOTYPE_OF:f,HAS:p,IS_EXTENSIBLE:y,OWN_KEYS:g,PREVENT_EXTENSION:w,SET:h,SET_PROTOTYPE_OF:d});const v="destruct",{ArrayBuffer:m,Atomics:E,Promise:O}=globalThis,{isArray:T}=Array,{create:S,getPrototypeOf:P,values:k}=Object,x=P(Int32Array),A=S(E),R=({currentTarget:e,type:t,origin:r,lastEventId:n,source:s,ports:o},a)=>e.dispatchEvent(new MessageEvent(t,{data:a,origin:r,lastEventId:n,source:s,ports:o})),j=()=>O.withResolvers();let M=0;const I=new Map,_=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&I.set(this,[M++,0,j()])}},N=new WeakSet,$=e=>(N.add(e),e),B=(e,t)=>{const{data:r}=e,n=T(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},W=e=>null!==e&&"object"==typeof e&&!N.has(e),D=new WeakMap,Y=(e,t,r)=>{if(I.has(e))t.set(e,I.get(e)[0]);else if(!(e instanceof x||e instanceof m))for(const n of k(e))W(n)&&!r.has(n)&&(r.add(n),Y(n,t,r))},L=(...e)=>({value:new O((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),z=(e,t)=>{const r=I.get(e),[n,s,{promise:o}]=r;return r[1]=t,[n,o]};let{BigInt64Array:J,Int32Array:C,SharedArrayBuffer:F,addEventListener:U,postMessage:H}=globalThis,G=!0,K=e=>e,X=!1;const q=j();try{new F(4),A.waitAsync||(A.waitAsync=L),q.resolve()}catch(e){const t=H,r=U,n=[];let s="",o="";F=class extends m{},J=_(J,F),C=_(C,F),K=$,X=!0,A.notify=(e,r)=>{const[n]=(e=>D.get(e))(e);return t([s,1,e,n,r]),0},A.waitAsync=(...e)=>{const[t,r]=z(...e);return{value:r}},A.wait=(e,t,...r)=>{const[n]=z(e,t,...r),a=new XMLHttpRequest;a.responseType="json",a.open("POST",\`\${o}?sabayon\`,!1),a.setRequestHeader("Content-Type","application/json"),a.send(\`["\${s}",\${n},\${t}]\`);const{response:c}=a;I.delete(e);for(let t=0;t<c.length;t++)e[t]=c[t];return"ok"},r("message",(e=>{if(B(e,s)){const[t,r,...n]=e.data;switch(r){case 0:s=t,o=n.at(0)?.serviceWorker||"",o||(A.wait=null,q.resolve());break;case 1:((e,t,r)=>{for(const[n,[s,o,{resolve:a}]]of I)if(t===s&&r===o){for(let t=0;t<e.length;t++)n[t]=e[t];I.delete(n),a("ok");break}})(...n);break;case 2:((e,t,r)=>{for(const[r,n]of t)D.set(r,[n,e.currentTarget]);R(e,r)})(e,...n);break;case 3:q.resolve()}}else if(G){const{currentTarget:t,type:r,origin:s,lastEventId:o,source:a,ports:c}=e;n.push([{currentTarget:t,type:r,origin:s,lastEventId:o,source:a,ports:c},e.data])}})),U=(e,...t)=>{if(r(e,...t),n.length)for(const e of n.splice(0))R(...e)},H=(e,...r)=>t(((e,t)=>{const r=new Map;return W(t)&&Y(t,r,new Set),r.size?[e,2,r,t]:t})(s,e),...r)}await q.promise,G=!1;const{BYTES_PER_ELEMENT:V}=Int32Array,{BYTES_PER_ELEMENT:Q}=Uint16Array,{notify:Z}=A,ee=new TextDecoder("utf-16"),te=new WeakSet,re=(...e)=>(te.add(e),e);let ne="";const se=(e,t,r,n)=>{const[s]=n,o=r.get(s);if(!o)throw new Error(\`Unknown proxy.\${s}()\`);e(o,t,n)};let oe=0;const ae=([e,t,r,n,s,o,a,c,i],l)=>(...u)=>{let f=""!==ne,p=0;f&&"="!==ne[0]&&"-"!==ne[0]&&(p=((e,t)=>setTimeout(console.warn,3e3,\`💀🔒 - proxy.\${e}() in proxy.\${t}()\`))(l,ne));const y=oe++,g=[];te.has(u.at(-1)||g)&&te.delete(g=u.pop());const w=r(c?u.map(c):u);let h=t(2*V);return a([e,2,l,y,h,w,n],{transfer:g}),i(h,0).value.then((()=>{f&&clearTimeout(p);const r=h[1];if(!r)return;const n=Q*r;return h=t(n+n%V),a([e,1,y,h]),i(h,0).value.then((()=>{const e=new Uint16Array(h.buffer),t=o?e.subarray(0,r):e.slice(0,r);return s(ee.decode(t))}))}))},ce=(e,t)=>new Proxy(t,{get:(t,r)=>{let n;return"then"!==r&&(n=t.get(r),n||(n=ae(e,r),t.set(r,n))),n},set:(e,t,r)=>"then"!==t&&!!e.set(t,r)}),{wait:ie,waitAsync:le}=A;var ue=({parse:e,stringify:t,transform:r,interrupt:n}=JSON)=>{const s=((e,t)=>async(r,n,[s,o,a,c,i])=>{i&&(ne=s);try{const s=await r(...c);if(void 0!==s){const r=e(t?t(s):s);n.set(o,r),a[1]=r.length}}finally{i&&(ne=""),a[0]=1,Z(a,0)}})(t,r),o=j(),a=new Map,c=new Map;let i="",l=ie;if(ie&&n){const{handler:e,timeout:t=42}=n;l=(r,n,s)=>{for(;"timed-out"===(s=ie(r,n,0,t));)e();return s}}return U("message",(t=>{if(B(t,i)){const[n,u,...f]=t.data;switch(u){case 0:{const t=!!ie;i=n,o.resolve({polyfill:X,sync:t,transfer:re,proxy:ce([i,e=>new C(new F(e)),K,t,e,X,H,r,t?(...e)=>({value:{then:t=>t(l(...e))}}):le],a)});break}case 2:a.size?se(s,c,a,f):setTimeout(se,0,s,c,a,f);break;case 1:((e,[t,r])=>{const n=e.get(t);e.delete(t);for(let e=new Uint16Array(r.buffer),t=0,{length:s}=n;t<s;t++)e[t]=n.charCodeAt(t);Z(r,0)})(c,f)}}})),o.promise};const fe="array",pe="function",ye="null",ge="number",we="object",he="symbol",de="undefined";function be(){return this}const ve=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(\`Held value \${String(t)} not relevant anymore\`),e(t)})),me=Object.create(null),{Object:Ee,Proxy:Oe,Reflect:Te}=globalThis,{isArray:Se}=Array,{ownKeys:Pe}=Te,{create:ke,hasOwn:xe,values:Ae}=Ee,Re=(e,t)=>t===fe?e[0]:t===pe?e():t===we?e.$:e,je=(e,t,r,n)=>{const s={type:{value:t}},o=xe(e,"valueOf");for(const a of Ae(b)){let c=n(e[a]||Te[a]);if(o&&a===l){const{valueOf:n}=e,{value:s}=c;c={value(e,o,...a){return o===r?n.call(this,Re(e,t)):s.call(this,e,o,...a)}}}s[a]=c}return ke(e,s)},Me=(e,t,r,n=e)=>{if(n===e)switch(typeof e){case we:case de:n||(n=!1);case pe:break;default:n=!1,t===e&&(t=Ee(e))}const s=new Oe(t,r),{destruct:o}=r;return o?((e,t,{debug:r,handler:n,return:s,token:o=e}=me)=>{const a=s||new Proxy(e,n||me),c=[a,[t,e,!!r]];return!1!==o&&c.push(o),ve.register(...c),a})(e,o,{token:n,return:s}):s},Ie=e=>t=>{const r=typeof t;return r===we?t?e.get(t)?.[0]??(e=>Se(e)?fe:we)(t):ye:r},_e=e=>t=>{let r=typeof t;switch(r){case we:if(!t){r=ye;break}case pe:const n=e.get(t);n&&([r,t]=n)}return[r,t]},Ne=e=>((e=>{ve.unregister(e)})(e),e);var $e=e=>{const t=new WeakMap,r=Symbol(),n={},s=(e,r,n)=>(t.set(e,[r,n]),e),o={proxy:n,release:Ne,pair:_e(t),typeOf:Ie(t),isProxy:e=>t.has(e),valueOf:e=>e[r]??e.valueOf()};for(const t of Pe(e)){if(xe(o,t))continue;const a=e[t];switch(t){case fe:{const e=je(a,t,r,(e=>({value([t],...r){return e.call(this,t,...r)}})));n[t]=(t,...r)=>s(Me(t,[t],e,...r),fe,t);break}case pe:{const e=je(a,t,r,(e=>({value(t,...r){return e.call(this,t(),...r)}})));n[t]=(t,...r)=>{return s(Me(t,(n=t,be.bind(n)),e,...r),pe,t);var n};break}case we:{const e=je(a,t,r,(e=>({value({$:t},...r){return e.call(this,t,...r)}})));n[t]=(t,...r)=>s(Me(t,{$:t},e,...r),we,t);break}default:{const e=je(a,t,r,(e=>({value:e})));n[t]=(r,...n)=>s(Me(r,r,e,...n),t,r);break}}}return o};let Be=0;const We=new Map,De=new Map,Ye=e=>De.get(e),Le=e=>{if(!We.has(e)){let t;for(;De.has(t=Be++););We.set(e,t),De.set(t,e)}return We.get(e)};var ze=Object.fromEntries([fe,"bigint","boolean",pe,ye,ge,we,"string",he,de].map(((e,t)=>[e,t])));const{[g]:Je}=Reflect,Ce=new Map(Je(Symbol).filter((e=>typeof Symbol[e]===he)).map((e=>[Symbol[e],e]))),Fe=e=>Ce.get(e)||\`.\${Symbol.keyFor(e)||""}\`,{isArray:Ue}=Array,{[o]:He}=Reflect;var Ge=(e,t)=>{const r=new Map,n=(e,t)=>{let n=r.get(e)?.deref();return n||r.set(e,new WeakRef(n=t(e))),n},s=([e,t])=>{switch(e){case ze[we]:return null==t?globalThis:typeof t===ge?n(t,T.object):t;case ze[fe]:return typeof t===ge?n(t,T.array):t;case ze[pe]:return typeof t===ge?n(t,T.function):Ye(parseInt(t));case ze[he]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of Ce)if(r===e)return t})(t);default:return t}},b=e=>{let[r,n]=P(e);switch(r){case we:if(n==globalThis||null==n)n=null;else if(typeof n===we&&!(n instanceof x))if(n=t(n),Ue(n))n=n.map(b);else for(const e in n)n[e]=b(n[e]);return[ze[we],n];case fe:return[ze[fe],typeof n===ge?n:t(n).map(b)];case pe:return[ze[pe],typeof n===pe?String(Le(t(n))):n];case he:return[ze[he],Fe(e)];default:return[ze[r],n]}},m=(...t)=>s(e(...t)),E={[c]:(e,t,r)=>m(c,e,b(t),b(r)),[i]:(e,t)=>m(i,e,b(t)),[l]:(e,t)=>m(l,e,b(t)),[f]:e=>m(f,e),[u]:(e,t)=>{const r=m(u,e,b(t));if(r){const{get:e,set:t,value:n}=r;e&&(r.get=s(e)),t&&(r.set=s(t)),n&&(r.value=s(n))}return r},[p]:(e,t)=>m(p,e,b(t)),[y]:e=>m(y,e),[g]:e=>m(g,e).map(s),[w]:e=>m(w,e),[h]:(e,t,r)=>m(h,e,b(t),b(r)),[d]:(e,t)=>m(d,e,b(t)),[v](t){r.delete(t),e(v,t)}},O={[we]:E,[fe]:E,[pe]:{...E,[o]:(e,...t)=>m(o,e,...t.map(b)),[a]:(e,...t)=>m(a,e,...t.map(b))}},{proxy:T,isProxy:S,pair:P}=$e(O);return{isProxy:S,global:T.object(null),method:async(e,t,...r)=>{const n=parseInt(t);switch(e){case o:{const[e,t]=r;return b(await He(Ye(n),s(e),t.map(s)))}case v:(e=>{const[t,r]=typeof e===ge?[De,We]:[We,De],n=t.has(e);n&&(r.delete(t.get(e)),t.delete(e))})(n)}}}};const{parse:Ke,stringify:Xe}=JSON,{keys:qe}=Object,Ve=String,Qe="string",Ze={},et="object",tt=(e,t)=>t,rt=e=>e instanceof Ve?Ve(e):e,nt=(e,t)=>typeof t===Qe?new Ve(t):t,st=(e,t,r,n)=>{const s=[];for(let o=qe(r),{length:a}=o,c=0;c<a;c++){const a=o[c],i=r[a];if(i instanceof Ve){const o=e[i];typeof o!==et||t.has(o)?r[a]=n.call(r,a,o):(t.add(o),r[a]=Ze,s.push({k:a,a:[e,t,o,n]}))}else r[a]!==Ze&&(r[a]=n.call(r,a,i))}for(let{length:e}=s,t=0;t<e;t++){const{k:e,a:o}=s[t];r[e]=n.call(r,e,st.apply(null,o))}return r},ot=(e,t,r)=>{const n=Ve(t.push(r)-1);return e.set(r,n),n},at="object"==typeof self?self:globalThis,ct=e=>((e,t)=>{const r=(t,r)=>(e.set(r,t),t),n=s=>{if(e.has(s))return e.get(s);const[o,a]=t[s];switch(o){case 0:case-1:return r(a,s);case 1:{const e=r([],s);for(const t of a)e.push(n(t));return e}case 2:{const e=r({},s);for(const[t,r]of a)e[n(t)]=n(r);return e}case 3:return r(new Date(a),s);case 4:{const{source:e,flags:t}=a;return r(new RegExp(e,t),s)}case 5:{const e=r(new Map,s);for(const[t,r]of a)e.set(n(t),n(r));return e}case 6:{const e=r(new Set,s);for(const t of a)e.add(n(t));return e}case 7:{const{name:e,message:t}=a;return r(new at[e](t),s)}case 8:return r(BigInt(a),s);case"BigInt":return r(Object(BigInt(a)),s)}return r(new at[o](a),s)};return n})(new Map,e)(0),it="",{toString:lt}={},{keys:ut}=Object,ft=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const r=lt.call(e).slice(8,-1);switch(r){case"Array":return[1,it];case"Object":return[2,it];case"Date":return[3,it];case"RegExp":return[4,it];case"Map":return[5,it];case"Set":return[6,it]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},pt=([e,t])=>0===e&&("function"===t||"symbol"===t),yt=(e,{json:t,lossy:r}={})=>{const n=[];return((e,t,r,n)=>{const s=(e,t)=>{const s=n.push(e)-1;return r.set(t,s),s},o=n=>{if(r.has(n))return r.get(n);let[a,c]=ft(n);switch(a){case 0:{let t=n;switch(c){case"bigint":a=8,t=n.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);t=null;break;case"undefined":return s([-1],n)}return s([a,t],n)}case 1:{if(c)return s([c,[...n]],n);const e=[],t=s([a,e],n);for(const t of n)e.push(o(t));return t}case 2:{if(c)switch(c){case"BigInt":return s([c,n.toString()],n);case"Boolean":case"Number":case"String":return s([c,n.valueOf()],n)}if(t&&"toJSON"in n)return o(n.toJSON());const r=[],i=s([a,r],n);for(const t of ut(n))!e&&pt(ft(n[t]))||r.push([o(t),o(n[t])]);return i}case 3:return s([a,n.toISOString()],n);case 4:{const{source:e,flags:t}=n;return s([a,{source:e,flags:t}],n)}case 5:{const t=[],r=s([a,t],n);for(const[r,s]of n)(e||!pt(ft(r))&&!pt(ft(s)))&&t.push([o(r),o(s)]);return r}case 6:{const t=[],r=s([a,t],n);for(const r of n)!e&&pt(ft(r))||t.push(o(r));return r}}const{message:i}=n;return s([a,{name:c,message:i}],n)};return o})(!(t||r),!!t,new Map,n)(e),n},{parse:gt,stringify:wt}=JSON,ht={json:!0,lossy:!0};var dt={json:JSON,circular:{parse:(e,t)=>{const r=Ke(e,nt).map(rt),n=r[0],s=t||tt,o=typeof n===et&&n?st(r,new Set,n,s):n;return s.call({"":o},"",o)},stringify:(e,t,r)=>{const n=t&&typeof t===et?(e,r)=>""===e||-1<t.indexOf(e)?r:void 0:t||tt,s=new Map,o=[],a=[];let c=+ot(s,o,n.call({"":e},"",e)),i=!c;for(;c<o.length;)i=!0,a[c]=Xe(o[c++],l,r);return"["+a.join(",")+"]";function l(e,t){if(i)return i=!i,t;const r=n.call(this,e,t);switch(typeof r){case et:if(null===r)return r;case Qe:return s.get(r)||ot(s,o,r)}return r}}},structured:{parse:e=>ct(gt(e)),stringify:e=>wt(yt(e,ht))}};const{workerful:bt}=globalThis;delete globalThis.workerful;const{server:vt,window:mt}=await(async e=>{const o=await(async e=>{const n=await ue(e),{isProxy:s,global:o,method:a}=Ge(n.proxy[t],e?.transform||(e=>e));return n.proxy[r]=a,{...n,window:o,isWindowProxy:s}})(e),{isProxy:a,global:c,method:i}=Ge(o.proxy[n],e?.transform||(e=>e));return o.proxy[s]=i,{...o,server:c,isServerProxy:a}})(dt[bt.serializer]);export{vt as server,mt as window};\n`:`globalThis.workerful=${ie({...r,ws:An,secret:Bn,centered:"always"===Pn||ne(Pn)})};\n!function(){"use strict";const e="apply",t="ownKeys",r="destruct",n="5a9ebad2-e830-422a-b35b-10dec38891fc",s="="+n,o="-"+n,a=s+"-ws",c=o+"-ws";const{ArrayBuffer:i,Atomics:l,Promise:u}=globalThis,{isArray:f}=Array,{create:p,getPrototypeOf:g,values:d}=Object,h=g(Int32Array),y=p(l),w=()=>u.withResolvers();let m=0;const b=new Map,v=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&b.set(this,[m++,0,w()])}},k=new WeakSet,E=e=>(k.add(e),e),S=(e,t)=>{const{data:r}=e,n=f(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},M=e=>null!==e&&"object"==typeof e&&!k.has(e),A=new WeakMap,T=(e,t,r)=>{if(b.has(e))t.set(e,b.get(e)[0]);else if(!(e instanceof h||e instanceof i))for(const n of d(e))M(n)&&!r.has(n)&&(r.add(n),T(n,t,r))},j=(...e)=>({value:new u((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),O=(e,t,r)=>{for(const[r,n]of t)A.set(r,[n,e.currentTarget]);(({currentTarget:e,type:t,origin:r,lastEventId:n,source:s,ports:o},a)=>{e.dispatchEvent(new MessageEvent(t,{data:a,origin:r,lastEventId:n,source:s,ports:o}))})(e,r)};let{BigInt64Array:W,Int32Array:x,SharedArrayBuffer:I,Worker:R}=globalThis,U=e=>e,B=!1;const D=e=>({...e,type:"module"});try{new I(4),R=class extends R{constructor(e,t){super(e,D(t))}},y.waitAsync||(y.waitAsync=j)}catch(e){const t=crypto.randomUUID(),r=new Map,n=(e,t,r,...n)=>{e.addEventListener(t,r,...n)},s=({serviceWorker:e},s,o)=>{let a,c=!0;n(e,"message",(e=>{if(S(e,t)){const[n,s,o]=e.data,c=[s,o].join(","),i=e=>{r.delete(c),a.postMessage([t,s,o,e])},l=r.get(c);if(l)i(l);else{const{promise:e,resolve:t}=w();r.set(c,t),e.then(i)}}})),e.getRegistration(s).then((t=>t??e.register(s))).then((function t(r){c=c&&!!e.controller,a=r.installing||r.waiting||r.active,"activated"===a.state?c?o():location.reload():n(a,"statechange",(()=>t(r)),{once:!0})}))};U=E,B=!0,y.notify=(e,n)=>{const[s,o]=(e=>A.get(e))(e),a=[s,n].join(","),c=r.get(a);return c?c(e):r.set(a,e),o.postMessage([t,1,e,s,n]),0},y.waitAsync=(e,...t)=>{const[r,n]=((e,t)=>{const r=b.get(e),[n,s,{promise:o}]=r;return r[1]=t,[n,o]})(e,...t);return{value:n}},I=class extends i{},W=v(W,I),x=v(x,I);let o=null;R=class extends R{constructor(e,r){let a=r?.serviceWorker||"";if(a){if(a=new URL(a,location.href).href,r={...r,serviceWorker:a},!o){const{promise:e,resolve:t}=w();s(navigator,a,t),o=e}o.then((()=>super.postMessage([t,3])))}super(e,D(r)),super.postMessage([t,0,r]),n(this,"message",(e=>{if(S(e,t)){const[t,r,...n]=e.data;switch(r){case 1:((e,t,r)=>{for(const[n,[s,o,{resolve:a}]]of b)if(t===s&&r===o){for(let t=0;t<e.length;t++)n[t]=e[t];b.delete(n),a("ok");break}})(...n);break;case 2:O(e,...n)}}}))}postMessage(e,...r){return super.postMessage(((e,t)=>{const r=new Map;return M(t)&&T(t,r,new Set),r.size?[e,2,r,t]:t})(t,e),...r)}}}const{BYTES_PER_ELEMENT:L}=Int32Array,{BYTES_PER_ELEMENT:P}=Uint16Array,{notify:N}=y,$=new TextDecoder("utf-16"),J=new WeakSet,_=(...e)=>(J.add(e),e);let z="";let Y=0;const C=([e,t,r,n,s,o,a,c,i],l)=>(...u)=>{let f=""!==z,p=0;f&&"="!==z[0]&&"-"!==z[0]&&(p=((e,t)=>setTimeout(console.warn,3e3,\`💀🔒 - proxy.\${e}() in proxy.\${t}()\`))(l,z));const g=Y++,d=[];J.has(u.at(-1)||d)&&J.delete(d=u.pop());const h=r(c?u.map(c):u);let y=t(2*L);return a([e,2,l,g,y,h,n],{transfer:d}),i(y,0).value.then((()=>{f&&clearTimeout(p);const r=y[1];if(!r)return;const n=P*r;return y=t(n+n%L),a([e,1,g,y]),i(y,0).value.then((()=>{const e=new Uint16Array(y.buffer),t=o?e.subarray(0,r):e.slice(0,r);return s($.decode(t))}))}))};var F=({parse:e,stringify:t,transform:r}=JSON)=>{const n=((e,t)=>async(r,n,[s,o,a,c,i])=>{i&&(z=s);try{const s=await r(...c);if(void 0!==s){const r=e(t?t(s):s);n.set(o,r),a[1]=r.length}}finally{i&&(z=""),a[0]=1,N(a,0)}})(t,r),s=crypto.randomUUID();return{Worker:class extends R{constructor(t,o){const a=new Map,c=new Map;super(t,o),this.proxy=((e,t)=>new Proxy(t,{get:(t,r)=>{let n;return"then"!==r&&(n=t.get(r),n||(n=C(e,r),t.set(r,n))),n},set:(e,t,r)=>"then"!==t&&!!e.set(t,r)}))([s,e=>new x(new I(e)),U,!1,e,B,(...e)=>this.postMessage(...e),r,y.waitAsync],a),this.postMessage(U([s,0,o])),this.addEventListener("message",(e=>{if(S(e,s)){const[t,r,...s]=e.data;switch(r){case 2:((e,t,r,n)=>{const[s]=n,o=r.get(s);if(!o)throw new Error(\`Unknown proxy.\${s}()\`);e(o,t,n)})(n,c,a,s);break;case 1:((e,[t,r])=>{const n=e.get(t);e.delete(t);for(let e=new Uint16Array(r.buffer),t=0,{length:s}=n;t<s;t++)e[t]=n.charCodeAt(t);N(r,0)})(c,s)}}}))}},polyfill:B,transfer:_}};const H="array",K="function",X="null",q="number",G="object",Q="string",V="symbol",Z="undefined";let ee=0;const te=new Map,re=new Map,ne=e=>re.get(e),se=e=>{if(!te.has(e)){let t;for(;re.has(t=ee++););te.set(e,t),re.set(t,e)}return te.get(e)};var oe=Object.fromEntries([H,"bigint","boolean",K,X,q,G,Q,V,Z].map(((e,t)=>[e,t])));const{[t]:ae}=Reflect,ce=new Map(ae(Symbol).filter((e=>typeof Symbol[e]===V)).map((e=>[Symbol[e],e]))),ie=e=>ce.get(e)||\`.\${Symbol.keyFor(e)||""}\`,le=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(\`%c\${String(t)}\`,"font-weight:bold","collected"),e(t)})),ue=Object.create(null),{addEventListener:fe}=EventTarget.prototype,pe=new WeakMap;Reflect.defineProperty(EventTarget.prototype,"addEventListener",{value(e,t,...r){const n=r.at(0)?.invoke;if(n){let t=pe.get(this);t||(t=new Map,pe.set(this,t)),t.set(e,[].concat(n)),delete r[0].invoke}return fe.call(this,e,t,...r)}});const{isArray:ge}=Array,de=e=>{const t=typeof e;switch(t){case G:return null===e?[oe[X],e]:e===globalThis?[oe[G],null]:ge(e)?[oe[H],se(e)]:[oe[G],e instanceof h?e:se(e)];case K:return[oe[K],se(e)];case V:return[oe[V],ie(e)];default:return[oe[t],e]}};var he=(n,s)=>{const o=new Map,a=e=>{o.delete(e),s(r,e)},c=([t,r])=>{switch(t){case oe[G]:if(null===r)return globalThis;if(typeof r===q)return ne(r);if(!(r instanceof h))for(const e in r)r[e]=c(r[e]);return r;case oe[H]:return typeof r===q?ne(r):r.map(c);case oe[K]:switch(typeof r){case q:return ne(r);case Q:{let t=o.get(r)?.deref();return t||(t=((e,t,{debug:r,handler:n,return:s,token:o=e}=ue)=>{const a=s||new Proxy(e,n||ue),c=[a,[t,e,!!r]];return!1!==o&&c.push(o),le.register(...c),a})(r,a,{token:!1,return:function(...t){return t.length&&t[0]instanceof Event&&(e=>{const{currentTarget:t,target:r,type:n}=e,s=pe.get(t||r)?.get(n);if(s)for(const t of s)e[t]()})(t[0]),s(e,r,de(this),t.map(de)).then(c)}}),o.set(r,new WeakRef(t))),t}}case oe[V]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of ce)if(r===e)return t})(r);default:return r}},i=e=>import(n(e));return(e,n,...s)=>{if(e===r)(e=>{const[t,r]=typeof e===q?[re,te]:[te,re],n=t.has(e);n&&(r.delete(t.get(e)),t.delete(e))})(n);else{const r=Reflect[e],o=null==n?globalThis:ne(n);switch(e){case"defineProperty":{const[e,t]=s.map(c);return de(r(o,e,t))}case"getOwnPropertyDescriptor":{const e=r(o,...s.map(c));if(e){const{get:t,set:r,value:n}=e;t&&(e.get=de(t)),r&&(e.set=de(r)),n&&(e.value=de(n))}return[oe[e?G:Z],e]}case t:return[oe[H],r(o).map(de)];case"get":if(null==n&&"import"===s[0][1])return de(i);default:return((e,t,r)=>de(e(t,...r.map(c))))(r,o,s)}}}},ye=e=>{const t=e?.import,r=F(e);class n extends r.Worker{constructor(e,r){const{proxy:n}=super(e,r);n[s]=he(r?.import||t||(e=>new URL(e,location.href)),n[o])}}return{...r,Worker:n}};class we{constructor(e,t){this._=e,this.$=t}get data(){return this.$}preventDefault(){this._.preventDefault()}stopImmediatePropagation(){this._.stopImmediatePropagation()}}const{WebSocket:me}=globalThis,{parse:be,stringify:ve}=JSON;const{parse:ke,stringify:Ee}=JSON,{keys:Se}=Object,Me=String,Ae="string",Te={},je="object",Oe=(e,t)=>t,We=e=>e instanceof Me?Me(e):e,xe=(e,t)=>typeof t===Ae?new Me(t):t,Ie=(e,t,r,n)=>{const s=[];for(let o=Se(r),{length:a}=o,c=0;c<a;c++){const a=o[c],i=r[a];if(i instanceof Me){const o=e[i];typeof o!==je||t.has(o)?r[a]=n.call(r,a,o):(t.add(o),r[a]=Te,s.push({k:a,a:[e,t,o,n]}))}else r[a]!==Te&&(r[a]=n.call(r,a,i))}for(let{length:e}=s,t=0;t<e;t++){const{k:e,a:o}=s[t];r[e]=n.call(r,e,Ie.apply(null,o))}return r},Re=(e,t,r)=>{const n=Me(t.push(r)-1);return e.set(r,n),n},Ue="object"==typeof self?self:globalThis,Be=e=>((e,t)=>{const r=(t,r)=>(e.set(r,t),t),n=s=>{if(e.has(s))return e.get(s);const[o,a]=t[s];switch(o){case 0:case-1:return r(a,s);case 1:{const e=r([],s);for(const t of a)e.push(n(t));return e}case 2:{const e=r({},s);for(const[t,r]of a)e[n(t)]=n(r);return e}case 3:return r(new Date(a),s);case 4:{const{source:e,flags:t}=a;return r(new RegExp(e,t),s)}case 5:{const e=r(new Map,s);for(const[t,r]of a)e.set(n(t),n(r));return e}case 6:{const e=r(new Set,s);for(const t of a)e.add(n(t));return e}case 7:{const{name:e,message:t}=a;return r(new Ue[e](t),s)}case 8:return r(BigInt(a),s);case"BigInt":return r(Object(BigInt(a)),s)}return r(new Ue[o](a),s)};return n})(new Map,e)(0),De="",{toString:Le}={},{keys:Pe}=Object,Ne=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const r=Le.call(e).slice(8,-1);switch(r){case"Array":return[1,De];case"Object":return[2,De];case"Date":return[3,De];case"RegExp":return[4,De];case"Map":return[5,De];case"Set":return[6,De]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},$e=([e,t])=>0===e&&("function"===t||"symbol"===t),Je=(e,{json:t,lossy:r}={})=>{const n=[];return((e,t,r,n)=>{const s=(e,t)=>{const s=n.push(e)-1;return r.set(t,s),s},o=n=>{if(r.has(n))return r.get(n);let[a,c]=Ne(n);switch(a){case 0:{let t=n;switch(c){case"bigint":a=8,t=n.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);t=null;break;case"undefined":return s([-1],n)}return s([a,t],n)}case 1:{if(c)return s([c,[...n]],n);const e=[],t=s([a,e],n);for(const t of n)e.push(o(t));return t}case 2:{if(c)switch(c){case"BigInt":return s([c,n.toString()],n);case"Boolean":case"Number":case"String":return s([c,n.valueOf()],n)}if(t&&"toJSON"in n)return o(n.toJSON());const r=[],i=s([a,r],n);for(const t of Pe(n))!e&&$e(Ne(n[t]))||r.push([o(t),o(n[t])]);return i}case 3:return s([a,n.toISOString()],n);case 4:{const{source:e,flags:t}=n;return s([a,{source:e,flags:t}],n)}case 5:{const t=[],r=s([a,t],n);for(const[r,s]of n)(e||!$e(Ne(r))&&!$e(Ne(s)))&&t.push([o(r),o(s)]);return r}case 6:{const t=[],r=s([a,t],n);for(const r of n)!e&&$e(Ne(r))||t.push(o(r));return r}}const{message:i}=n;return s([a,{name:c,message:i}],n)};return o})(!(t||r),!!t,new Map,n)(e),n},{parse:_e,stringify:ze}=JSON,Ye={json:!0,lossy:!0};var Ce={json:JSON,circular:{parse:(e,t)=>{const r=ke(e,xe).map(We),n=r[0],s=t||Oe,o=typeof n===je&&n?Ie(r,new Set,n,s):n;return s.call({"":o},"",o)},stringify:(e,t,r)=>{const n=t&&typeof t===je?(e,r)=>""===e||-1<t.indexOf(e)?r:void 0:t||Oe,s=new Map,o=[],a=[];let c=+Re(s,o,n.call({"":e},"",e)),i=!c;for(;c<o.length;)i=!0,a[c]=Ee(o[c++],l,r);return"["+a.join(",")+"]";function l(e,t){if(i)return i=!i,t;const r=n.call(this,e,t);switch(typeof r){case je:if(null===r)return r;case Ae:return s.get(r)||Re(s,o,r)}return r}}},structured:{parse:e=>Be(_e(e)),stringify:e=>ze(Je(e,Ye))}};try{new SharedArrayBuffer(4)}catch({message:e}){alert(e),close()}const{workerful:Fe}=globalThis;if(delete globalThis.workerful,addEventListener("beforeunload",(()=>{navigator.sendBeacon(\`/\${Fe.secret}?\${encodeURIComponent(JSON.stringify({position:[screenX,screenY],size:[innerWidth,innerHeight]}))}\`)})),Fe.centered){const{width:e,height:t}=screen,r=(e-innerWidth)/2,n=(t-innerHeight)/2;moveTo(r,n)}const{Worker:He}=(t=>{t={parse:be,stringify:ve,...t};const{parse:r,stringify:n,ws:s}=t,o=ye(t);class i extends o.Worker{#e=null;constructor(t,...o){let i=0;const l=crypto.randomUUID(),u=new Map,{proxy:f}=super(t,...o),{[c]:p}=f,{promise:g,resolve:d}=w(),h=this.#e=new me(s);f[a]=async(...e)=>{await g;const{promise:t,resolve:r}=w();return u.set(i,r),h.send(n([l,i++,...e])),t},h.addEventListener("close",(()=>{super.terminate()})),h.addEventListener("open",(()=>{h.send(n([l,0]))})),h.addEventListener("message",(async t=>{t.data||d();try{const s=r(t.data);if(S(new we(t,s),l)){let[t,r,o]=s;if(null==r){const[t,s,...a]=o,c=t===e;c&&(r=a.pop());try{o=await p(t,s,...a)}catch(e){o=e}c&&h.send(n([l,null,t,r,o]))}else u.get(r)(o),u.delete(r)}}catch(e){}}))}terminate(){this.#e.close(),super.terminate()}}return{...o,Worker:i}})({ws:Fe.ws,...Ce[Fe.serializer]});new He("/workerful.js")}();\n`,t.writeHead(200,{"Content-Type":"text/javascript;charset=utf-8"}),t.end(e),!0}}else if("POST"===n){const e=`/${Bn}?`;if(r.startsWith(e)){if(Rn)return;const{promise:t,resolve:n}=Promise.withResolvers();Un=t;try{Object.assign(Tn.window,oe(decodeURIComponent(r.slice(e.length)))),"always"!==Tn.centered&&(Tn.centered=!1),s(en,`${ie(tn,null,"\t")}\n`)}finally{n()}return!0}}return!1}));Wn.listen(+Nn,jn,(async function(){const{address:e,family:t,port:r}=this.address(),s=`//${"IPv4"===t?e:"localhost"}:${r}/`,{name:n,flags:o}=(({name:e,workerful:{name:t,browser:r,window:s}},n,o)=>{const i=r?.name||"chrome",c=(r?.flags||[]).slice(0),l=t||e||"unknown";if("chrome"!==i)throw new Error(`Unsupported browser ${i}`);return c.push(`--window-position=${(s?.position||[0,0]).join(",")}`,`--window-size=${(s?.size||[640,400]).join(",")}`,`--window-name=${l}`,`--user-data-dir=${a(g(),".workerful",l.replace(/\s/g,"-"))}`,"--ignore-profile-directory-if-not-exists","--enable-webgpu-developer-features","--ignore-gpu-blocklist","--disable-extensions","--allow-running-insecure-content","--allow-files-access-from-files","--enable-features=SharedArrayBuffer","--disable-first-run-ui","--new-window","--minimal","--content-shell-hide-toolbar","--incognito","--no-first-run","--no-default-browser-check","--disable-default-apps","--disable-cache","--disable-popup-blocking"),o?c.push("--kiosk",n):c.push(`--app=${n}`),{name:i,flags:c}})(tn,`http:${s}`,ne(Rn));if(An=`ws:${s}`,!ne(Cn)){const e=await((e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected a valid `name`");const{arguments:r=[]}=t??{};if(null!=r&&!Array.isArray(r))throw new TypeError("Expected `appArguments` as Array type");return ee({...t,app:{name:e,arguments:r}})})(se[n],{arguments:o}),{pid:t}=e;process.on("SIGINT",(()=>{setTimeout((()=>process.exit(0))),process.kill(t)})),e.on("close",(()=>{setTimeout((async()=>{await Un,process.exit(0)}),250)}))}ne(In)&&(console.debug("[1mworkerful app launcher[0m"),console.debug(`chromium ${o.join(" ")}`),console.debug("[1mworkerful serializer[0m ",Ln),console.debug("[1mworkerful server[0m     ",`http://${s}`))}));

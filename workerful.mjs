#!/usr/bin/env node
/*!
 * MIT License
 * 
 * # workerful, @ungap/with-resolvers, @ungap/structured-clone, coincident, flatted, static-handler
 * Copyright (c) Andrea Giammarchi, @WebReflection
 * 
 * # open
 * Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)
 * 
 * # ws
 * Copyright (c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * Copyright (c) 2013 Arnout Kazemier and contributors
 * Copyright (c) 2016 Luigi Pinca and contributors
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import e,{existsSync as t,readFileSync as r,writeFileSync as s}from"node:fs";import n from"node:process";import{Buffer as o}from"node:buffer";import i,{join as a,resolve as c,dirname as l}from"node:path";import{fileURLToPath as h}from"node:url";import f,{execFile as u}from"node:child_process";import d,{constants as p}from"node:fs/promises";import m,{homedir as g}from"node:os";import{promisify as y}from"node:util";import{createServer as w}from"node:http";import _ from"stream";import b from"zlib";import v from"buffer";import x from"crypto";import S from"events";import E from"https";import k from"http";import O from"net";import T from"tls";import P from"url";import{extname as j}from"path";import{statSync as N,createReadStream as R}from"fs";let L,C;function I(){return void 0===L&&(L=function(){try{return e.statSync("/.dockerenv"),!0}catch{return!1}}()||function(){try{return e.readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}()),L}Promise.withResolvers||(Promise.withResolvers=function(){var e,t,r=new this((function(r,s){e=r,t=s}));return{resolve:e,reject:t,promise:r}});function B(){return void 0===C&&(C=(()=>{try{return e.statSync("/run/.containerenv"),!0}catch{return!1}})()||I()),C}const M=()=>{if("linux"!==n.platform)return!1;if(m.release().toLowerCase().includes("microsoft"))return!B();try{return!!e.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")&&!B()}catch{return!1}};var A=n.env.__IS_WSL_TEST__?M:M();function U(e,t,r){const s=r=>Object.defineProperty(e,t,{value:r,enumerable:!0,writable:!0});return Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get(){const e=r();return s(e),e},set(e){s(e)}}),e}const W=y(u);const $=y(u);async function D(e){return async function(e,{humanReadableOutput:t=!0}={}){if("darwin"!==n.platform)throw new Error("macOS only");const r=t?[]:["-ss"],{stdout:s}=await $("osascript",["-e",e,r]);return s.trim()}(`tell application "Finder" to set app_path to application file id "${e}" as string\ntell application "System Events" to get value of property list item "CFBundleName" of property list file (app_path & ":Contents:Info.plist")`)}const F=y(u),z={AppXq0fevzme2pys62n3e0fbqa7peapykr8v:{name:"Edge",id:"com.microsoft.edge.old"},MSEdgeDHTML:{name:"Edge",id:"com.microsoft.edge"},MSEdgeHTM:{name:"Edge",id:"com.microsoft.edge"},"IE.HTTP":{name:"Internet Explorer",id:"com.microsoft.ie"},FirefoxURL:{name:"Firefox",id:"org.mozilla.firefox"},ChromeHTML:{name:"Chrome",id:"com.google.chrome"},BraveHTML:{name:"Brave",id:"com.brave.Browser"},BraveBHTML:{name:"Brave Beta",id:"com.brave.Browser.beta"},BraveSSHTM:{name:"Brave Nightly",id:"com.brave.Browser.nightly"}};class q extends Error{}const G=y(u);async function V(){if("darwin"===n.platform){const e=await async function(){if("darwin"!==n.platform)throw new Error("macOS only");const{stdout:e}=await W("defaults",["read","com.apple.LaunchServices/com.apple.launchservices.secure","LSHandlers"]),t=/LSHandlerRoleAll = "(?!-)(?<id>[^"]+?)";\s+?LSHandlerURLScheme = (?:http|https);/.exec(e);return t?.groups.id??"com.apple.Safari"}();return{name:await D(e),id:e}}if("linux"===n.platform){const{stdout:e}=await G("xdg-mime",["query","default","x-scheme-handler/http"]),t=e.trim();return{name:t.replace(/.desktop$/,"").replace("-"," ").toLowerCase().replaceAll(/(?:^|\s|-)\S/g,(e=>e.toUpperCase())),id:t}}if("win32"===n.platform)return async function(e=F){const{stdout:t}=await e("reg",["QUERY"," HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\http\\UserChoice","/v","ProgId"]),r=/ProgId\s*REG_SZ\s*(?<id>\S+)/.exec(t);if(!r)throw new q(`Cannot find Windows browser in stdout: ${JSON.stringify(t)}`);const{id:s}=r.groups,n=z[s];if(!n)throw new q(`Unknown browser ID: ${s}`);return n}();throw new Error("Only macOS, Linux, and Windows are supported")}const H=i.dirname(h(import.meta.url)),Y=i.join(H,"xdg-open"),{platform:J,arch:K}=n,X=(()=>{const e="/mnt/";let t;return async function(){if(t)return t;const r="/etc/wsl.conf";let s=!1;try{await d.access(r,p.F_OK),s=!0}catch{}if(!s)return e;const n=await d.readFile(r,{encoding:"utf8"}),o=/(?<!#.*)root\s*=\s*(?<mountPoint>.*)/g.exec(n);return o?(t=o.groups.mountPoint.trim(),t=t.endsWith("/")?t:`${t}/`,t):e}})(),Z=async(e,t)=>{let r;for(const s of e)try{return await t(s)}catch(e){r=e}throw r},Q=async e=>{if(e={wait:!1,background:!1,newInstance:!1,allowNonzeroExitCode:!1,...e},Array.isArray(e.app))return Z(e.app,(t=>Q({...e,app:t})));let t,{name:r,arguments:s=[]}=e.app??{};if(s=[...s],Array.isArray(r))return Z(r,(t=>Q({...e,app:{name:t,arguments:s}})));if("browser"===r||"browserPrivate"===r){const t={"com.google.chrome":"chrome","google-chrome.desktop":"chrome","org.mozilla.firefox":"firefox","firefox.desktop":"firefox","com.microsoft.msedge":"edge","com.microsoft.edge":"edge","microsoft-edge.desktop":"edge"},n={chrome:"--incognito",firefox:"--private-window",edge:"--inPrivate"},o=await V();if(o.id in t){const i=t[o.id];return"browserPrivate"===r&&s.push(n[i]),Q({...e,app:{name:re[i],arguments:s}})}throw new Error(`${o.name} is not supported as a default browser`)}const i=[],a={};if("darwin"===J)t="open",e.wait&&i.push("--wait-apps"),e.background&&i.push("--background"),e.newInstance&&i.push("--new"),r&&i.push("-a",r);else if("win32"===J||A&&!B()&&!r){const c=await X();t=A?`${c}c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe`:`${n.env.SYSTEMROOT||n.env.windir||"C:\\Windows"}\\System32\\WindowsPowerShell\\v1.0\\powershell`,i.push("-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand"),A||(a.windowsVerbatimArguments=!0);const l=["Start"];e.wait&&l.push("-Wait"),r?(l.push(`"\`"${r}\`""`),e.target&&s.push(e.target)):e.target&&l.push(`"${e.target}"`),s.length>0&&(s=s.map((e=>`"\`"${e}\`""`)),l.push("-ArgumentList",s.join(","))),e.target=o.from(l.join(" "),"utf16le").toString("base64")}else{if(r)t=r;else{const e=!H||"/"===H;let r=!1;try{await d.access(Y,p.X_OK),r=!0}catch{}t=n.versions.electron??("android"===J||e||!r)?"xdg-open":Y}s.length>0&&i.push(...s),e.wait||(a.stdio="ignore",a.detached=!0)}"darwin"===J&&s.length>0&&i.push("--args",...s),e.target&&i.push(e.target);const c=f.spawn(t,i,a);return e.wait?new Promise(((t,r)=>{c.once("error",r),c.once("close",(s=>{!e.allowNonzeroExitCode&&s>0?r(new Error(`Exited with code ${s}`)):t(c)}))})):(c.unref(),c)};function ee(e){if("string"==typeof e||Array.isArray(e))return e;const{[K]:t}=e;if(!t)throw new Error(`${K} is not supported`);return t}function te({[J]:e},{wsl:t}){if(t&&A)return ee(t);if(!e)throw new Error(`${J} is not supported`);return ee(e)}const re={};U(re,"chrome",(()=>te({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}}))),U(re,"firefox",(()=>te({darwin:"firefox",win32:"C:\\Program Files\\Mozilla Firefox\\firefox.exe",linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"}))),U(re,"edge",(()=>te({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"}))),U(re,"browser",(()=>"browser")),U(re,"browserPrivate",(()=>"browserPrivate"));const se=e=>/^(?:1|y|ok|yes|true)$/i.test(e),{parse:ne,stringify:oe}=JSON;function ie(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ae={exports:{}};const ce=["nodebuffer","arraybuffer","fragments"],le="undefined"!=typeof Blob;le&&ce.push("blob");var he={BINARY_TYPES:ce,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:le,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:fe}=he,ue=Buffer[Symbol.species];function de(e,t,r,s,n){for(let o=0;o<n;o++)r[s+o]=e[o]^t[3&o]}function pe(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(ae.exports={concat:function(e,t){if(0===e.length)return fe;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(t);let s=0;for(let t=0;t<e.length;t++){const n=e[t];r.set(n,s),s+=n.length}return s<t?new ue(r.buffer,r.byteOffset,s):r},mask:de,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let r;return t instanceof ArrayBuffer?r=new ue(t):ArrayBuffer.isView(t)?r=new ue(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r},unmask:pe},!process.env.WS_NO_BUFFER_UTIL)try{const e=require("bufferutil");ae.exports.mask=function(t,r,s,n,o){o<48?de(t,r,s,n,o):e.mask(t,r,s,n,o)},ae.exports.unmask=function(t,r){t.length<32?pe(t,r):e.unmask(t,r)}}catch(e){}var me=ae.exports;const ge=Symbol("kDone"),ye=Symbol("kRun");const we=b,_e=me,be=class{constructor(e){this[ge]=()=>{this.pending--,this[ye]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[ye]()}[ye](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[ge])}}},{kStatusCode:ve}=he,xe=Buffer[Symbol.species],Se=Buffer.from([0,0,255,255]),Ee=Symbol("permessage-deflate"),ke=Symbol("total-length"),Oe=Symbol("callback"),Te=Symbol("buffers"),Pe=Symbol("error");let je;var Ne=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!je){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;je=new be(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Oe];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){je.add((s=>{this._decompress(e,t,((e,t)=>{s(),r(e,t)}))}))}compress(e,t,r){je.add((s=>{this._compress(e,t,((e,t)=>{s(),r(e,t)}))}))}_decompress(e,t,r){const s=this._isServer?"client":"server";if(!this._inflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?we.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=we.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[Ee]=this,this._inflate[ke]=0,this._inflate[Te]=[],this._inflate.on("error",Ce),this._inflate.on("data",Le)}this._inflate[Oe]=r,this._inflate.write(e),t&&this._inflate.write(Se),this._inflate.flush((()=>{const e=this._inflate[Pe];if(e)return this._inflate.close(),this._inflate=null,void r(e);const n=_e.concat(this._inflate[Te],this._inflate[ke]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[ke]=0,this._inflate[Te]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),r(null,n)}))}_compress(e,t,r){const s=this._isServer?"server":"client";if(!this._deflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?we.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=we.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[ke]=0,this._deflate[Te]=[],this._deflate.on("data",Re)}this._deflate[Oe]=r,this._deflate.write(e),this._deflate.flush(we.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=_e.concat(this._deflate[Te],this._deflate[ke]);t&&(e=new xe(e.buffer,e.byteOffset,e.length-4)),this._deflate[Oe]=null,this._deflate[ke]=0,this._deflate[Te]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),r(null,e)}))}};function Re(e){this[Te].push(e),this[ke]+=e.length}function Le(e){this[ke]+=e.length,this[Ee]._maxPayload<1||this[ke]<=this[Ee]._maxPayload?this[Te].push(e):(this[Pe]=new RangeError("Max payload size exceeded"),this[Pe].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[Pe][ve]=1009,this.removeListener("data",Le),this.reset())}function Ce(e){this[Ee]._inflate=null,e[ve]=1007,this[Oe](e)}var Ie={exports:{}};const{isUtf8:Be}=v,{hasBlob:Me}=he;function Ae(e){const t=e.length;let r=0;for(;r<t;)if(128&e[r])if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}else r++;return!0}if(Ie.exports={isBlob:function(e){return Me&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:Ae,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},Be)Ie.exports.isValidUTF8=function(e){return e.length<24?Ae(e):Be(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const e=require("utf-8-validate");Ie.exports.isValidUTF8=function(t){return t.length<32?Ae(t):e(t)}}catch(e){}var Ue=Ie.exports;const{Writable:We}=_,$e=Ne,{BINARY_TYPES:De,EMPTY_BUFFER:Fe,kStatusCode:ze,kWebSocket:qe}=he,{concat:Ge,toArrayBuffer:Ve,unmask:He}=me,{isValidStatusCode:Ye,isValidUTF8:Je}=Ue,Ke=Buffer[Symbol.species];var Xe=class extends We{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||De[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[qe]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new Ke(t.buffer,t.byteOffset+e,t.length-e),new Ke(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],s=t.length-e;e>=r.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),s),this._buffers[0]=new Ke(r.buffer,r.byteOffset+e,r.length-e)),e-=r.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(48&t[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const r=!(64&~t[0]);if(!r||this._extensions[$e.extensionName]){if(this._fin=!(128&~t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=r}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),r=t.readUInt32BE(0);if(r>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=r*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=Fe;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&He(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[$e.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(r)}this.dataMessage(t),0===this._state&&this.startLoop(t)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?Ge(r,t):"arraybuffer"===this._binaryType?Ve(Ge(r,t)):"blob"===this._binaryType?new Blob(r):r,this._allowSynchronousEvents?(this.emit("message",s,!0),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",s,!0),this._state=0,this.startLoop(e)})))}else{const s=Ge(r,t);if(!this._skipUTF8Validation&&!Je(s)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",s,!1),this._state=0):(this._state=6,setImmediate((()=>{this.emit("message",s,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,Fe),this.end();else{const r=e.readUInt16BE(0);if(!Ye(r)){const e=this.createError(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const s=new Ke(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Je(s)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",r,s),this.end()}this._state=0}}createError(e,t,r,s,n){this._loop=!1,this._errored=!0;const o=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=n,o[ze]=s,o}};const{randomFillSync:Ze}=x,Qe=Ne,{EMPTY_BUFFER:et,kWebSocket:tt,NOOP:rt}=he,{isBlob:st,isValidStatusCode:nt}=Ue,{mask:ot,toBuffer:it}=me,at=Symbol("kByteLength"),ct=Buffer.alloc(4),lt=8192;let ht,ft=lt;var ut=class e{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=rt,this[tt]=void 0}static frame(e,t){let r,s,n=!1,o=2,i=!1;t.mask&&(r=t.maskBuffer||ct,t.generateMask?t.generateMask(r):(ft===lt&&(void 0===ht&&(ht=Buffer.alloc(lt)),Ze(ht,0,lt),ft=0),r[0]=ht[ft++],r[1]=ht[ft++],r[2]=ht[ft++],r[3]=ht[ft++]),i=!(r[0]|r[1]|r[2]|r[3]),o=6),"string"==typeof e?s=t.mask&&!i||void 0===t[at]?(e=Buffer.from(e)).length:t[at]:(s=e.length,n=t.mask&&t.readOnly&&!i);let a=s;s>=65536?(o+=8,a=127):s>125&&(o+=2,a=126);const c=Buffer.allocUnsafe(n?s+o:o);return c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=a,126===a?c.writeUInt16BE(s,2):127===a&&(c[2]=c[3]=0,c.writeUIntBE(s,4,6)),t.mask?(c[1]|=128,c[o-4]=r[0],c[o-3]=r[1],c[o-2]=r[2],c[o-1]=r[3],i?[c,e]:n?(ot(e,r,c,o,s),[c]):(ot(e,r,e,0,s),[c,e])):[c,e]}close(t,r,s,n){let o;if(void 0===t)o=et;else{if("number"!=typeof t||!nt(t))throw new TypeError("First argument must be a valid error code number");if(void 0!==r&&r.length){const e=Buffer.byteLength(r);if(e>123)throw new RangeError("The message must not be greater than 123 bytes");o=Buffer.allocUnsafe(2+e),o.writeUInt16BE(t,0),"string"==typeof r?o.write(r,2):o.set(r,2)}else o=Buffer.allocUnsafe(2),o.writeUInt16BE(t,0)}const i={[at]:o.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,o,!1,i,n]):this.sendFrame(e.frame(o,i),n)}ping(t,r,s){let n,o;if("string"==typeof t?(n=Buffer.byteLength(t),o=!1):st(t)?(n=t.size,o=!1):(n=(t=it(t)).length,o=it.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[at]:n,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:9,readOnly:o,rsv1:!1};st(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,i,s]):this.getBlobData(t,!1,i,s):0!==this._state?this.enqueue([this.dispatch,t,!1,i,s]):this.sendFrame(e.frame(t,i),s)}pong(t,r,s){let n,o;if("string"==typeof t?(n=Buffer.byteLength(t),o=!1):st(t)?(n=t.size,o=!1):(n=(t=it(t)).length,o=it.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[at]:n,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:10,readOnly:o,rsv1:!1};st(t)?0!==this._state?this.enqueue([this.getBlobData,t,!1,i,s]):this.getBlobData(t,!1,i,s):0!==this._state?this.enqueue([this.dispatch,t,!1,i,s]):this.sendFrame(e.frame(t,i),s)}send(e,t,r){const s=this._extensions[Qe.extensionName];let n,o,i=t.binary?2:1,a=t.compress;"string"==typeof e?(n=Buffer.byteLength(e),o=!1):st(e)?(n=e.size,o=!1):(n=(e=it(e)).length,o=it.readOnly),this._firstFragment?(this._firstFragment=!1,a&&s&&s.params[s._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=n>=s._threshold),this._compress=a):(a=!1,i=0),t.fin&&(this._firstFragment=!0);const c={[at]:n,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:o,rsv1:a};st(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,c,r]):this.getBlobData(e,this._compress,c,r):0!==this._state?this.enqueue([this.dispatch,e,this._compress,c,r]):this.dispatch(e,this._compress,c,r)}getBlobData(t,r,s,n){this._bufferedBytes+=s[at],this._state=2,t.arrayBuffer().then((t=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void process.nextTick(dt,this,e,n)}this._bufferedBytes-=s[at];const o=it(t);r?this.dispatch(o,r,s,n):(this._state=0,this.sendFrame(e.frame(o,s),n),this.dequeue())})).catch((e=>{process.nextTick(pt,this,e,n)}))}dispatch(t,r,s,n){if(!r)return void this.sendFrame(e.frame(t,s),n);const o=this._extensions[Qe.extensionName];this._bufferedBytes+=s[at],this._state=1,o.compress(t,s.fin,((t,r)=>{if(this._socket.destroyed){dt(this,new Error("The socket was closed while data was being compressed"),n)}else this._bufferedBytes-=s[at],this._state=0,s.readOnly=!1,this.sendFrame(e.frame(r,s),n),this.dequeue()}))}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][at],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][at],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};function dt(e,t,r){"function"==typeof r&&r(t);for(let r=0;r<e._queue.length;r++){const s=e._queue[r],n=s[s.length-1];"function"==typeof n&&n(t)}}function pt(e,t,r){dt(e,t,r),e.onerror(t)}const{kForOnEventAttribute:mt,kListener:gt}=he,yt=Symbol("kCode"),wt=Symbol("kData"),_t=Symbol("kError"),bt=Symbol("kMessage"),vt=Symbol("kReason"),xt=Symbol("kTarget"),St=Symbol("kType"),Et=Symbol("kWasClean");let kt=class{constructor(e){this[xt]=null,this[St]=e}get target(){return this[xt]}get type(){return this[St]}};Object.defineProperty(kt.prototype,"target",{enumerable:!0}),Object.defineProperty(kt.prototype,"type",{enumerable:!0});class Ot extends kt{constructor(e,t={}){super(e),this[yt]=void 0===t.code?0:t.code,this[vt]=void 0===t.reason?"":t.reason,this[Et]=void 0!==t.wasClean&&t.wasClean}get code(){return this[yt]}get reason(){return this[vt]}get wasClean(){return this[Et]}}Object.defineProperty(Ot.prototype,"code",{enumerable:!0}),Object.defineProperty(Ot.prototype,"reason",{enumerable:!0}),Object.defineProperty(Ot.prototype,"wasClean",{enumerable:!0});class Tt extends kt{constructor(e,t={}){super(e),this[_t]=void 0===t.error?null:t.error,this[bt]=void 0===t.message?"":t.message}get error(){return this[_t]}get message(){return this[bt]}}Object.defineProperty(Tt.prototype,"error",{enumerable:!0}),Object.defineProperty(Tt.prototype,"message",{enumerable:!0});class Pt extends kt{constructor(e,t={}){super(e),this[wt]=void 0===t.data?null:t.data}get data(){return this[wt]}}Object.defineProperty(Pt.prototype,"data",{enumerable:!0});const jt={addEventListener(e,t,r={}){for(const s of this.listeners(e))if(!r[mt]&&s[gt]===t&&!s[mt])return;let s;if("message"===e)s=function(e,r){const s=new Pt("message",{data:r?e:e.toString()});s[xt]=this,Rt(t,this,s)};else if("close"===e)s=function(e,r){const s=new Ot("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});s[xt]=this,Rt(t,this,s)};else if("error"===e)s=function(e){const r=new Tt("error",{error:e,message:e.message});r[xt]=this,Rt(t,this,r)};else{if("open"!==e)return;s=function(){const e=new kt("open");e[xt]=this,Rt(t,this,e)}}s[mt]=!!r[mt],s[gt]=t,r.once?this.once(e,s):this.on(e,s)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[gt]===t&&!r[mt]){this.removeListener(e,r);break}}};var Nt={CloseEvent:Ot,ErrorEvent:Tt,Event:kt,EventTarget:jt,MessageEvent:Pt};function Rt(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}const{tokenChars:Lt}=Ue;function Ct(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var It={format:function(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let r,s,n=Object.create(null),o=!1,i=!1,a=!1,c=-1,l=-1,h=-1,f=0;for(;f<e.length;f++)if(l=e.charCodeAt(f),void 0===r)if(-1===h&&1===Lt[l])-1===c&&(c=f);else if(0===f||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f);const s=e.slice(c,h);44===l?(Ct(t,s,n),n=Object.create(null)):r=s,c=h=-1}}else-1===h&&-1!==c&&(h=f);else if(void 0===s)if(-1===h&&1===Lt[l])-1===c&&(c=f);else if(32===l||9===l)-1===h&&-1!==c&&(h=f);else if(59===l||44===l){if(-1===c)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f),Ct(n,e.slice(c,h),!0),44===l&&(Ct(t,r,n),n=Object.create(null),r=void 0),c=h=-1}else{if(61!==l||-1===c||-1!==h)throw new SyntaxError(`Unexpected character at index ${f}`);s=e.slice(c,f),c=h=-1}else if(i){if(1!==Lt[l])throw new SyntaxError(`Unexpected character at index ${f}`);-1===c?c=f:o||(o=!0),i=!1}else if(a)if(1===Lt[l])-1===c&&(c=f);else if(34===l&&-1!==c)a=!1,h=f;else{if(92!==l)throw new SyntaxError(`Unexpected character at index ${f}`);i=!0}else if(34===l&&61===e.charCodeAt(f-1))a=!0;else if(-1===h&&1===Lt[l])-1===c&&(c=f);else if(-1===c||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${f}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${f}`);-1===h&&(h=f);let i=e.slice(c,h);o&&(i=i.replace(/\\/g,""),o=!1),Ct(n,s,i),44===l&&(Ct(t,r,n),n=Object.create(null),r=void 0),s=void 0,c=h=-1}}else-1===h&&(h=f);if(-1===c||a||32===l||9===l)throw new SyntaxError("Unexpected end of input");-1===h&&(h=f);const u=e.slice(c,h);return void 0===r?Ct(t,u,n):(void 0===s?Ct(n,u,!0):Ct(n,s,o?u.replace(/\\/g,""):u),Ct(t,r,n)),t}};const Bt=S,Mt=E,At=k,Ut=O,Wt=T,{randomBytes:$t,createHash:Dt}=x,{URL:Ft}=P,zt=Ne,qt=Xe,Gt=ut,{isBlob:Vt}=Ue,{BINARY_TYPES:Ht,EMPTY_BUFFER:Yt,GUID:Jt,kForOnEventAttribute:Kt,kListener:Xt,kStatusCode:Zt,kWebSocket:Qt,NOOP:er}=he,{EventTarget:{addEventListener:tr,removeEventListener:rr}}=Nt,{format:sr,parse:nr}=It,{toBuffer:or}=me,ir=3e4,ar=Symbol("kAborted"),cr=[8,13],lr=["CONNECTING","OPEN","CLOSING","CLOSED"],hr=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;let fr=class e extends Bt{constructor(t,r,s){super(),this._binaryType=Ht[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Yt,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=e.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==t?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===r?r=[]:Array.isArray(r)||("object"==typeof r&&null!==r?(s=r,r=[]):r=[r]),dr(this,t,r,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Ht.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(t,r,s){const n=new qt({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),o=new Gt(t,this._extensions,s.generateMask);this._receiver=n,this._sender=o,this._socket=t,n[Qt]=this,o[Qt]=this,t[Qt]=this,n.on("conclude",_r),n.on("drain",br),n.on("error",vr),n.on("message",Sr),n.on("ping",Er),n.on("pong",kr),o.onerror=Tr,t.setTimeout&&t.setTimeout(0),t.setNoDelay&&t.setNoDelay(),r.length>0&&t.unshift(r),t.on("close",jr),t.on("data",Nr),t.on("end",Rr),t.on("error",Lr),this._readyState=e.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=e.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[zt.extensionName]&&this._extensions[zt.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=e.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(t,r){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this.readyState!==e.CLOSING?(this._readyState=e.CLOSING,this._sender.close(t,r,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),Pr(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";yr(this,this._req,e)}}pause(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!0,this._socket.pause())}ping(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(s=t,t=r=void 0):"function"==typeof r&&(s=r,r=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===r&&(r=!this._isServer),this._sender.ping(t||Yt,r,s)):wr(this,t,s)}pong(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof t?(s=t,t=r=void 0):"function"==typeof r&&(s=r,r=void 0),"number"==typeof t&&(t=t.toString()),this.readyState===e.OPEN?(void 0===r&&(r=!this._isServer),this._sender.pong(t||Yt,r,s)):wr(this,t,s)}resume(){this.readyState!==e.CONNECTING&&this.readyState!==e.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(t,r,s){if(this.readyState===e.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof r&&(s=r,r={}),"number"==typeof t&&(t=t.toString()),this.readyState!==e.OPEN)return void wr(this,t,s);const n={binary:"string"!=typeof t,mask:!this._isServer,compress:!0,fin:!0,...r};this._extensions[zt.extensionName]||(n.compress=!1),this._sender.send(t||Yt,n,s)}terminate(){if(this.readyState!==e.CLOSED)if(this.readyState!==e.CONNECTING)this._socket&&(this._readyState=e.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";yr(this,this._req,e)}}};Object.defineProperty(fr,"CONNECTING",{enumerable:!0,value:lr.indexOf("CONNECTING")}),Object.defineProperty(fr.prototype,"CONNECTING",{enumerable:!0,value:lr.indexOf("CONNECTING")}),Object.defineProperty(fr,"OPEN",{enumerable:!0,value:lr.indexOf("OPEN")}),Object.defineProperty(fr.prototype,"OPEN",{enumerable:!0,value:lr.indexOf("OPEN")}),Object.defineProperty(fr,"CLOSING",{enumerable:!0,value:lr.indexOf("CLOSING")}),Object.defineProperty(fr.prototype,"CLOSING",{enumerable:!0,value:lr.indexOf("CLOSING")}),Object.defineProperty(fr,"CLOSED",{enumerable:!0,value:lr.indexOf("CLOSED")}),Object.defineProperty(fr.prototype,"CLOSED",{enumerable:!0,value:lr.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(fr.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(fr.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[Kt])return t[Xt];return null},set(t){for(const t of this.listeners(e))if(t[Kt]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[Kt]:!0})}})})),fr.prototype.addEventListener=tr,fr.prototype.removeEventListener=rr;var ur=fr;function dr(e,t,r,s){const n={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:cr[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=n.autoPong,!cr.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${cr.join(", ")})`);let o;if(t instanceof Ft)o=t;else try{o=new Ft(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===o.protocol?o.protocol="ws:":"https:"===o.protocol&&(o.protocol="wss:"),e._url=o.href;const i="wss:"===o.protocol,a="ws+unix:"===o.protocol;let c;if("ws:"===o.protocol||i||a?a&&!o.pathname?c="The URL's pathname is empty":o.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',c){const t=new SyntaxError(c);if(0===e._redirects)throw t;return void pr(e,t)}const l=i?443:80,h=$t(16).toString("base64"),f=i?Mt.request:At.request,u=new Set;let d,p;if(n.createConnection=n.createConnection||(i?gr:mr),n.defaultPort=n.defaultPort||l,n.port=o.port||l,n.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,n.headers={...n.headers,"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket"},n.path=o.pathname+o.search,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(d=new zt(!0!==n.perMessageDeflate?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=sr({[zt.extensionName]:d.offer()})),r.length){for(const e of r){if("string"!=typeof e||!hr.test(e)||u.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");u.add(e)}n.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),(o.username||o.password)&&(n.auth=`${o.username}:${o.password}`),a){const e=n.path.split(":");n.socketPath=e[0],n.path=e[1]}if(n.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=i,e._originalHostOrSocketPath=a?n.socketPath:o.host;const t=s&&s.headers;if(s={...s,headers:{}},t)for(const[e,r]of Object.entries(t))s.headers[e.toLowerCase()]=r}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&n.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&o.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!i)&&(delete n.headers.authorization,delete n.headers.cookie,t||delete n.headers.host,n.auth=void 0)}n.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(n.auth).toString("base64")),p=e._req=f(n),e._redirects&&e.emit("redirect",e.url,p)}else p=e._req=f(n);n.timeout&&p.on("timeout",(()=>{yr(e,p,"Opening handshake has timed out")})),p.on("error",(t=>{null===p||p[ar]||(p=e._req=null,pr(e,t))})),p.on("response",(o=>{const i=o.headers.location,a=o.statusCode;if(i&&n.followRedirects&&a>=300&&a<400){if(++e._redirects>n.maxRedirects)return void yr(e,p,"Maximum redirects exceeded");let o;p.abort();try{o=new Ft(i,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${i}`);return void pr(e,r)}dr(e,o,r,s)}else e.emit("unexpected-response",p,o)||yr(e,p,`Unexpected server response: ${o.statusCode}`)})),p.on("upgrade",((t,r,s)=>{if(e.emit("upgrade",t),e.readyState!==fr.CONNECTING)return;p=e._req=null;const o=t.headers.upgrade;if(void 0===o||"websocket"!==o.toLowerCase())return void yr(e,r,"Invalid Upgrade header");const i=Dt("sha1").update(h+Jt).digest("base64");if(t.headers["sec-websocket-accept"]!==i)return void yr(e,r,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let c;if(void 0!==a?u.size?u.has(a)||(c="Server sent an invalid subprotocol"):c="Server sent a subprotocol but none was requested":u.size&&(c="Server sent no subprotocol"),c)return void yr(e,r,c);a&&(e._protocol=a);const l=t.headers["sec-websocket-extensions"];if(void 0!==l){if(!d){return void yr(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=nr(l)}catch(t){return void yr(e,r,"Invalid Sec-WebSocket-Extensions header")}const s=Object.keys(t);if(1!==s.length||s[0]!==zt.extensionName){return void yr(e,r,"Server indicated an extension that was not requested")}try{d.accept(t[zt.extensionName])}catch(t){return void yr(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[zt.extensionName]=d}e.setSocket(r,s,{allowSynchronousEvents:n.allowSynchronousEvents,generateMask:n.generateMask,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation})})),n.finishRequest?n.finishRequest(p,e):p.end()}function pr(e,t){e._readyState=fr.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function mr(e){return e.path=e.socketPath,Ut.connect(e)}function gr(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=Ut.isIP(e.host)?"":e.host),Wt.connect(e)}function yr(e,t,r){e._readyState=fr.CLOSING;const s=new Error(r);Error.captureStackTrace(s,yr),t.setHeader?(t[ar]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(pr,e,s)):(t.destroy(s),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function wr(e,t,r){if(t){const r=Vt(t)?t.size:or(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${lr[e.readyState]})`);process.nextTick(r,t)}}function _r(e,t){const r=this[Qt];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[Qt]&&(r._socket.removeListener("data",Nr),process.nextTick(Or,r._socket),1005===e?r.close():r.close(e,t))}function br(){const e=this[Qt];e.isPaused||e._socket.resume()}function vr(e){const t=this[Qt];void 0!==t._socket[Qt]&&(t._socket.removeListener("data",Nr),process.nextTick(Or,t._socket),t.close(e[Zt])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function xr(){this[Qt].emitClose()}function Sr(e,t){this[Qt].emit("message",e,t)}function Er(e){const t=this[Qt];t._autoPong&&t.pong(e,!this._isServer,er),t.emit("ping",e)}function kr(e){this[Qt].emit("pong",e)}function Or(e){e.resume()}function Tr(e){const t=this[Qt];t.readyState!==fr.CLOSED&&(t.readyState===fr.OPEN&&(t._readyState=fr.CLOSING,Pr(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function Pr(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),ir)}function jr(){const e=this[Qt];let t;this.removeListener("close",jr),this.removeListener("data",Nr),this.removeListener("end",Rr),e._readyState=fr.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[Qt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",xr),e._receiver.on("finish",xr))}function Nr(e){this[Qt]._receiver.write(e)||this.pause()}function Rr(){const e=this[Qt];e._readyState=fr.CLOSING,e._receiver.end(),this.end()}function Lr(){const e=this[Qt];this.removeListener("error",Lr),this.on("error",er),e&&(e._readyState=fr.CLOSING,this.destroy())}const{tokenChars:Cr}=Ue;var Ir={parse:function(e){const t=new Set;let r=-1,s=-1,n=0;for(;n<e.length;n++){const o=e.charCodeAt(n);if(-1===s&&1===Cr[o])-1===r&&(r=n);else if(0===n||32!==o&&9!==o){if(44!==o)throw new SyntaxError(`Unexpected character at index ${n}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${n}`);-1===s&&(s=n);const o=e.slice(r,s);if(t.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);t.add(o),r=s=-1}}else-1===s&&-1!==r&&(s=n)}if(-1===r||-1!==s)throw new SyntaxError("Unexpected end of input");const o=e.slice(r,n);if(t.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);return t.add(o),t}};const Br=S,Mr=k,{createHash:Ar}=x,Ur=It,Wr=Ne,$r=Ir,Dr=ur,{GUID:Fr,kWebSocket:zr}=he,qr=/^[+/0-9A-Za-z]{22}==$/;var Gr=class extends Br{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Dr,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=Mr.createServer(((e,t)=>{const r=Mr.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,s)=>{this.handleUpgrade(t,r,s,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(Vr,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(Vr,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{Vr(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,s){t.on("error",Hr);const n=e.headers["sec-websocket-key"],o=e.headers.upgrade,i=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void Jr(this,e,t,405,"Invalid HTTP method")}if(void 0===o||"websocket"!==o.toLowerCase()){return void Jr(this,e,t,400,"Invalid Upgrade header")}if(void 0===n||!qr.test(n)){return void Jr(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(8!==i&&13!==i){return void Jr(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header")}if(!this.shouldHandle(e))return void Yr(t,400);const a=e.headers["sec-websocket-protocol"];let c=new Set;if(void 0!==a)try{c=$r.parse(a)}catch(r){return void Jr(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const l=e.headers["sec-websocket-extensions"],h={};if(this.options.perMessageDeflate&&void 0!==l){const r=new Wr(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=Ur.parse(l);e[Wr.extensionName]&&(r.accept(e[Wr.extensionName]),h[Wr.extensionName]=r)}catch(r){return void Jr(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const o={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(o,((o,i,a,l)=>{if(!o)return Yr(t,i||401,a,l);this.completeUpgrade(h,n,c,e,t,r,s)}));if(!this.options.verifyClient(o))return Yr(t,401)}this.completeUpgrade(h,n,c,e,t,r,s)}completeUpgrade(e,t,r,s,n,o,i){if(!n.readable||!n.writable)return n.destroy();if(n[zr])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Yr(n,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Ar("sha1").update(t+Fr).digest("base64")}`],c=new this.options.WebSocket(null,void 0,this.options);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,s):r.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),c._protocol=e)}if(e[Wr.extensionName]){const t=e[Wr.extensionName].params,r=Ur.format({[Wr.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${r}`),c._extensions=e}this.emit("headers",a,s),n.write(a.concat("\r\n").join("\r\n")),n.removeListener("error",Hr),c.setSocket(n,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(c),c.on("close",(()=>{this.clients.delete(c),this._shouldEmitClose&&!this.clients.size&&process.nextTick(Vr,this)}))),i(c,s)}};function Vr(e){e._state=2,e.emit("close")}function Hr(){this.destroy()}function Yr(e,t,r,s){r=r||Mr.STATUS_CODES[t],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...s},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${Mr.STATUS_CODES[t]}\r\n`+Object.keys(s).map((e=>`${e}: ${s[e]}`)).join("\r\n")+"\r\n\r\n"+r)}function Jr(e,t,r,s,n){if(e.listenerCount("wsClientError")){const s=new Error(n);Error.captureStackTrace(s,Jr),e.emit("wsClientError",s,r,t)}else Yr(r,s,n)}var Kr=ie(Gr);const Xr="application",Zr="audio",Qr="font",es="image",ts="message",rs="model",ss="text",ns="video",os={[Xr]:["andrew-inset","atom+xml","atomcat+xml","atomdeleted+xml","atomsvc+xml","atsc-dwd+xml","atsc-held+xml","atsc-rsat+xml","automationml-aml+xml","automationml-amlx+zip","calendar+xml","ccxml+xml","cdfx+xml","cdmi-capability","cdmi-container","cdmi-domain","cdmi-object","cdmi-queue","cpl+xml","cwl","dash+xml","dash-patch+xml","davmount+xml","dssc+der","dssc+xml","emma+xml","emotionml+xml","epub+zip","exi","express","fdf","fdt+xml","font-tdpfr","geo+json","gml+xml","gzip","hyperstudio","inkml+xml","ipfix","its+xml","java-archive","json","ld+json","lgr+xml","lost+xml","mac-binhex40","mads+xml","manifest+json","marc","marcxml+xml","mathematica","mathml+xml","mbox","media-policy-dataset+xml","mediaservercontrol+xml","metalink4+xml","mets+xml","mmt-aei+xml","mmt-usd+xml","mods+xml","mp21","mp4","msword","mxf","n-quads","n-triples","node","octet-stream","oda","oebps-package+xml","ogg","oxps","p2p-overlay+xml","patch-ops-error+xml","pdf","pgp-encrypted","pgp-keys","pgp-signature","pkcs10","pkcs7-mime","pkcs7-signature","pkcs8","pkix-attr-cert","pkix-cert","pkix-crl","pkix-pkipath","pkixcmp","pls+xml","postscript","provenance+xml","prs.cww","prs.xsf+xml","pskc+xml","rdf+xml","reginfo+xml","relax-ng-compact-syntax","resource-lists+xml","resource-lists-diff+xml","rls-services+xml","route-apd+xml","route-s-tsid+xml","route-usd+xml","rpki-ghostbusters","rpki-manifest","rpki-roa","rtf","sbml+xml","scvp-cv-request","scvp-cv-response","scvp-vp-request","scvp-vp-response","sdp","senml+xml","sensml+xml","set-payment-initiation","set-registration-initiation","shf+xml","sieve","smil+xml","sparql-query","sparql-results+xml","sql","srgs","srgs+xml","sru+xml","ssml+xml","swid+xml","tei+xml","thraud+xml","timestamped-data","trig","ttml+xml","urc-ressheet+xml","urc-targetdesc+xml","voicexml+xml","wasm","watcherinfo+xml","widget","wsdl+xml","wspolicy+xml","x-x509-ca-cert","xcap-att+xml","xcap-caps+xml","xcap-diff+xml","xcap-el+xml","xcap-ns+xml","xenc+xml","xfdf","xhtml+xml","xliff+xml","xml","xml-dtd","xop+xml","xslt+xml","xv+xml","yang","yin+xml","zip"],[Zr]:["3gpp","aac","amr","basic","mobile-xmf","mp4","mpeg","ogg"],[Qr]:["collection","otf","ttf","woff","woff2"],[es]:["aces","apng","avci","avcs","avif","bmp","cgm","dicom-rle","dpx","emf","fits","g3fax","gif","heic","heic-sequence","heif","heif-sequence","hej2k","hsj2","ief","jls","jp2","jpeg","jph","jphc","jpm","jpx","jxl","jxr","jxra","jxrs","jxs","jxsc","jxsi","jxss","ktx","ktx2","png","prs.btif","prs.pti","svg+xml","t38","tiff","tiff-fx","webp","wmf"],[ts]:["disposition-notification","global","global-delivery-status","global-disposition-notification","global-headers","rfc822"],[rs]:["3mf","gltf+json","gltf-binary","iges","jt","mesh","mtl","obj","prc","step+xml","step+zip","step-xml+zip","stl","u3d","vrml","x3d+fastinfoset","x3d+xml","x3d-vrml"],[ss]:["cache-manifest","calendar","css","csv","html","javascript","markdown","n3","plain","prs.lines.tag","richtext","rtf","sgml","shex","spdx","tab-separated-values","troff","turtle","uri-list","vcard","vtt","wgsl","xml"],[ns]:["3gpp","3gpp2","h261","h263","h264","iso.segment","jpeg","mj2","mp2t","mp4","mpeg","ogg","quicktime"]},is=e=>e.startsWith(".")?e.slice(1):e;var as=new Proxy({ez:[Xr,0],atom:[Xr,1],atomcat:[Xr,2],atomdeleted:[Xr,3],atomsvc:[Xr,4],dwd:[Xr,5],held:[Xr,6],rsat:[Xr,7],aml:[Xr,8],amlx:[Xr,9],xcs:[Xr,10],ccxml:[Xr,11],cdfx:[Xr,12],cdmia:[Xr,13],cdmic:[Xr,14],cdmid:[Xr,15],cdmio:[Xr,16],cdmiq:[Xr,17],cpl:[Xr,18],cwl:[Xr,19],mpd:[Xr,20],mpp:[Xr,21],davmount:[Xr,22],dssc:[Xr,23],xdssc:[Xr,24],emma:[Xr,25],emotionml:[Xr,26],epub:[Xr,27],exi:[Xr,28],exp:[Xr,29],fdf:[Xr,30],fdt:[Xr,31],pfr:[Xr,32],geojson:[Xr,33],gml:[Xr,34],gz:[Xr,35],stk:[Xr,36],ink:[Xr,37],inkml:[Xr,37],ipfix:[Xr,38],its:[Xr,39],jar:[Xr,40],war:[Xr,40],ear:[Xr,40],json:[Xr,41],map:[Xr,41],jsonld:[Xr,42],lgr:[Xr,43],lostxml:[Xr,44],hqx:[Xr,45],mads:[Xr,46],webmanifest:[Xr,47],mrc:[Xr,48],mrcx:[Xr,49],ma:[Xr,50],nb:[Xr,50],mb:[Xr,50],mathml:[Xr,51],mbox:[Xr,52],mpf:[Xr,53],mscml:[Xr,54],meta4:[Xr,55],mets:[Xr,56],maei:[Xr,57],musd:[Xr,58],mods:[Xr,59],m21:[Xr,60],mp21:[Xr,60],mp4:[Xr,61],mpg4:[Xr,61],mp4s:[Xr,61],m4p:[Xr,61],doc:[Xr,62],dot:[Xr,62],mxf:[Xr,63],nq:[Xr,64],nt:[Xr,65],cjs:[Xr,66],bin:[Xr,67],dms:[Xr,67],lrf:[Xr,67],mar:[Xr,67],so:[Xr,67],dist:[Xr,67],distz:[Xr,67],pkg:[Xr,67],bpk:[Xr,67],dump:[Xr,67],elc:[Xr,67],deploy:[Xr,67],exe:[Xr,67],dll:[Xr,67],deb:[Xr,67],dmg:[Xr,67],iso:[Xr,67],img:[Xr,67],msi:[Xr,67],msp:[Xr,67],msm:[Xr,67],buffer:[Xr,67],oda:[Xr,68],opf:[Xr,69],ogx:[Xr,70],oxps:[Xr,71],relo:[Xr,72],xer:[Xr,73],pdf:[Xr,74],pgp:[Xr,75],asc:[Xr,76],sig:[Xr,77],p10:[Xr,78],p7m:[Xr,79],p7c:[Xr,79],p7s:[Xr,80],p8:[Xr,81],ac:[Xr,82],cer:[Xr,83],crl:[Xr,84],pkipath:[Xr,85],pki:[Xr,86],pls:[Xr,87],ai:[Xr,88],eps:[Xr,88],ps:[Xr,88],provx:[Xr,89],cww:[Xr,90],xsf:[Xr,91],pskcxml:[Xr,92],rdf:[Xr,93],owl:[Xr,93],rif:[Xr,94],rnc:[Xr,95],rl:[Xr,96],rld:[Xr,97],rs:[Xr,98],rapd:[Xr,99],sls:[Xr,100],rusd:[Xr,101],gbr:[Xr,102],mft:[Xr,103],roa:[Xr,104],rtf:[Xr,105],sbml:[Xr,106],scq:[Xr,107],scs:[Xr,108],spq:[Xr,109],spp:[Xr,110],sdp:[Xr,111],senmlx:[Xr,112],sensmlx:[Xr,113],setpay:[Xr,114],setreg:[Xr,115],shf:[Xr,116],siv:[Xr,117],sieve:[Xr,117],smi:[Xr,118],smil:[Xr,118],rq:[Xr,119],srx:[Xr,120],sql:[Xr,121],gram:[Xr,122],grxml:[Xr,123],sru:[Xr,124],ssml:[Xr,125],swidtag:[Xr,126],tei:[Xr,127],teicorpus:[Xr,127],tfi:[Xr,128],tsd:[Xr,129],trig:[Xr,130],ttml:[Xr,131],rsheet:[Xr,132],td:[Xr,133],vxml:[Xr,134],wasm:[Xr,135],wif:[Xr,136],wgt:[Xr,137],wsdl:[Xr,138],wspolicy:[Xr,139],der:[Xr,140],crt:[Xr,140],pem:[Xr,140],xav:[Xr,141],xca:[Xr,142],xdf:[Xr,143],xel:[Xr,144],xns:[Xr,145],xenc:[Xr,146],xfdf:[Xr,147],xhtml:[Xr,148],xht:[Xr,148],xlf:[Xr,149],xml:[Xr,150],xsl:[Xr,150],xsd:[Xr,150],rng:[Xr,150],dtd:[Xr,151],xop:[Xr,152],xslt:[Xr,153],mxml:[Xr,154],xhvml:[Xr,154],xvml:[Xr,154],xvm:[Xr,154],yang:[Xr,155],yin:[Xr,156],zip:[Xr,157],"3gpp":[Zr,0],adts:[Zr,1],aac:[Zr,1],amr:[Zr,2],au:[Zr,3],snd:[Zr,3],mxmf:[Zr,4],m4a:[Zr,5],mp4a:[Zr,5],mpga:[Zr,6],mp2:[Zr,6],mp2a:[Zr,6],mp3:[Zr,6],m2a:[Zr,6],m3a:[Zr,6],oga:[Zr,7],ogg:[Zr,7],spx:[Zr,7],opus:[Zr,7],ttc:[Qr,0],otf:[Qr,1],ttf:[Qr,2],woff:[Qr,3],woff2:[Qr,4],exr:[es,0],apng:[es,1],avci:[es,2],avcs:[es,3],avif:[es,4],bmp:[es,5],dib:[es,5],cgm:[es,6],drle:[es,7],dpx:[es,8],emf:[es,9],fits:[es,10],g3:[es,11],gif:[es,12],heic:[es,13],heics:[es,14],heif:[es,15],heifs:[es,16],hej2:[es,17],hsj2:[es,18],ief:[es,19],jls:[es,20],jp2:[es,21],jpg2:[es,21],jpeg:[es,22],jpg:[es,22],jpe:[es,22],jph:[es,23],jhc:[es,24],jpm:[es,25],jpgm:[es,25],jpx:[es,26],jpf:[es,26],jxl:[es,27],jxr:[es,28],jxra:[es,29],jxrs:[es,30],jxs:[es,31],jxsc:[es,32],jxsi:[es,33],jxss:[es,34],ktx:[es,35],ktx2:[es,36],png:[es,37],btif:[es,38],btf:[es,38],pti:[es,39],svg:[es,40],svgz:[es,40],t38:[es,41],tif:[es,42],tiff:[es,42],tfx:[es,43],webp:[es,44],wmf:[es,45],"disposition-notification":[ts,0],u8msg:[ts,1],u8dsn:[ts,2],u8mdn:[ts,3],u8hdr:[ts,4],eml:[ts,5],mime:[ts,5],"3mf":[rs,0],gltf:[rs,1],glb:[rs,2],igs:[rs,3],iges:[rs,3],jt:[rs,4],msh:[rs,5],mesh:[rs,5],silo:[rs,5],mtl:[rs,6],obj:[rs,7],prc:[rs,8],stpx:[rs,9],stpz:[rs,10],stpxz:[rs,11],stl:[rs,12],u3d:[rs,13],wrl:[rs,14],vrml:[rs,14],x3db:[rs,15],x3d:[rs,16],x3dz:[rs,16],x3dv:[rs,17],appcache:[ss,0],manifest:[ss,0],ics:[ss,1],ifb:[ss,1],css:[ss,2],csv:[ss,3],html:[ss,4],htm:[ss,4],shtml:[ss,4],js:[ss,5],mjs:[ss,5],md:[ss,6],markdown:[ss,6],n3:[ss,7],txt:[ss,8],text:[ss,8],conf:[ss,8],def:[ss,8],list:[ss,8],log:[ss,8],in:[ss,8],ini:[ss,8],dsc:[ss,9],rtx:[ss,10],sgml:[ss,12],sgm:[ss,12],shex:[ss,13],spdx:[ss,14],tsv:[ss,15],t:[ss,16],tr:[ss,16],roff:[ss,16],man:[ss,16],me:[ss,16],ms:[ss,16],ttl:[ss,17],uri:[ss,18],uris:[ss,18],urls:[ss,18],vcard:[ss,19],vtt:[ss,20],wgsl:[ss,21],"3gp":[ns,0],"3g2":[ns,1],h261:[ns,2],h263:[ns,3],h264:[ns,4],m4s:[ns,5],jpgv:[ns,6],mj2:[ns,7],mjp2:[ns,7],ts:[ns,8],m2t:[ns,8],m2ts:[ns,8],mts:[ns,8],mp4v:[ns,9],mpeg:[ns,10],mpg:[ns,10],mpe:[ns,10],m1v:[ns,10],m2v:[ns,10],ogv:[ns,11],qt:[ns,12],mov:[ns,12]},{has:(e,t)=>e.hasOwnProperty(is(t)),get:(e,t)=>{const r=e[is(t)];return r&&`${r[0]}/${os[r[0]][r[1]]}`}});const{min:cs}=Math,ls=/^bytes=(\d+)-(\d*)/;const hs="apply",fs="ownKeys",us="destruct";var ds=!1;const{ArrayBuffer:ps,Atomics:ms,Promise:gs}=globalThis,{isArray:ys}=Array,{create:ws,getPrototypeOf:_s,values:bs}=Object,vs=_s(Int32Array);ws(ms);const xs="array",Ss="function",Es="null",ks="number",Os="object",Ts="string",Ps="symbol",js="undefined";let Ns=0;const Rs=new Map,Ls=new Map,Cs=e=>Ls.get(e),Is=e=>{if(!Rs.has(e)){let t;for(;Ls.has(t=Ns++););Rs.set(e,t),Ls.set(t,e)}return Rs.get(e)};var Bs=Object.fromEntries([xs,"bigint","boolean",Ss,Es,ks,Os,Ts,Ps,js].map(((e,t)=>[e,t])));const{[fs]:Ms}=Reflect,As=new Map(Ms(Symbol).filter((e=>typeof Symbol[e]===Ps)).map((e=>[Symbol[e],e]))),Us=e=>As.get(e)||`.${Symbol.keyFor(e)||""}`,Ws=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(`%c${String(t)}`,"font-weight:bold","collected"),e(t)})),$s=Object.create(null),{addEventListener:Ds}=EventTarget.prototype,Fs=new WeakMap;Reflect.defineProperty(EventTarget.prototype,"addEventListener",{value(e,t,...r){const s=r.at(0)?.invoke;if(s){let t=Fs.get(this);t||(t=new Map,Fs.set(this,t)),t.set(e,[].concat(s)),delete r[0].invoke}return Ds.call(this,e,t,...r)}});const{isArray:zs}=Array,qs=e=>{const t=typeof e;switch(t){case Os:return null===e?[Bs[Es],e]:e===globalThis?[Bs[Os],null]:zs(e)?[Bs[xs],Is(e)]:[Bs[Os],e instanceof vs?e:Is(e)];case Ss:return[Bs[Ss],Is(e)];case Ps:return[Bs[Ps],Us(e)];default:return[Bs[t],e]}};var Gs=(e,t)=>{const r=new Map,s=e=>{r.delete(e),t(us,e)},n=([e,o])=>{switch(e){case Bs[Os]:if(null===o)return globalThis;if(typeof o===ks)return Cs(o);if(!(o instanceof vs))for(const e in o)o[e]=n(o[e]);return o;case Bs[xs]:return typeof o===ks?Cs(o):o.map(n);case Bs[Ss]:switch(typeof o){case ks:return Cs(o);case Ts:{let e=r.get(o)?.deref();return e||(e=((e,t,{debug:r,handler:s,return:n,token:o=e}=$s)=>{const i=n||new Proxy(e,s||$s),a=[i,[t,e,!!r]];return!1!==o&&a.push(o),Ws.register(...a),i})(o,s,{token:!1,return:function(...e){return e.length&&e[0]instanceof Event&&(e=>{const{currentTarget:t,target:r,type:s}=e,n=Fs.get(t||r)?.get(s);if(n)for(const t of n)e[t]()})(e[0]),t(hs,o,qs(this),e.map(qs)).then(n)}}),r.set(o,new WeakRef(e))),e}}case Bs[Ps]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of As)if(r===e)return t})(o);default:return o}},o=t=>import(e(t));return(e,t,...r)=>{if(e===us)(e=>{const[t,r]=typeof e===ks?[Ls,Rs]:[Rs,Ls],s=t.has(e);s&&(r.delete(t.get(e)),t.delete(e))})(t);else{const s=Reflect[e],i=null==t?globalThis:Cs(t);switch(e){case"defineProperty":{const[e,t]=r.map(n);return qs(s(i,e,t))}case"getOwnPropertyDescriptor":{const e=s(i,...r.map(n));if(e){const{get:t,set:r,value:s}=e;t&&(e.get=qs(t)),r&&(e.set=qs(r)),s&&(e.value=qs(s))}return[Bs[e?Os:js],e]}case fs:return[Bs[xs],s(i).map(qs)];case"get":if(null==t&&"import"===r[0][1])return qs(o);default:return((e,t,r)=>qs(e(t,...r.map(n))))(s,i,r)}}}};const{parse:Vs,stringify:Hs}=JSON,Ys={data:null,stopImmediatePropagation(){},preventDefault(){}};var Js=(e,t)=>{const{parse:r=Vs,stringify:s=Hs}=t,n=new Map;let[o,i,a,c]=["",!0,0,null];return{onclose:()=>{for(const[e,t]of n)t();n.clear(),[o,i,a,c]=["",!0,0,null]},onmessage:async l=>{try{const h=r(String(l));if(Ys.data=h,((e,t)=>{const{data:r}=e,s=ys(r)&&(r.at(0)===t||0===r.at(1)&&!t);return s&&(e.stopImmediatePropagation(),e.preventDefault()),s})(Ys,o))if(i)i=!1,[o]=h,c=Gs(t?.import||String,((t,r,...i)=>{let c,l;return t===hs&&(({promise:c,resolve:l}=gs.withResolvers()),n.set(a,l),i.push(a++)),e.send(s([o,null,[t,r,...i]])),c})),e.send("");else{const[t,r,i,a,...l]=h;if(null==r)n.get(a)(...l),n.delete(a);else{let t;try{ds,t=await c(i,a,...l)}catch(e){t=e}e.send(s([o,r,t]))}}}catch(e){}}}};const[...Ks]=process.argv.slice(2),Xs={_:"",get $(){return this._||(this._=process.cwd())}},Zs=Ks.at(0)||a(Xs.$,"package.json");if("--help"===Zs||!t(Zs)){const e=+("--help"!==Zs);e&&console.error("[1mUnable to parse package.json[0m\n"),console[e?"error":"log"]("\nworkerful [options]\n\n[options]\n--help        # this message\npackage.json  # the package.json file at the root\n              # of your workerful project\n  ".trim()),process.exit(e)}const Qs=ne(r(Zs).toString("utf-8"));const{parse:en,stringify:tn}=JSON,{keys:rn}=Object,sn=String,nn="string",on={},an="object",cn=(e,t)=>t,ln=e=>e instanceof sn?sn(e):e,hn=(e,t)=>typeof t===nn?new sn(t):t,fn=(e,t,r,s)=>{const n=[];for(let o=rn(r),{length:i}=o,a=0;a<i;a++){const i=o[a],c=r[i];if(c instanceof sn){const o=e[c];typeof o!==an||t.has(o)?r[i]=s.call(r,i,o):(t.add(o),r[i]=on,n.push({k:i,a:[e,t,o,s]}))}else r[i]!==on&&(r[i]=s.call(r,i,c))}for(let{length:e}=n,t=0;t<e;t++){const{k:e,a:o}=n[t];r[e]=s.call(r,e,fn.apply(null,o))}return r},un=(e,t,r)=>{const s=sn(t.push(r)-1);return e.set(r,s),s},dn="object"==typeof self?self:globalThis,pn=e=>((e,t)=>{const r=(t,r)=>(e.set(r,t),t),s=n=>{if(e.has(n))return e.get(n);const[o,i]=t[n];switch(o){case 0:case-1:return r(i,n);case 1:{const e=r([],n);for(const t of i)e.push(s(t));return e}case 2:{const e=r({},n);for(const[t,r]of i)e[s(t)]=s(r);return e}case 3:return r(new Date(i),n);case 4:{const{source:e,flags:t}=i;return r(new RegExp(e,t),n)}case 5:{const e=r(new Map,n);for(const[t,r]of i)e.set(s(t),s(r));return e}case 6:{const e=r(new Set,n);for(const t of i)e.add(s(t));return e}case 7:{const{name:e,message:t}=i;return r(new dn[e](t),n)}case 8:return r(BigInt(i),n);case"BigInt":return r(Object(BigInt(i)),n)}return r(new dn[o](i),n)};return s})(new Map,e)(0),mn="",{toString:gn}={},{keys:yn}=Object,wn=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const r=gn.call(e).slice(8,-1);switch(r){case"Array":return[1,mn];case"Object":return[2,mn];case"Date":return[3,mn];case"RegExp":return[4,mn];case"Map":return[5,mn];case"Set":return[6,mn]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},_n=([e,t])=>0===e&&("function"===t||"symbol"===t),bn=(e,{json:t,lossy:r}={})=>{const s=[];return((e,t,r,s)=>{const n=(e,t)=>{const n=s.push(e)-1;return r.set(t,n),n},o=s=>{if(r.has(s))return r.get(s);let[i,a]=wn(s);switch(i){case 0:{let t=s;switch(a){case"bigint":i=8,t=s.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+a);t=null;break;case"undefined":return n([-1],s)}return n([i,t],s)}case 1:{if(a)return n([a,[...s]],s);const e=[],t=n([i,e],s);for(const t of s)e.push(o(t));return t}case 2:{if(a)switch(a){case"BigInt":return n([a,s.toString()],s);case"Boolean":case"Number":case"String":return n([a,s.valueOf()],s)}if(t&&"toJSON"in s)return o(s.toJSON());const r=[],c=n([i,r],s);for(const t of yn(s))!e&&_n(wn(s[t]))||r.push([o(t),o(s[t])]);return c}case 3:return n([i,s.toISOString()],s);case 4:{const{source:e,flags:t}=s;return n([i,{source:e,flags:t}],s)}case 5:{const t=[],r=n([i,t],s);for(const[r,n]of s)(e||!_n(wn(r))&&!_n(wn(n)))&&t.push([o(r),o(n)]);return r}case 6:{const t=[],r=n([i,t],s);for(const r of s)!e&&_n(wn(r))||t.push(o(r));return r}}const{message:c}=s;return n([i,{name:a,message:c}],s)};return o})(!(t||r),!!t,new Map,s)(e),s},{parse:vn,stringify:xn}=JSON,Sn={json:!0,lossy:!0};var En={json:JSON,circular:{parse:(e,t)=>{const r=en(e,hn).map(ln),s=r[0],n=t||cn,o=typeof s===an&&s?fn(r,new Set,s,n):s;return n.call({"":o},"",o)},stringify:(e,t,r)=>{const s=t&&typeof t===an?(e,r)=>""===e||-1<t.indexOf(e)?r:void 0:t||cn,n=new Map,o=[],i=[];let a=+un(n,o,s.call({"":e},"",e)),c=!a;for(;a<o.length;)c=!0,i[a]=tn(o[a++],l,r);return"["+i.join(",")+"]";function l(e,t){if(c)return c=!c,t;const r=s.call(this,e,t);switch(typeof r){case an:if(null===r)return r;case nn:return n.get(r)||un(n,o,r)}return r}}},structured:{parse:e=>pn(vn(e)),stringify:e=>xn(bn(e,Sn))}};const kn=Qs.workerful||(Qs.workerful={ip:"localhost",port:0,centered:!0,kiosk:!1,window:{}}),{WORKERFUL_CENTERED:On=!!kn.centered,WORKERFUL_IP:Tn=kn.ip||"localhost",WORKERFUL_PORT:Pn=kn.port||0,WORKERFUL_KIOSK:jn=kn.kiosk||!1,WORKERFUL_SERIALIZER:Nn=kn.serializer||"json"}=process.env,Rn=crypto.randomUUID(),Ln=Nn.toLowerCase();if(!(Ln in En))throw new Error(`Serializer ${Nn} is not json, circular or structured`);let Cn,In=Promise.resolve();const Bn=await(async(e,t)=>{const r=Qs.workerful?.server,s=r?(await import(c(Xs.$,r))).default:((e,t={})=>function r({method:s,url:n,headers:{range:o}={}},i){if("GET"!==s)return!1;const a=n.indexOf("?");-1<a&&(n=n.slice(0,a)),n.endsWith("/")&&(n+="index.html");const c=N(e+n,{throwIfNoEntry:!1});if(!c)return!1;if(c.isFile()){const{size:r}=c;let s=0;try{if(ls.test(o||"")){const{$1:o,$2:a}=RegExp,c=parseInt(o,10)||0;if(c>=r)throw s=416;let l=parseInt(a,10)||0;(!l||l>=r)&&(l=cs(r,c+1048576)-1),i.writeHead(s=206,{...t,"Accept-Range":"bytes","Content-Range":`bytes ${c}-${l}/${r}`,"Content-Length":l+1-c,"Content-Type":as[j(n)]}),R(e+n,{start:c,end:l}).pipe(i)}else i.writeHead(s=200,{...t,"Content-Length":r,"Content-Type":as[j(n)]}),R(e+n).pipe(i);return!0}catch(e){return!1}}return!!c.isDirectory()&&r({method:"GET",url:n+"/"},i)})(a(l(Zs),"public")),n=w((async(e,r)=>{try{if(t(e,r))return;if(await s(e,r))return;r.writeHead(404),r.end()}catch(e){console.error(e),r.writeHead(500),r.end()}}));return((e={})=>{const{bun:t,wss:r}=e;if(t){const t=new WeakMap;return{open(r){t.set(r,Js(r,e))},close(e,r,s){t.get(e).onclose(s)},message(e,r){t.get(e).onmessage(r)}}}r&&r.on("connection",(t=>{const{onclose:r,onmessage:s}=Js(t,e);t.prependListener("close",r),t.prependListener("message",s)}))})({wss:new Kr({server:n}),...e}),n})(En[Ln],((e,t)=>{const{url:r,method:n,headers:o}=e;if("GET"===n){if("/workerful"===r){let e,r={serializer:Ln};return e=o.referer.endsWith("/workerful.js")?`globalThis.workerful=${oe(r)};const e="1788c3c1-8ba6-4f70-bc8b-350c9901ca4c",t="="+e,r="-"+e,n=t+"-ws",s=r+"-ws",o="apply",a="construct",c="defineProperty",i="deleteProperty",l="get",u="getOwnPropertyDescriptor",f="getPrototypeOf",p="has",y="isExtensible",g="ownKeys",w="preventExtensions",h="set",d="setPrototypeOf";var b=Object.freeze({__proto__:null,APPLY:o,CONSTRUCT:a,DEFINE_PROPERTY:c,DELETE_PROPERTY:i,GET:l,GET_OWN_PROPERTY_DESCRIPTOR:u,GET_PROTOTYPE_OF:f,HAS:p,IS_EXTENSIBLE:y,OWN_KEYS:g,PREVENT_EXTENSION:w,SET:h,SET_PROTOTYPE_OF:d});const v="destruct",{ArrayBuffer:m,Atomics:E,Promise:O}=globalThis,{isArray:T}=Array,{create:S,getPrototypeOf:P,values:k}=Object,x=P(Int32Array),A=S(E),R=({currentTarget:e,type:t,origin:r,lastEventId:n,source:s,ports:o},a)=>e.dispatchEvent(new MessageEvent(t,{data:a,origin:r,lastEventId:n,source:s,ports:o})),j=()=>O.withResolvers();let M=0;const I=new Map,_=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&I.set(this,[M++,0,j()])}},N=new WeakSet,$=e=>(N.add(e),e),B=(e,t)=>{const{data:r}=e,n=T(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},W=e=>null!==e&&"object"==typeof e&&!N.has(e),D=new WeakMap,Y=(e,t,r)=>{if(I.has(e))t.set(e,I.get(e)[0]);else if(!(e instanceof x||e instanceof m))for(const n of k(e))W(n)&&!r.has(n)&&(r.add(n),Y(n,t,r))},L=(...e)=>({value:new O((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),z=(e,t)=>{const r=I.get(e),[n,s,{promise:o}]=r;return r[1]=t,[n,o]};let{BigInt64Array:J,Int32Array:C,SharedArrayBuffer:F,addEventListener:U,postMessage:H}=globalThis,G=!0,K=e=>e,X=!1;const q=j();try{new F(4),A.waitAsync||(A.waitAsync=L),q.resolve()}catch(e){const t=H,r=U,n=[];let s="",o="";F=class extends m{},J=_(J,F),C=_(C,F),K=$,X=!0,A.notify=(e,r)=>{const[n]=(e=>D.get(e))(e);return t([s,1,e,n,r]),0},A.waitAsync=(...e)=>{const[t,r]=z(...e);return{value:r}},A.wait=(e,t,...r)=>{const[n]=z(e,t,...r),a=new XMLHttpRequest;a.responseType="json",a.open("POST",\`\${o}?sabayon\`,!1),a.setRequestHeader("Content-Type","application/json"),a.send(\`["\${s}",\${n},\${t}]\`);const{response:c}=a;I.delete(e);for(let t=0;t<c.length;t++)e[t]=c[t];return"ok"},r("message",(e=>{if(B(e,s)){const[t,r,...n]=e.data;switch(r){case 0:s=t,o=n.at(0)?.serviceWorker||"",o||(A.wait=null,q.resolve());break;case 1:((e,t,r)=>{for(const[n,[s,o,{resolve:a}]]of I)if(t===s&&r===o){for(let t=0;t<e.length;t++)n[t]=e[t];I.delete(n),a("ok");break}})(...n);break;case 2:((e,t,r)=>{for(const[r,n]of t)D.set(r,[n,e.currentTarget]);R(e,r)})(e,...n);break;case 3:q.resolve()}}else if(G){const{currentTarget:t,type:r,origin:s,lastEventId:o,source:a,ports:c}=e;n.push([{currentTarget:t,type:r,origin:s,lastEventId:o,source:a,ports:c},e.data])}})),U=(e,...t)=>{if(r(e,...t),n.length)for(const e of n.splice(0))R(...e)},H=(e,...r)=>t(((e,t)=>{const r=new Map;return W(t)&&Y(t,r,new Set),r.size?[e,2,r,t]:t})(s,e),...r)}await q.promise,G=!1;const{BYTES_PER_ELEMENT:V}=Int32Array,{BYTES_PER_ELEMENT:Q}=Uint16Array,{notify:Z}=A,ee=new TextDecoder("utf-16"),te=new WeakSet,re=(...e)=>(te.add(e),e);let ne="";const se=(e,t,r,n)=>{const[s]=n,o=r.get(s);if(!o)throw new Error(\`Unknown proxy.\${s}()\`);e(o,t,n)};let oe=0;const ae=([e,t,r,n,s,o,a,c,i],l)=>(...u)=>{let f=""!==ne,p=0;f&&"="!==ne[0]&&"-"!==ne[0]&&(p=((e,t)=>setTimeout(console.warn,3e3,\`💀🔒 - proxy.\${e}() in proxy.\${t}()\`))(l,ne));const y=oe++,g=[];te.has(u.at(-1)||g)&&te.delete(g=u.pop());const w=r(c?u.map(c):u);let h=t(2*V);return a([e,2,l,y,h,w,n],{transfer:g}),i(h,0).value.then((()=>{f&&clearTimeout(p);const r=h[1];if(!r)return;const n=Q*r;return h=t(n+n%V),a([e,1,y,h]),i(h,0).value.then((()=>{const e=new Uint16Array(h.buffer),t=o?e.subarray(0,r):e.slice(0,r);return s(ee.decode(t))}))}))},ce=(e,t)=>new Proxy(t,{get:(t,r)=>{let n;return"then"!==r&&(n=t.get(r),n||(n=ae(e,r),t.set(r,n))),n},set:(e,t,r)=>"then"!==t&&!!e.set(t,r)}),{wait:ie,waitAsync:le}=A;var ue=({parse:e,stringify:t,transform:r,interrupt:n}=JSON)=>{const s=((e,t)=>async(r,n,[s,o,a,c,i])=>{i&&(ne=s);try{const s=await r(...c);if(void 0!==s){const r=e(t?t(s):s);n.set(o,r),a[1]=r.length}}finally{i&&(ne=""),a[0]=1,Z(a,0)}})(t,r),o=j(),a=new Map,c=new Map;let i="",l=ie;if(ie&&n){const{handler:e,timeout:t=42}=n;l=(r,n,s)=>{for(;"timed-out"===(s=ie(r,n,0,t));)e();return s}}return U("message",(t=>{if(B(t,i)){const[n,u,...f]=t.data;switch(u){case 0:{const t=!!ie;i=n,o.resolve({polyfill:X,sync:t,transfer:re,proxy:ce([i,e=>new C(new F(e)),K,t,e,X,H,r,t?(...e)=>({value:{then:t=>t(l(...e))}}):le],a)});break}case 2:a.size?se(s,c,a,f):setTimeout(se,0,s,c,a,f);break;case 1:((e,[t,r])=>{const n=e.get(t);e.delete(t);for(let e=new Uint16Array(r.buffer),t=0,{length:s}=n;t<s;t++)e[t]=n.charCodeAt(t);Z(r,0)})(c,f)}}})),o.promise};const fe="array",pe="function",ye="null",ge="number",we="object",he="symbol",de="undefined";function be(){return this}const ve=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(\`Held value \${String(t)} not relevant anymore\`),e(t)})),me=Object.create(null),{Object:Ee,Proxy:Oe,Reflect:Te}=globalThis,{isArray:Se}=Array,{ownKeys:Pe}=Te,{create:ke,hasOwn:xe,values:Ae}=Ee,Re=(e,t)=>t===fe?e[0]:t===pe?e():t===we?e.$:e,je=(e,t,r,n)=>{const s={type:{value:t}},o=xe(e,"valueOf");for(const a of Ae(b)){let c=n(e[a]||Te[a]);if(o&&a===l){const{valueOf:n}=e,{value:s}=c;c={value(e,o,...a){return o===r?n.call(this,Re(e,t)):s.call(this,e,o,...a)}}}s[a]=c}return ke(e,s)},Me=(e,t,r,n=e)=>{if(n===e)switch(typeof e){case we:case de:n||(n=!1);case pe:break;default:n=!1,t===e&&(t=Ee(e))}const s=new Oe(t,r),{destruct:o}=r;return o?((e,t,{debug:r,handler:n,return:s,token:o=e}=me)=>{const a=s||new Proxy(e,n||me),c=[a,[t,e,!!r]];return!1!==o&&c.push(o),ve.register(...c),a})(e,o,{token:n,return:s}):s},Ie=e=>t=>{const r=typeof t;return r===we?t?e.get(t)?.[0]??(e=>Se(e)?fe:we)(t):ye:r},_e=e=>t=>{let r=typeof t;switch(r){case we:if(!t){r=ye;break}case pe:const n=e.get(t);n&&([r,t]=n)}return[r,t]},Ne=e=>((e=>{ve.unregister(e)})(e),e);var $e=e=>{const t=new WeakMap,r=Symbol(),n={},s=(e,r,n)=>(t.set(e,[r,n]),e),o={proxy:n,release:Ne,pair:_e(t),typeOf:Ie(t),isProxy:e=>t.has(e),valueOf:e=>e[r]??e.valueOf()};for(const t of Pe(e)){if(xe(o,t))continue;const a=e[t];switch(t){case fe:{const e=je(a,t,r,(e=>({value([t],...r){return e.call(this,t,...r)}})));n[t]=(t,...r)=>s(Me(t,[t],e,...r),fe,t);break}case pe:{const e=je(a,t,r,(e=>({value(t,...r){return e.call(this,t(),...r)}})));n[t]=(t,...r)=>{return s(Me(t,(n=t,be.bind(n)),e,...r),pe,t);var n};break}case we:{const e=je(a,t,r,(e=>({value({$:t},...r){return e.call(this,t,...r)}})));n[t]=(t,...r)=>s(Me(t,{$:t},e,...r),we,t);break}default:{const e=je(a,t,r,(e=>({value:e})));n[t]=(r,...n)=>s(Me(r,r,e,...n),t,r);break}}}return o};let Be=0;const We=new Map,De=new Map,Ye=e=>De.get(e),Le=e=>{if(!We.has(e)){let t;for(;De.has(t=Be++););We.set(e,t),De.set(t,e)}return We.get(e)};var ze=Object.fromEntries([fe,"bigint","boolean",pe,ye,ge,we,"string",he,de].map(((e,t)=>[e,t])));const{[g]:Je}=Reflect,Ce=new Map(Je(Symbol).filter((e=>typeof Symbol[e]===he)).map((e=>[Symbol[e],e]))),Fe=e=>Ce.get(e)||\`.\${Symbol.keyFor(e)||""}\`,{isArray:Ue}=Array,{[o]:He}=Reflect;var Ge=(e,t)=>{const r=new Map,n=(e,t)=>{let n=r.get(e)?.deref();return n||r.set(e,new WeakRef(n=t(e))),n},s=([e,t])=>{switch(e){case ze[we]:return null==t?globalThis:typeof t===ge?n(t,T.object):t;case ze[fe]:return typeof t===ge?n(t,T.array):t;case ze[pe]:return typeof t===ge?n(t,T.function):Ye(parseInt(t));case ze[he]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of Ce)if(r===e)return t})(t);default:return t}},b=e=>{let[r,n]=P(e);switch(r){case we:if(n==globalThis||null==n)n=null;else if(typeof n===we&&!(n instanceof x))if(n=t(n),Ue(n))n=n.map(b);else for(const e in n)n[e]=b(n[e]);return[ze[we],n];case fe:return[ze[fe],typeof n===ge?n:t(n).map(b)];case pe:return[ze[pe],typeof n===pe?String(Le(t(n))):n];case he:return[ze[he],Fe(e)];default:return[ze[r],n]}},m=(...t)=>s(e(...t)),E={[c]:(e,t,r)=>m(c,e,b(t),b(r)),[i]:(e,t)=>m(i,e,b(t)),[l]:(e,t)=>m(l,e,b(t)),[f]:e=>m(f,e),[u]:(e,t)=>{const r=m(u,e,b(t));if(r){const{get:e,set:t,value:n}=r;e&&(r.get=s(e)),t&&(r.set=s(t)),n&&(r.value=s(n))}return r},[p]:(e,t)=>m(p,e,b(t)),[y]:e=>m(y,e),[g]:e=>m(g,e).map(s),[w]:e=>m(w,e),[h]:(e,t,r)=>m(h,e,b(t),b(r)),[d]:(e,t)=>m(d,e,b(t)),[v](t){r.delete(t),e(v,t)}},O={[we]:E,[fe]:E,[pe]:{...E,[o]:(e,...t)=>m(o,e,...t.map(b)),[a]:(e,...t)=>m(a,e,...t.map(b))}},{proxy:T,isProxy:S,pair:P}=$e(O);return{isProxy:S,global:T.object(null),method:async(e,t,...r)=>{const n=parseInt(t);switch(e){case o:{const[e,t]=r;return b(await He(Ye(n),s(e),t.map(s)))}case v:(e=>{const[t,r]=typeof e===ge?[De,We]:[We,De],n=t.has(e);n&&(r.delete(t.get(e)),t.delete(e))})(n)}}}};const{parse:Ke,stringify:Xe}=JSON,{keys:qe}=Object,Ve=String,Qe="string",Ze={},et="object",tt=(e,t)=>t,rt=e=>e instanceof Ve?Ve(e):e,nt=(e,t)=>typeof t===Qe?new Ve(t):t,st=(e,t,r,n)=>{const s=[];for(let o=qe(r),{length:a}=o,c=0;c<a;c++){const a=o[c],i=r[a];if(i instanceof Ve){const o=e[i];typeof o!==et||t.has(o)?r[a]=n.call(r,a,o):(t.add(o),r[a]=Ze,s.push({k:a,a:[e,t,o,n]}))}else r[a]!==Ze&&(r[a]=n.call(r,a,i))}for(let{length:e}=s,t=0;t<e;t++){const{k:e,a:o}=s[t];r[e]=n.call(r,e,st.apply(null,o))}return r},ot=(e,t,r)=>{const n=Ve(t.push(r)-1);return e.set(r,n),n},at="object"==typeof self?self:globalThis,ct=e=>((e,t)=>{const r=(t,r)=>(e.set(r,t),t),n=s=>{if(e.has(s))return e.get(s);const[o,a]=t[s];switch(o){case 0:case-1:return r(a,s);case 1:{const e=r([],s);for(const t of a)e.push(n(t));return e}case 2:{const e=r({},s);for(const[t,r]of a)e[n(t)]=n(r);return e}case 3:return r(new Date(a),s);case 4:{const{source:e,flags:t}=a;return r(new RegExp(e,t),s)}case 5:{const e=r(new Map,s);for(const[t,r]of a)e.set(n(t),n(r));return e}case 6:{const e=r(new Set,s);for(const t of a)e.add(n(t));return e}case 7:{const{name:e,message:t}=a;return r(new at[e](t),s)}case 8:return r(BigInt(a),s);case"BigInt":return r(Object(BigInt(a)),s)}return r(new at[o](a),s)};return n})(new Map,e)(0),it="",{toString:lt}={},{keys:ut}=Object,ft=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const r=lt.call(e).slice(8,-1);switch(r){case"Array":return[1,it];case"Object":return[2,it];case"Date":return[3,it];case"RegExp":return[4,it];case"Map":return[5,it];case"Set":return[6,it]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},pt=([e,t])=>0===e&&("function"===t||"symbol"===t),yt=(e,{json:t,lossy:r}={})=>{const n=[];return((e,t,r,n)=>{const s=(e,t)=>{const s=n.push(e)-1;return r.set(t,s),s},o=n=>{if(r.has(n))return r.get(n);let[a,c]=ft(n);switch(a){case 0:{let t=n;switch(c){case"bigint":a=8,t=n.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);t=null;break;case"undefined":return s([-1],n)}return s([a,t],n)}case 1:{if(c)return s([c,[...n]],n);const e=[],t=s([a,e],n);for(const t of n)e.push(o(t));return t}case 2:{if(c)switch(c){case"BigInt":return s([c,n.toString()],n);case"Boolean":case"Number":case"String":return s([c,n.valueOf()],n)}if(t&&"toJSON"in n)return o(n.toJSON());const r=[],i=s([a,r],n);for(const t of ut(n))!e&&pt(ft(n[t]))||r.push([o(t),o(n[t])]);return i}case 3:return s([a,n.toISOString()],n);case 4:{const{source:e,flags:t}=n;return s([a,{source:e,flags:t}],n)}case 5:{const t=[],r=s([a,t],n);for(const[r,s]of n)(e||!pt(ft(r))&&!pt(ft(s)))&&t.push([o(r),o(s)]);return r}case 6:{const t=[],r=s([a,t],n);for(const r of n)!e&&pt(ft(r))||t.push(o(r));return r}}const{message:i}=n;return s([a,{name:c,message:i}],n)};return o})(!(t||r),!!t,new Map,n)(e),n},{parse:gt,stringify:wt}=JSON,ht={json:!0,lossy:!0};var dt={json:JSON,circular:{parse:(e,t)=>{const r=Ke(e,nt).map(rt),n=r[0],s=t||tt,o=typeof n===et&&n?st(r,new Set,n,s):n;return s.call({"":o},"",o)},stringify:(e,t,r)=>{const n=t&&typeof t===et?(e,r)=>""===e||-1<t.indexOf(e)?r:void 0:t||tt,s=new Map,o=[],a=[];let c=+ot(s,o,n.call({"":e},"",e)),i=!c;for(;c<o.length;)i=!0,a[c]=Xe(o[c++],l,r);return"["+a.join(",")+"]";function l(e,t){if(i)return i=!i,t;const r=n.call(this,e,t);switch(typeof r){case et:if(null===r)return r;case Qe:return s.get(r)||ot(s,o,r)}return r}}},structured:{parse:e=>ct(gt(e)),stringify:e=>wt(yt(e,ht))}};const{workerful:bt}=globalThis;delete globalThis.workerful;const{server:vt,window:mt}=await(async e=>{const o=await(async e=>{const n=await ue(e),{isProxy:s,global:o,method:a}=Ge(n.proxy[t],e?.transform||(e=>e));return n.proxy[r]=a,{...n,window:o,isWindowProxy:s}})(e),{isProxy:a,global:c,method:i}=Ge(o.proxy[n],e?.transform||(e=>e));return o.proxy[s]=i,{...o,server:c,isServerProxy:a}})(dt[bt.serializer]);export{vt as server,mt as window};\n`:`globalThis.workerful=${oe({...r,ws:Cn,secret:Rn,centered:"always"===On||se(On)})};!function(){"use strict";const e="apply",t="ownKeys",r="destruct",n="1788c3c1-8ba6-4f70-bc8b-350c9901ca4c",s="="+n,o="-"+n,a=s+"-ws",c=o+"-ws";const{ArrayBuffer:i,Atomics:l,Promise:u}=globalThis,{isArray:f}=Array,{create:p,getPrototypeOf:g,values:d}=Object,h=g(Int32Array),y=p(l),w=()=>u.withResolvers();let m=0;const b=new Map,v=(e,t)=>class extends e{constructor(e,...r){super(e,...r),e instanceof t&&b.set(this,[m++,0,w()])}},k=new WeakSet,E=e=>(k.add(e),e),S=(e,t)=>{const{data:r}=e,n=f(r)&&(r.at(0)===t||0===r.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},M=e=>null!==e&&"object"==typeof e&&!k.has(e),A=new WeakMap,T=(e,t,r)=>{if(b.has(e))t.set(e,b.get(e)[0]);else if(!(e instanceof h||e instanceof i))for(const n of d(e))M(n)&&!r.has(n)&&(r.add(n),T(n,t,r))},j=(...e)=>({value:new u((t=>{let r=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");r.onmessage=()=>t("ok"),r.postMessage(e)}))}),O=(e,t,r)=>{for(const[r,n]of t)A.set(r,[n,e.currentTarget]);(({currentTarget:e,type:t,origin:r,lastEventId:n,source:s,ports:o},a)=>{e.dispatchEvent(new MessageEvent(t,{data:a,origin:r,lastEventId:n,source:s,ports:o}))})(e,r)};let{BigInt64Array:W,Int32Array:x,SharedArrayBuffer:I,Worker:R}=globalThis,U=e=>e,B=!1;const D=e=>({...e,type:"module"});try{new I(4),R=class extends R{constructor(e,t){super(e,D(t))}},y.waitAsync||(y.waitAsync=j)}catch(e){const t=crypto.randomUUID(),r=new Map,n=(e,t,r,...n)=>{e.addEventListener(t,r,...n)},s=({serviceWorker:e},s,o)=>{let a,c=!0;n(e,"message",(e=>{if(S(e,t)){const[n,s,o]=e.data,c=[s,o].join(","),i=e=>{r.delete(c),a.postMessage([t,s,o,e])},l=r.get(c);if(l)i(l);else{const{promise:e,resolve:t}=w();r.set(c,t),e.then(i)}}})),e.getRegistration(s).then((t=>t??e.register(s))).then((function t(r){c=c&&!!e.controller,a=r.installing||r.waiting||r.active,"activated"===a.state?c?o():location.reload():n(a,"statechange",(()=>t(r)),{once:!0})}))};U=E,B=!0,y.notify=(e,n)=>{const[s,o]=(e=>A.get(e))(e),a=[s,n].join(","),c=r.get(a);return c?c(e):r.set(a,e),o.postMessage([t,1,e,s,n]),0},y.waitAsync=(e,...t)=>{const[r,n]=((e,t)=>{const r=b.get(e),[n,s,{promise:o}]=r;return r[1]=t,[n,o]})(e,...t);return{value:n}},I=class extends i{},W=v(W,I),x=v(x,I);let o=null;R=class extends R{constructor(e,r){let a=r?.serviceWorker||"";if(a){if(a=new URL(a,location.href).href,r={...r,serviceWorker:a},!o){const{promise:e,resolve:t}=w();s(navigator,a,t),o=e}o.then((()=>super.postMessage([t,3])))}super(e,D(r)),super.postMessage([t,0,r]),n(this,"message",(e=>{if(S(e,t)){const[t,r,...n]=e.data;switch(r){case 1:((e,t,r)=>{for(const[n,[s,o,{resolve:a}]]of b)if(t===s&&r===o){for(let t=0;t<e.length;t++)n[t]=e[t];b.delete(n),a("ok");break}})(...n);break;case 2:O(e,...n)}}}))}postMessage(e,...r){return super.postMessage(((e,t)=>{const r=new Map;return M(t)&&T(t,r,new Set),r.size?[e,2,r,t]:t})(t,e),...r)}}}const{BYTES_PER_ELEMENT:L}=Int32Array,{BYTES_PER_ELEMENT:P}=Uint16Array,{notify:N}=y,$=new TextDecoder("utf-16"),J=new WeakSet,_=(...e)=>(J.add(e),e);let z="";let Y=0;const C=([e,t,r,n,s,o,a,c,i],l)=>(...u)=>{let f=""!==z,p=0;f&&"="!==z[0]&&"-"!==z[0]&&(p=((e,t)=>setTimeout(console.warn,3e3,\`💀🔒 - proxy.\${e}() in proxy.\${t}()\`))(l,z));const g=Y++,d=[];J.has(u.at(-1)||d)&&J.delete(d=u.pop());const h=r(c?u.map(c):u);let y=t(2*L);return a([e,2,l,g,y,h,n],{transfer:d}),i(y,0).value.then((()=>{f&&clearTimeout(p);const r=y[1];if(!r)return;const n=P*r;return y=t(n+n%L),a([e,1,g,y]),i(y,0).value.then((()=>{const e=new Uint16Array(y.buffer),t=o?e.subarray(0,r):e.slice(0,r);return s($.decode(t))}))}))};var F=({parse:e,stringify:t,transform:r}=JSON)=>{const n=((e,t)=>async(r,n,[s,o,a,c,i])=>{i&&(z=s);try{const s=await r(...c);if(void 0!==s){const r=e(t?t(s):s);n.set(o,r),a[1]=r.length}}finally{i&&(z=""),a[0]=1,N(a,0)}})(t,r),s=crypto.randomUUID();return{Worker:class extends R{constructor(t,o){const a=new Map,c=new Map;super(t,o),this.proxy=((e,t)=>new Proxy(t,{get:(t,r)=>{let n;return"then"!==r&&(n=t.get(r),n||(n=C(e,r),t.set(r,n))),n},set:(e,t,r)=>"then"!==t&&!!e.set(t,r)}))([s,e=>new x(new I(e)),U,!1,e,B,(...e)=>this.postMessage(...e),r,y.waitAsync],a),this.postMessage(U([s,0,o])),this.addEventListener("message",(e=>{if(S(e,s)){const[t,r,...s]=e.data;switch(r){case 2:((e,t,r,n)=>{const[s]=n,o=r.get(s);if(!o)throw new Error(\`Unknown proxy.\${s}()\`);e(o,t,n)})(n,c,a,s);break;case 1:((e,[t,r])=>{const n=e.get(t);e.delete(t);for(let e=new Uint16Array(r.buffer),t=0,{length:s}=n;t<s;t++)e[t]=n.charCodeAt(t);N(r,0)})(c,s)}}}))}},polyfill:B,transfer:_}};const H="array",K="function",X="null",q="number",G="object",Q="string",V="symbol",Z="undefined";let ee=0;const te=new Map,re=new Map,ne=e=>re.get(e),se=e=>{if(!te.has(e)){let t;for(;re.has(t=ee++););te.set(e,t),re.set(t,e)}return te.get(e)};var oe=Object.fromEntries([H,"bigint","boolean",K,X,q,G,Q,V,Z].map(((e,t)=>[e,t])));const{[t]:ae}=Reflect,ce=new Map(ae(Symbol).filter((e=>typeof Symbol[e]===V)).map((e=>[Symbol[e],e]))),ie=e=>ce.get(e)||\`.\${Symbol.keyFor(e)||""}\`,le=new FinalizationRegistry((([e,t,r])=>{r&&console.debug(\`%c\${String(t)}\`,"font-weight:bold","collected"),e(t)})),ue=Object.create(null),{addEventListener:fe}=EventTarget.prototype,pe=new WeakMap;Reflect.defineProperty(EventTarget.prototype,"addEventListener",{value(e,t,...r){const n=r.at(0)?.invoke;if(n){let t=pe.get(this);t||(t=new Map,pe.set(this,t)),t.set(e,[].concat(n)),delete r[0].invoke}return fe.call(this,e,t,...r)}});const{isArray:ge}=Array,de=e=>{const t=typeof e;switch(t){case G:return null===e?[oe[X],e]:e===globalThis?[oe[G],null]:ge(e)?[oe[H],se(e)]:[oe[G],e instanceof h?e:se(e)];case K:return[oe[K],se(e)];case V:return[oe[V],ie(e)];default:return[oe[t],e]}};var he=(n,s)=>{const o=new Map,a=e=>{o.delete(e),s(r,e)},c=([t,r])=>{switch(t){case oe[G]:if(null===r)return globalThis;if(typeof r===q)return ne(r);if(!(r instanceof h))for(const e in r)r[e]=c(r[e]);return r;case oe[H]:return typeof r===q?ne(r):r.map(c);case oe[K]:switch(typeof r){case q:return ne(r);case Q:{let t=o.get(r)?.deref();return t||(t=((e,t,{debug:r,handler:n,return:s,token:o=e}=ue)=>{const a=s||new Proxy(e,n||ue),c=[a,[t,e,!!r]];return!1!==o&&c.push(o),le.register(...c),a})(r,a,{token:!1,return:function(...t){return t.length&&t[0]instanceof Event&&(e=>{const{currentTarget:t,target:r,type:n}=e,s=pe.get(t||r)?.get(n);if(s)for(const t of s)e[t]()})(t[0]),s(e,r,de(this),t.map(de)).then(c)}}),o.set(r,new WeakRef(t))),t}}case oe[V]:return(e=>{if(e.startsWith("."))return Symbol.for(e.slice(1));for(const[t,r]of ce)if(r===e)return t})(r);default:return r}},i=e=>import(n(e));return(e,n,...s)=>{if(e===r)(e=>{const[t,r]=typeof e===q?[re,te]:[te,re],n=t.has(e);n&&(r.delete(t.get(e)),t.delete(e))})(n);else{const r=Reflect[e],o=null==n?globalThis:ne(n);switch(e){case"defineProperty":{const[e,t]=s.map(c);return de(r(o,e,t))}case"getOwnPropertyDescriptor":{const e=r(o,...s.map(c));if(e){const{get:t,set:r,value:n}=e;t&&(e.get=de(t)),r&&(e.set=de(r)),n&&(e.value=de(n))}return[oe[e?G:Z],e]}case t:return[oe[H],r(o).map(de)];case"get":if(null==n&&"import"===s[0][1])return de(i);default:return((e,t,r)=>de(e(t,...r.map(c))))(r,o,s)}}}},ye=e=>{const t=e?.import,r=F(e);class n extends r.Worker{constructor(e,r){const{proxy:n}=super(e,r);n[s]=he(r?.import||t||(e=>new URL(e,location.href)),n[o])}}return{...r,Worker:n}};class we{constructor(e,t){this._=e,this.$=t}get data(){return this.$}preventDefault(){this._.preventDefault()}stopImmediatePropagation(){this._.stopImmediatePropagation()}}const{WebSocket:me}=globalThis,{parse:be,stringify:ve}=JSON;const{parse:ke,stringify:Ee}=JSON,{keys:Se}=Object,Me=String,Ae="string",Te={},je="object",Oe=(e,t)=>t,We=e=>e instanceof Me?Me(e):e,xe=(e,t)=>typeof t===Ae?new Me(t):t,Ie=(e,t,r,n)=>{const s=[];for(let o=Se(r),{length:a}=o,c=0;c<a;c++){const a=o[c],i=r[a];if(i instanceof Me){const o=e[i];typeof o!==je||t.has(o)?r[a]=n.call(r,a,o):(t.add(o),r[a]=Te,s.push({k:a,a:[e,t,o,n]}))}else r[a]!==Te&&(r[a]=n.call(r,a,i))}for(let{length:e}=s,t=0;t<e;t++){const{k:e,a:o}=s[t];r[e]=n.call(r,e,Ie.apply(null,o))}return r},Re=(e,t,r)=>{const n=Me(t.push(r)-1);return e.set(r,n),n},Ue="object"==typeof self?self:globalThis,Be=e=>((e,t)=>{const r=(t,r)=>(e.set(r,t),t),n=s=>{if(e.has(s))return e.get(s);const[o,a]=t[s];switch(o){case 0:case-1:return r(a,s);case 1:{const e=r([],s);for(const t of a)e.push(n(t));return e}case 2:{const e=r({},s);for(const[t,r]of a)e[n(t)]=n(r);return e}case 3:return r(new Date(a),s);case 4:{const{source:e,flags:t}=a;return r(new RegExp(e,t),s)}case 5:{const e=r(new Map,s);for(const[t,r]of a)e.set(n(t),n(r));return e}case 6:{const e=r(new Set,s);for(const t of a)e.add(n(t));return e}case 7:{const{name:e,message:t}=a;return r(new Ue[e](t),s)}case 8:return r(BigInt(a),s);case"BigInt":return r(Object(BigInt(a)),s)}return r(new Ue[o](a),s)};return n})(new Map,e)(0),De="",{toString:Le}={},{keys:Pe}=Object,Ne=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const r=Le.call(e).slice(8,-1);switch(r){case"Array":return[1,De];case"Object":return[2,De];case"Date":return[3,De];case"RegExp":return[4,De];case"Map":return[5,De];case"Set":return[6,De]}return r.includes("Array")?[1,r]:r.includes("Error")?[7,r]:[2,r]},$e=([e,t])=>0===e&&("function"===t||"symbol"===t),Je=(e,{json:t,lossy:r}={})=>{const n=[];return((e,t,r,n)=>{const s=(e,t)=>{const s=n.push(e)-1;return r.set(t,s),s},o=n=>{if(r.has(n))return r.get(n);let[a,c]=Ne(n);switch(a){case 0:{let t=n;switch(c){case"bigint":a=8,t=n.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+c);t=null;break;case"undefined":return s([-1],n)}return s([a,t],n)}case 1:{if(c)return s([c,[...n]],n);const e=[],t=s([a,e],n);for(const t of n)e.push(o(t));return t}case 2:{if(c)switch(c){case"BigInt":return s([c,n.toString()],n);case"Boolean":case"Number":case"String":return s([c,n.valueOf()],n)}if(t&&"toJSON"in n)return o(n.toJSON());const r=[],i=s([a,r],n);for(const t of Pe(n))!e&&$e(Ne(n[t]))||r.push([o(t),o(n[t])]);return i}case 3:return s([a,n.toISOString()],n);case 4:{const{source:e,flags:t}=n;return s([a,{source:e,flags:t}],n)}case 5:{const t=[],r=s([a,t],n);for(const[r,s]of n)(e||!$e(Ne(r))&&!$e(Ne(s)))&&t.push([o(r),o(s)]);return r}case 6:{const t=[],r=s([a,t],n);for(const r of n)!e&&$e(Ne(r))||t.push(o(r));return r}}const{message:i}=n;return s([a,{name:c,message:i}],n)};return o})(!(t||r),!!t,new Map,n)(e),n},{parse:_e,stringify:ze}=JSON,Ye={json:!0,lossy:!0};var Ce={json:JSON,circular:{parse:(e,t)=>{const r=ke(e,xe).map(We),n=r[0],s=t||Oe,o=typeof n===je&&n?Ie(r,new Set,n,s):n;return s.call({"":o},"",o)},stringify:(e,t,r)=>{const n=t&&typeof t===je?(e,r)=>""===e||-1<t.indexOf(e)?r:void 0:t||Oe,s=new Map,o=[],a=[];let c=+Re(s,o,n.call({"":e},"",e)),i=!c;for(;c<o.length;)i=!0,a[c]=Ee(o[c++],l,r);return"["+a.join(",")+"]";function l(e,t){if(i)return i=!i,t;const r=n.call(this,e,t);switch(typeof r){case je:if(null===r)return r;case Ae:return s.get(r)||Re(s,o,r)}return r}}},structured:{parse:e=>Be(_e(e)),stringify:e=>ze(Je(e,Ye))}};try{new SharedArrayBuffer(4)}catch({message:e}){alert(e),close()}const{workerful:Fe}=globalThis;if(delete globalThis.workerful,addEventListener("beforeunload",(()=>{navigator.sendBeacon(\`/\${Fe.secret}?\${encodeURIComponent(JSON.stringify({position:[screenX,screenY],size:[innerWidth,innerHeight]}))}\`)})),Fe.centered){const{width:e,height:t}=screen,r=(e-innerWidth)/2,n=(t-innerHeight)/2;moveTo(r,n)}const{Worker:He}=(t=>{t={parse:be,stringify:ve,...t};const{parse:r,stringify:n,ws:s}=t,o=ye(t);class i extends o.Worker{#e=null;constructor(t,...o){let i=0;const l=crypto.randomUUID(),u=new Map,{proxy:f}=super(t,...o),{[c]:p}=f,{promise:g,resolve:d}=w(),h=this.#e=new me(s);f[a]=async(...e)=>{await g;const{promise:t,resolve:r}=w();return u.set(i,r),h.send(n([l,i++,...e])),t},h.addEventListener("close",(()=>{super.terminate()})),h.addEventListener("open",(()=>{h.send(n([l,0]))})),h.addEventListener("message",(async t=>{t.data||d();try{const s=r(t.data);if(S(new we(t,s),l)){let[t,r,o]=s;if(null==r){const[t,s,...a]=o,c=t===e;c&&(r=a.pop());try{o=await p(t,s,...a)}catch(e){o=e}c&&h.send(n([l,null,t,r,o]))}else u.get(r)(o),u.delete(r)}}catch(e){}}))}terminate(){this.#e.close(),super.terminate()}}return{...o,Worker:i}})({ws:Fe.ws,...Ce[Fe.serializer]});new He("/workerful.js")}();\n`,t.writeHead(200,{"Content-Type":"text/javascript;charset=utf-8"}),t.end(e),!0}}else if("POST"===n){const e=`/${Rn}?`;if(r.startsWith(e)){if(jn)return;const{promise:t,resolve:n}=Promise.withResolvers();In=t;try{Object.assign(kn.window,ne(decodeURIComponent(r.slice(e.length)))),"always"!==kn.centered&&(kn.centered=!1),s(Zs,`${oe(Qs,null,"\t")}\n`)}finally{n()}return!0}}return!1}));Bn.listen(+Pn,Tn,(async function(){const{address:e,family:t,port:r}=this.address(),s=`//${"IPv4"===t?e:"localhost"}:${r}/`,{name:n,flags:o}=(({name:e,workerful:{name:t,browser:r,window:s}},n,o)=>{const i=r?.name||"chrome",c=(r?.flags||[]).slice(0),l=t||e||"unknown";if("chrome"!==i)throw new Error(`Unsupported browser ${i}`);return c.push(`--window-position=${(s?.position||[0,0]).join(",")}`,`--window-size=${(s?.size||[640,400]).join(",")}`,`--window-name=${l}`,`--user-data-dir=${a(g(),".workerful",l.replace(/\s/g,"-"))}`,"--ignore-profile-directory-if-not-exists","--enable-webgpu-developer-features","--ignore-gpu-blocklist","--disable-extensions","--allow-running-insecure-content","--allow-files-access-from-files","--enable-features=SharedArrayBuffer","--disable-first-run-ui","--new-window","--minimal","--content-shell-hide-toolbar","--incognito","--no-first-run","--no-default-browser-check","--disable-default-apps","--disable-cache","--no-default-browser-check","--disable-popup-blocking"),o?c.push("--kiosk",n):c.push(`--app=${n}`),{name:i,flags:c}})(Qs,`http:${s}`,se(jn));Cn=`ws:${s}`;const i=await((e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected a valid `name`");const{arguments:r=[]}=t??{};if(null!=r&&!Array.isArray(r))throw new TypeError("Expected `appArguments` as Array type");return Q({...t,app:{name:e,arguments:r}})})(re[n],{arguments:o}),{pid:c}=i;process.on("SIGINT",(()=>{setTimeout((()=>process.exit(0))),process.kill(c)})),i.on("close",(()=>{setTimeout((async()=>{await In,process.exit(0)}),250)})),process.env.DEBUG&&(console.debug("[1mworkerful app launcher[0m"),console.debug(`chromium ${o.join(" ")}`),console.debug("[1mworkerful serializer[0m"),console.debug(Nn),console.debug("[1mworkerful server[0m"),console.debug(`http://${s}`))}));
